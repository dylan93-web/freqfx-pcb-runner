<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>FREQ-2: Dezert Runner</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#1a1020;display:flex;align-items:center;justify-content:center;font-family:monospace;touch-action:none;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}
#wrap{position:relative;display:flex;align-items:center;justify-content:center}
canvas{image-rendering:pixelated;image-rendering:crisp-edges;display:block}
.mobile-btn{display:none;position:fixed;z-index:10;touch-action:manipulation;border:none;font:bold 18px monospace;border-radius:12px;opacity:0.9}
/* Fullscreen prompt for mobile */
#fullscreen-prompt{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(180deg,#1a1020 0%,#2a1530 50%,#1a1020 100%);z-index:150;flex-direction:column;align-items:center;justify-content:center;color:#ffcc88;font-family:'Press Start 2P',monospace;text-align:center;padding:20px}
#fullscreen-prompt.visible{display:flex}
.fs-title{font-size:32px;color:#ffcc88;letter-spacing:4px;text-shadow:0 0 20px rgba(255,200,160,0.5);margin-bottom:8px}
.fs-subtitle{font-size:14px;color:#aa8877;letter-spacing:3px;margin-bottom:30px}
#btn-fullscreen{padding:20px 40px;font:bold 18px 'Press Start 2P',monospace;color:#ffcc88;background:rgba(255,200,180,0.1);border:2px solid rgba(255,200,180,0.4);border-radius:8px;cursor:pointer;animation:pulse-btn 2s ease-in-out infinite}
#btn-fullscreen:active{background:rgba(255,200,180,0.3);transform:scale(0.98)}
.fs-hint{font-size:10px;color:#665544;margin-top:20px;letter-spacing:1px}
@keyframes pulse-btn{0%,100%{box-shadow:0 0 10px rgba(255,200,160,0.3)}50%{box-shadow:0 0 25px rgba(255,200,160,0.6)}}
/* Rotate prompt for portrait mode on mobile */
#rotate-prompt{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(10,5,15,0.95);z-index:100;flex-direction:column;align-items:center;justify-content:center;color:#ffcc88;font:bold 18px monospace;text-align:center;padding:20px}
#rotate-prompt .icon{font-size:48px;margin-bottom:16px;animation:rotate-hint 1.5s ease-in-out infinite}
@keyframes rotate-hint{0%,100%{transform:rotate(0deg)}50%{transform:rotate(90deg)}}
/* Mobile landscape styles */
@media (pointer: coarse) {
  .hud-heart{width:24px!important;height:20px!important}
  #hud-hearts{gap:4px!important}
  #hud-dash{position:fixed!important;bottom:10px!important;top:auto!important;left:50%!important;right:auto!important;transform:translateX(-50%)!important;gap:6px!important;flex-direction:row!important;align-items:center!important;width:auto!important}
  #hud-dash-label{font-size:10px!important;letter-spacing:1px!important}
  .dash-pip{width:20px!important;height:10px!important;border-width:2px!important}
  #hud-dash-charges{gap:4px!important}
  #hud-center{font-size:14px!important}
  #hud-hi{font-size:10px!important}
  #hud-level{font-size:10px!important}
  #boss-hud{top:36px!important}
  #boss-name{font-size:12px!important}
  #boss-health-bar{width:200px!important;height:16px!important}
  #hud-power{position:fixed!important;top:36px!important;right:12px!important;bottom:auto!important;left:auto!important;transform:none!important;flex-direction:column!important;align-items:center!important;width:auto!important}
  #hud-power-label{font-size:8px!important}
  #hud-power-bar{width:40px!important;height:8px!important}
  #dom-hud{padding:4px 8px!important}
}
/* Pause button for mobile */
#mobile-pause{display:none;position:fixed;top:28px;left:50%;transform:translateX(-50%);width:40px;height:24px;z-index:10;touch-action:manipulation;border:1px solid rgba(255,200,180,0.3);border-radius:4px;background:rgba(0,0,0,0.5);color:#ffcc99;font:bold 10px monospace;opacity:0.7}
/* Joystick styles */
#joystick-zone{display:none;position:fixed;left:10px;bottom:10px;width:130px;height:130px;z-index:10;touch-action:none}
#joystick-base{position:absolute;width:120px;height:120px;border-radius:50%;background:rgba(255,200,180,0.15);border:3px solid rgba(255,200,180,0.3)}
#joystick-knob{position:absolute;width:50px;height:50px;border-radius:50%;background:rgba(255,200,180,0.5);border:2px solid rgba(255,200,180,0.7);left:35px;top:35px;transition:none}
#overlay{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none;z-index:5}
#overlay.active{pointer-events:auto}
#overlay *{pointer-events:auto}
.ov-hidden{display:none!important}
.ov-panel{display:flex;flex-direction:column;align-items:center;gap:6px;padding:16px 24px;border-radius:8px;background:rgba(10,5,15,0.88);border:1px solid rgba(255,200,180,0.15);max-width:90%;text-align:center}
.ov-title{font:bold 28px monospace;color:#ffcc88;letter-spacing:4px;text-transform:uppercase;text-shadow:0 0 12px rgba(255,200,160,0.5),0 0 24px rgba(255,150,100,0.25);margin-bottom:2px}
.ov-subtitle{font:bold 16px monospace;color:#aa8877;letter-spacing:3px;text-transform:uppercase}
.ov-brand{font:12px monospace;color:#cc9988;letter-spacing:2px;margin-bottom:8px}
.ov-best{font:11px monospace;color:#887766;letter-spacing:1px;margin-bottom:4px}
.ov-btn{display:block;width:180px;padding:10px 0;margin:3px 0;font:bold 14px monospace;letter-spacing:2px;text-transform:uppercase;border:1px solid rgba(255,200,180,0.3);border-radius:4px;background:rgba(255,200,180,0.08);color:#ffcc88;cursor:pointer;transition:background 0.15s,border-color 0.15s}
.ov-btn:hover,.ov-btn:active{background:rgba(255,200,180,0.2);border-color:rgba(255,200,180,0.6)}
.ov-btn-alt{color:#ffaa88;border-color:rgba(255,170,136,0.3)}
.ov-btn-alt:hover,.ov-btn-alt:active{background:rgba(255,170,136,0.15);border-color:rgba(255,170,136,0.5)}
.ov-heading{font:bold 18px monospace;color:#ffcc88;letter-spacing:3px;text-shadow:0 0 8px rgba(255,200,160,0.4);margin-bottom:6px}
.ov-text{font:12px monospace;color:#bb9988;line-height:1.6;text-align:left;white-space:pre-line;letter-spacing:0.5px}
.ov-text b{color:#ddbb99}
.ov-back{font:11px monospace;color:#887766;letter-spacing:1px;margin-top:10px;cursor:pointer;border:none;background:none;text-decoration:underline;text-underline-offset:3px}
.ov-back:hover{color:#ffcc88}
.ov-go-title{font:bold 24px monospace;color:#ff6666;letter-spacing:4px;text-shadow:0 0 12px rgba(255,80,80,0.5)}
.ov-go-score{font:bold 18px monospace;color:#ffcc88;letter-spacing:2px}
.ov-go-best{font:13px monospace;color:#ffdd88;letter-spacing:1px}
.ov-go-best-dim{font:13px monospace;color:#887766;letter-spacing:1px}
.ov-pause-title{font:bold 22px monospace;color:#ffcc88;letter-spacing:4px;text-shadow:0 0 10px rgba(255,200,160,0.4)}
.ov-pause-hint{font:12px monospace;color:#887766;letter-spacing:1px;margin-top:4px}
.ov-volume-section{display:flex;align-items:center;gap:8px;margin:8px 0}
.ov-volume-label{font:11px monospace;color:#aa9988;letter-spacing:1px}
.ov-slider{width:100px;height:6px;-webkit-appearance:none;appearance:none;background:rgba(255,200,180,0.2);border-radius:3px;outline:none}
.ov-slider::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;background:#ffcc88;border-radius:50%;cursor:pointer}
.ov-slider::-moz-range-thumb{width:14px;height:14px;background:#ffcc88;border-radius:50%;cursor:pointer;border:none}
.ov-mute-btn{background:none;border:1px solid rgba(255,200,180,0.3);border-radius:4px;padding:4px 8px;font-size:14px;cursor:pointer}
.ov-mute-btn:hover{background:rgba(255,200,180,0.1)}
.ov-btn-small{font-size:11px;padding:6px 0;width:140px}
/* Leaderboard styles */
.ov-lb-prompt{font:11px monospace;color:#aa9988;letter-spacing:1px;margin:8px 0 4px}
.ov-name-input{width:140px;padding:8px;font:bold 14px monospace;text-align:center;text-transform:uppercase;background:rgba(255,200,180,0.1);border:1px solid rgba(255,200,180,0.3);border-radius:4px;color:#ffcc88;outline:none;margin-bottom:6px}
.ov-name-input::placeholder{color:#665544}
.ov-name-input:focus{border-color:rgba(255,200,180,0.6);background:rgba(255,200,180,0.15)}
.ov-lb-status{font:11px monospace;color:#88cc88;letter-spacing:1px;min-height:16px;margin:4px 0}
.ov-lb-status.error{color:#ff8888}
#leaderboard-submit{display:flex;flex-direction:column;align-items:center;margin:6px 0}
#leaderboard-submit.ov-hidden{display:none}
/* Leaderboard display screen */
.ov-panel-lb{max-height:80vh;width:280px}
.lb-header{display:flex;padding:6px 4px;border-bottom:1px solid rgba(255,200,180,0.3);font:bold 10px monospace;color:#aa9988;letter-spacing:1px}
.lb-scores{max-height:200px;overflow-y:auto;margin:4px 0}
.lb-scores::-webkit-scrollbar{width:6px}
.lb-scores::-webkit-scrollbar-track{background:rgba(0,0,0,0.3)}
.lb-scores::-webkit-scrollbar-thumb{background:rgba(255,200,180,0.3);border-radius:3px}
.lb-row{display:flex;padding:5px 4px;border-bottom:1px solid rgba(255,200,180,0.08);font:11px monospace;color:#ccbb99}
.lb-row:hover{background:rgba(255,200,180,0.05)}
.lb-rank{width:28px;text-align:center}
.lb-name{flex:1;overflow:hidden;text-overflow:ellipsis}
.lb-score{width:60px;text-align:right;color:#88ff88}
.lb-level{width:32px;text-align:center;color:#88ccff}
.lb-top1{color:#ffd700;text-shadow:0 0 6px rgba(255,215,0,0.4)}
.lb-top2{color:#c0c0c0}
.lb-top3{color:#cd7f32}
.lb-loading,.lb-error{text-align:center;padding:20px;font:11px monospace;color:#887766}
.lb-error{color:#ff8888}
.lb-empty{text-align:center;padding:20px;font:11px monospace;color:#887766}
/* DOM HUD - SNES pixel font style (2x size) */
#dom-hud{position:absolute;top:0;left:0;width:100%;height:auto;display:none;z-index:4;pointer-events:none;padding:8px 12px;font-family:'Press Start 2P',monospace}
#dom-hud.visible{display:flex;justify-content:space-between;align-items:flex-start}
#hud-left{display:flex;flex-direction:column;gap:6px}
#hud-hearts{display:flex;gap:10px;align-items:center}
.hud-heart{width:40px;height:36px;position:relative;image-rendering:pixelated}
.hud-heart.empty{opacity:0.25}
#hud-center{color:#ffdd88;font-size:28px;letter-spacing:2px;text-shadow:3px 3px 0 #000,4px 4px 0 rgba(0,0,0,0.5)}
#hud-right{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
#hud-hi{color:#88ff88;font-size:20px;letter-spacing:2px;text-shadow:3px 3px 0 #000}
#hud-level{color:#88ccff;font-size:20px;letter-spacing:2px;text-shadow:3px 3px 0 #000}
/* Dash charges ‚Äî SNES pixel style (2x size) */
#hud-dash{position:absolute;bottom:24px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:20px;z-index:4;pointer-events:none}
#hud-dash-label{font-family:'Press Start 2P',monospace;font-size:24px;letter-spacing:3px;color:#44ffcc;text-shadow:3px 3px 0 #000}
#hud-dash-charges{display:flex;gap:12px;align-items:center}
.dash-pip{width:48px;height:24px;border:3px solid #44ffcc;background:rgba(0,0,0,0.6);image-rendering:pixelated}
.dash-pip.full{background:#44ffcc;box-shadow:0 0 12px rgba(68,255,204,0.5)}
.dash-pip.empty{background:rgba(20,20,20,0.8);border-color:rgba(68,255,204,0.3)}
#hud-safe{position:absolute;top:50px;left:50%;transform:translateX(-50%);font-family:'Press Start 2P',monospace;font-size:16px;color:#88ddcc;letter-spacing:3px;text-shadow:3px 3px 0 #000;display:none;z-index:4;pointer-events:none}
#boss-hud{position:absolute;top:50px;left:50%;transform:translateX(-50%);display:none;flex-direction:column;align-items:center;gap:8px;z-index:4;pointer-events:none}
#boss-hud.visible{display:flex}
#boss-name{font-family:'Press Start 2P',monospace;font-size:24px;color:#ff6644;letter-spacing:3px;text-shadow:3px 3px 0 #000}
#boss-health-bar{width:400px;height:32px;background:#220000;border:4px solid #ff4422;overflow:hidden;image-rendering:pixelated}
#boss-health-fill{width:100%;height:100%;background:linear-gradient(180deg,#ff6644 0%,#cc2211 50%,#ff4422 100%);transition:width 0.15s steps(10)}
#hud-power{position:absolute;bottom:60px;left:50%;transform:translateX(-50%);display:none;align-items:center;gap:10px;z-index:4;pointer-events:none}
#hud-power.visible{display:flex}
#hud-power-label{font-family:'Press Start 2P',monospace;font-size:16px;letter-spacing:2px;color:#44aaff;text-shadow:3px 3px 0 #000}
#hud-power-bar{width:100px;height:16px;background:#001122;border:3px solid #44aaff;overflow:hidden}
#hud-power-fill{width:100%;height:100%;background:#44aaff;transition:width 0.1s steps(10)}
</style>
</head>
<body>
<div id="fullscreen-prompt">
  <div class="fs-title">FREQ-2</div>
  <div class="fs-subtitle">Dezert Runner</div>
  <button id="btn-fullscreen">PLAY FULLSCREEN</button>
  <div class="fs-hint">Tap to start</div>
</div>
<div id="rotate-prompt"><div class="icon">üì±</div>Rotate your phone to<br>landscape mode to play</div>
<div id="joystick-zone"><div id="joystick-base"><div id="joystick-knob"></div></div></div>
<button id="mobile-pause">| |</button>
<div id="wrap">
  <canvas id="c"></canvas>
  <div id="dom-hud">
    <div id="hud-left">
      <div id="hud-hearts"></div>
    </div>
    <div id="hud-center">DIST: 0</div>
    <div id="hud-right">
      <div id="hud-hi">HI: 0</div>
      <div id="hud-level">LVL 1</div>
    </div>
  </div>
  <div id="hud-dash">
    <span id="hud-dash-label">DASH</span>
    <div id="hud-dash-charges"></div>
  </div>
  <div id="hud-power">
    <span id="hud-power-label">POWER</span>
    <div id="hud-power-bar"><div id="hud-power-fill"></div></div>
  </div>
  <div id="hud-safe">SAFE</div>
  <div id="boss-hud">
    <div id="boss-name">CAVE WORM</div>
    <div id="boss-health-bar"><div id="boss-health-fill"></div></div>
  </div>
  <div id="overlay" class="active">
    <div id="scr-title" class="ov-panel">
      <div class="ov-title">FREQ-2</div>
      <div class="ov-subtitle">Dezert Runner</div>
      <div class="ov-brand">Dezert Audio</div>
      <div class="ov-best" id="title-best">BEST: 0</div>
      <button class="ov-btn" id="btn-start">START</button>
      <button class="ov-btn" id="btn-howto">HOW TO PLAY</button>
      <button class="ov-btn" id="btn-title-lb">LEADERBOARD</button>
    </div>
    <div id="scr-howto" class="ov-panel ov-hidden">
      <div class="ov-heading">HOW TO PLAY</div>
      <div class="ov-text" id="howto-text"></div>
      <button class="ov-back" id="btn-back">BACK</button>
    </div>
    <div id="scr-paused" class="ov-panel ov-hidden">
      <div class="ov-pause-title">PAUSED</div>
      <button class="ov-btn" id="btn-resume">RESUME</button>
      <div class="ov-volume-section">
        <span class="ov-volume-label">MUSIC</span>
        <input type="range" id="vol-slider" min="0" max="100" value="50" class="ov-slider">
        <button class="ov-mute-btn" id="btn-mute">üîä</button>
      </div>
      <button class="ov-btn ov-btn-small" id="btn-pause-howto">HOW TO PLAY</button>
      <button class="ov-btn ov-btn-small" id="btn-pause-lb">LEADERBOARD</button>
      <div class="ov-pause-hint" id="pause-hint"></div>
    </div>
    <div id="scr-pause-howto" class="ov-panel ov-hidden">
      <div class="ov-heading">HOW TO PLAY</div>
      <div class="ov-text" id="pause-howto-text"></div>
      <button class="ov-back" id="btn-pause-back">BACK TO PAUSE</button>
    </div>
    <div id="scr-leaderboard" class="ov-panel ov-panel-lb ov-hidden">
      <div class="ov-heading">üèÜ LEADERBOARD</div>
      <div class="lb-header">
        <span class="lb-rank">#</span>
        <span class="lb-name">NAME</span>
        <span class="lb-score">SCORE</span>
        <span class="lb-level">LVL</span>
      </div>
      <div id="lb-scores" class="lb-scores">
        <div class="lb-loading">Loading...</div>
      </div>
      <button class="ov-back" id="btn-lb-back">BACK</button>
    </div>
    <div id="scr-gameover" class="ov-panel ov-hidden">
      <div class="ov-go-title">GAME OVER</div>
      <div class="ov-go-score" id="go-score">SCORE: 0</div>
      <div id="go-best"></div>
      <div id="leaderboard-submit" class="ov-hidden">
        <div class="ov-lb-prompt">Enter name for leaderboard:</div>
        <input type="text" id="lb-name-input" maxlength="12" placeholder="YOUR NAME" class="ov-name-input">
        <button class="ov-btn ov-btn-small" id="btn-submit-score">SUBMIT SCORE</button>
      </div>
      <div id="leaderboard-status" class="ov-lb-status"></div>
      <button class="ov-btn" id="btn-retry">RETRY</button>
      <button class="ov-btn ov-btn-alt ov-btn-small" id="btn-leaderboard">VIEW LEADERBOARD</button>
    </div>
  </div>
</div>
<script>
(function(){
"use strict";

var W=240,H=160;
var GROUND_Y=130;
var GRAVITY=600;
var JUMP_VEL=-220;
var MOVE_ACCEL=400;
var MOVE_DECEL=500;
var MAX_RUN=120;
var COYOTE_MS=100;
var JUMP_BUFFER_MS=100;
var DASH_SPEED=220;
var DASH_DURATION=0.35;
var MAX_LIVES=3;
var LIVES_CAP=6;
var INVULN_TIME=1.5;
var SAFE_START=2.0;
var SPAWN_BASE=2.6;
var SPAWN_MIN=0.8;
var SPAWN_RAMP=0.003;
var PLAYER_W=12,PLAYER_H=16;
var HIT_SHRINK=3;
var CAM_LEFT_MARGIN=70;
var CAM_RIGHT_MARGIN=170;
var DIST_PER_POINT=10;

var MAX_JUMP_HEIGHT=38;

// Level system
var LEVEL_2_THRESHOLD=500;
var LEVEL_3_THRESHOLD=1000;
var LEVEL_TRANSITION_TIME=1.2;
var LEVEL_3_TRANSITION_TIME=2.0; // Long visible pit fall
var SPAWN_PAUSE_TIME=0.8;
var PIT_FALL_SPEED=400;

// Ship enemy constants
var SHIP_SPEED=50;
var SHIP_SINE_AMP=16;
var SHIP_SINE_FREQ=2.2;
var SHIP_FIRE_INTERVAL=2.5;
var SHIP_FIRE_TELEGRAPH=0.4;
var PROJ_SPEED=40;
var MAX_PROJECTILES=6;

// Stomp kill constants
var STOMP_SHIP_SCORE=5;
var STOMP_WORM_SCORE=10;
var STOMP_FLIER_SCORE=5;
var STOMP_DROID_SCORE=5;
var STOMP_BOUNCE_VEL=JUMP_VEL*0.65;
var STOMP_COOLDOWN=0.12;

// Powercell
var POWER_DURATION=2.2;
var POWER_SPEED_MULT=1.5;
var POWER_MIN_DIST=300;

// Heart spawn control
var HEART_MIN_DIST=550;

// Invincibility power-up
var INVINC_MIN_DIST=500;
var INVINC_DURATION=7;
var INVINC_SCALE=1.4;

// Sandworm
var WORM_TELEGRAPH=0.6;
var WORM_SPEED=90;
var WORM_LENGTH=24;
var WORM_MIN_INTERVAL=12;
var WORM_MAX_INTERVAL=25;

// Flier (Level 2) ‚Äî flying creature that drops objects
var FLIER_SPEED=35;
var FLIER_SINE_AMP=12;
var FLIER_SINE_FREQ=1.8;
var FLIER_DROP_INTERVAL=3.5;
var FLIER_DROP_TELEGRAPH=0.3;
var MAX_DROPS=2;
var DROP_GRAVITY=200;

// Droid (Level 2) ‚Äî ground enemy that shoots lasers
var DROID_SPEED=20;
var DROID_PATROL_DIST=40;
var DROID_FIRE_INTERVAL=2.8;
var DROID_FIRE_TELEGRAPH=0.25;
var LASER_SPEED=70;
var MAX_LASERS=2;

// Level 3 droids - VERY aggressive
var DROID_L3_FIRE_INTERVAL=1.0;  // Faster firing (was 1.8)
var MAX_LASERS_L3=6;             // More lasers on screen (was 4)

// Level 3 enemies - harder
// Big Worm ‚Äî larger sandworm that shoots daggers
var BIGWORM_SPEED=85;            // Faster (was 70)
var BIGWORM_LENGTH=36;
var BIGWORM_FIRE_INTERVAL=1.5;   // Faster firing (was 2.0)
var BIGWORM_FIRE_TELEGRAPH=0.25;
var DAGGER_SPEED=110;            // Faster daggers (was 90)
var MAX_DAGGERS=6;               // More daggers (was 4)
var STOMP_BIGWORM_SCORE=15;

// Spider ‚Äî ceiling crawler that drops toxic goo (harder in L3)
var SPIDER_SPEED=40;             // Faster (was 30)
var SPIDER_DROP_INTERVAL=1.8;    // Faster goo drops (was 2.5)
var SPIDER_DROP_TELEGRAPH=0.15;
var GOO_GRAVITY=220;             // Faster falling (was 180)
var MAX_GOO=5;                   // More goo (was 3)
var STOMP_SPIDER_SCORE=8;

// === BOSS: Giant Cave Worm ===
var BOSS_SPAWN_THRESHOLD=1000;
var BOSS_MAX_HEALTH=5;
var BOSS_EMERGE_TIME=0.8;
var BOSS_IDLE_TIME=1.5;
var BOSS_IDLE_TIME_P2=0.8;
var BOSS_ATTACK_DURATION=1.2;
var BOSS_HURT_TIME=0.5;
var BOSS_TELEGRAPH_TIME=0.6;
var BOSS_SUBMERGE_TIME=0.5;
var BOSS_DEFEATED_TIME=3.0;
var BOSS_EMERGE_HEIGHT=28; // Lowered so player can stomp with max jump
var BOSS_LUNGE_SPEED=150;
var BOSS_SEGMENTS=12;
var BOSS_HEAD_HITBOX_W=20;
var BOSS_HEAD_HITBOX_H=15;
var BOSS_DEFEAT_SCORE=500;
var BOSS_PROJ_SPEED=80;
var BOSS_PROJ_GRAVITY=120;
var boss={active:false,health:0,x:0,y:0,state:"inactive",timer:0,attackTimer:0,hurtTimer:0,phase:1,
  emergeX:0,emergeY:GROUND_Y,facing:-1,telegraphing:false,currentAttack:"",lungeVx:0,lungeTarget:0,
  spitCount:0,tremoring:false,defeated:false,defeatTimer:0,flashTimer:0,segmentOffsets:[]};
var bossProjectiles=[];
var bossSpawned=false;
var bossHud,bossHealthFill;

// === PLAYER LASER (Boss fight only) ===
var playerLasers=[];
var PLAYER_LASER_SPEED=250;
var PLAYER_LASER_COOLDOWN=0.35;
var playerLaserCooldown=0;

// === LEADERBOARD ===
var LEADERBOARD_API="https://www.dezertaudio.com/_functions";
var LEADERBOARD_PAGE="https://www.dezertaudio.com/dezert-runner";
var leaderboardCache=null;
var scoreSubmitted=false;
var BANNED_WORDS=["fuck","shit","ass","bitch","cunt","dick","cock","pussy","fag","faggot","nigger","nigga","nig","retard","rape","nazi","hitler","kkk","kike","spic","chink","gook","wetback","beaner","tranny","whore","slut","penis","vagina","anus","bastard","damn","piss","twat","wanker","douche","hoe","homo","queer","dyke","coon","cracker","honky","jap","paki","towelhead","camel jockey","sandnigger"];
function isNameBanned(name){
  var lower=name.toLowerCase().replace(/[^a-z]/g,"");
  for(var i=0;i<BANNED_WORDS.length;i++){
    if(lower.indexOf(BANNED_WORDS[i])!==-1) return true;
  }
  return false;
}

// === AUDIO SYSTEM (SNES-style procedural SFX) ===
var audioCtx=null;
var audioInitialized=false;
var sfxVolume=0.4;
var musicVolume=0.5;
var audioMuted=false;
var bgMusic=null;
var level1Music=null;
var level2Music=null;
var level3Music=null;
var currentMusicLevel=0;

function initAudio(){
  if(audioInitialized) return;
  try{
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    audioInitialized=true;
    // Load level music
    level1Music=new Audio("audio/level1.wav");
    level1Music.loop=true;
    level1Music.volume=musicVolume;
    level2Music=new Audio("audio/level2.wav");
    level2Music.loop=true;
    level2Music.volume=musicVolume;
    level3Music=new Audio("audio/level3.wav");
    level3Music.loop=true;
    level3Music.volume=musicVolume;
  }catch(e){console.log("Audio not supported");}
}

function playLevelMusic(lvl){
  if(audioMuted) return;
  stopLevelMusic();
  if(lvl===1&&level1Music){
    level1Music.currentTime=0;
    level1Music.play().catch(function(){});
    currentMusicLevel=1;
  } else if(lvl===2&&level2Music){
    level2Music.currentTime=0;
    level2Music.play().catch(function(){});
    currentMusicLevel=2;
  } else if(lvl===3&&level3Music){
    level3Music.currentTime=0;
    level3Music.play().catch(function(){});
    currentMusicLevel=3;
  }
}

function stopLevelMusic(){
  if(level1Music){level1Music.pause();level1Music.currentTime=0;}
  if(level2Music){level2Music.pause();level2Music.currentTime=0;}
  if(level3Music){level3Music.pause();level3Music.currentTime=0;}
  currentMusicLevel=0;
}

// SNES-style sound: richer than 8-bit, uses multiple oscillators and filters
function playSfx(type){
  if(!audioCtx||audioMuted) return;
  var now=audioCtx.currentTime;
  var osc,osc2,gain,filter;

  if(type==="jump"){
    // Rising tone with harmonics
    osc=audioCtx.createOscillator();osc2=audioCtx.createOscillator();
    gain=audioCtx.createGain();
    osc.type="square";osc2.type="triangle";
    osc.frequency.setValueAtTime(180,now);
    osc.frequency.exponentialRampToValueAtTime(420,now+0.08);
    osc.frequency.exponentialRampToValueAtTime(380,now+0.12);
    osc2.frequency.setValueAtTime(360,now);
    osc2.frequency.exponentialRampToValueAtTime(840,now+0.08);
    gain.gain.setValueAtTime(sfxVolume*0.35,now);
    gain.gain.exponentialRampToValueAtTime(0.001,now+0.15);
    osc.connect(gain);osc2.connect(gain);gain.connect(audioCtx.destination);
    osc.start(now);osc2.start(now);osc.stop(now+0.15);osc2.stop(now+0.15);
  }
  else if(type==="land"){
    // Soft thud with low freq
    osc=audioCtx.createOscillator();
    gain=audioCtx.createGain();
    filter=audioCtx.createBiquadFilter();
    osc.type="triangle";
    osc.frequency.setValueAtTime(120,now);
    osc.frequency.exponentialRampToValueAtTime(50,now+0.08);
    filter.type="lowpass";filter.frequency.value=200;
    gain.gain.setValueAtTime(sfxVolume*0.3,now);
    gain.gain.exponentialRampToValueAtTime(0.001,now+0.1);
    osc.connect(filter);filter.connect(gain);gain.connect(audioCtx.destination);
    osc.start(now);osc.stop(now+0.1);
  }
  else if(type==="dash"){
    // Whoosh with noise-like quality
    osc=audioCtx.createOscillator();osc2=audioCtx.createOscillator();
    gain=audioCtx.createGain();
    filter=audioCtx.createBiquadFilter();
    osc.type="sawtooth";osc2.type="square";
    osc.frequency.setValueAtTime(300,now);
    osc.frequency.exponentialRampToValueAtTime(150,now+0.2);
    osc2.frequency.setValueAtTime(450,now);
    osc2.frequency.exponentialRampToValueAtTime(100,now+0.25);
    filter.type="bandpass";filter.frequency.value=400;filter.Q.value=2;
    gain.gain.setValueAtTime(sfxVolume*0.25,now);
    gain.gain.setValueAtTime(sfxVolume*0.3,now+0.05);
    gain.gain.exponentialRampToValueAtTime(0.001,now+0.25);
    osc.connect(filter);osc2.connect(filter);filter.connect(gain);gain.connect(audioCtx.destination);
    osc.start(now);osc2.start(now);osc.stop(now+0.25);osc2.stop(now+0.25);
  }
  else if(type==="playerLaser"){
    // Player blaster shot - punchy zap
    osc=audioCtx.createOscillator();osc2=audioCtx.createOscillator();
    gain=audioCtx.createGain();
    osc.type="square";osc2.type="sawtooth";
    osc.frequency.setValueAtTime(600,now);
    osc.frequency.exponentialRampToValueAtTime(200,now+0.15);
    osc2.frequency.setValueAtTime(800,now);
    osc2.frequency.exponentialRampToValueAtTime(150,now+0.1);
    gain.gain.setValueAtTime(sfxVolume*0.3,now);
    gain.gain.exponentialRampToValueAtTime(0.001,now+0.18);
    osc.connect(gain);osc2.connect(gain);gain.connect(audioCtx.destination);
    osc.start(now);osc2.start(now);osc.stop(now+0.18);osc2.stop(now+0.18);
  }
  else if(type==="shoot"){
    // Laser pew
    osc=audioCtx.createOscillator();
    gain=audioCtx.createGain();
    osc.type="square";
    osc.frequency.setValueAtTime(880,now);
    osc.frequency.exponentialRampToValueAtTime(220,now+0.1);
    gain.gain.setValueAtTime(sfxVolume*0.2,now);
    gain.gain.exponentialRampToValueAtTime(0.001,now+0.12);
    osc.connect(gain);gain.connect(audioCtx.destination);
    osc.start(now);osc.stop(now+0.12);
  }
  else if(type==="enemyHit"){
    // Satisfying crunch/explosion
    osc=audioCtx.createOscillator();osc2=audioCtx.createOscillator();
    gain=audioCtx.createGain();
    filter=audioCtx.createBiquadFilter();
    osc.type="square";osc2.type="sawtooth";
    osc.frequency.setValueAtTime(200,now);
    osc.frequency.exponentialRampToValueAtTime(60,now+0.15);
    osc2.frequency.setValueAtTime(300,now);
    osc2.frequency.exponentialRampToValueAtTime(40,now+0.2);
    filter.type="lowpass";filter.frequency.setValueAtTime(800,now);
    filter.frequency.exponentialRampToValueAtTime(100,now+0.2);
    gain.gain.setValueAtTime(sfxVolume*0.4,now);
    gain.gain.exponentialRampToValueAtTime(0.001,now+0.22);
    osc.connect(filter);osc2.connect(filter);filter.connect(gain);gain.connect(audioCtx.destination);
    osc.start(now);osc2.start(now);osc.stop(now+0.22);osc2.stop(now+0.22);
  }
  else if(type==="playerHit"){
    // Harsh warning tone
    osc=audioCtx.createOscillator();osc2=audioCtx.createOscillator();
    gain=audioCtx.createGain();
    osc.type="square";osc2.type="square";
    osc.frequency.setValueAtTime(200,now);
    osc.frequency.setValueAtTime(150,now+0.08);
    osc.frequency.setValueAtTime(100,now+0.16);
    osc2.frequency.setValueAtTime(205,now);
    osc2.frequency.setValueAtTime(155,now+0.08);
    gain.gain.setValueAtTime(sfxVolume*0.35,now);
    gain.gain.exponentialRampToValueAtTime(0.001,now+0.25);
    osc.connect(gain);osc2.connect(gain);gain.connect(audioCtx.destination);
    osc.start(now);osc2.start(now);osc.stop(now+0.25);osc2.stop(now+0.25);
  }
  else if(type==="pickupHeart"){
    // Warm healing chime
    osc=audioCtx.createOscillator();osc2=audioCtx.createOscillator();
    gain=audioCtx.createGain();
    osc.type="sine";osc2.type="triangle";
    osc.frequency.setValueAtTime(523,now);osc.frequency.setValueAtTime(659,now+0.08);osc.frequency.setValueAtTime(784,now+0.16);
    osc2.frequency.setValueAtTime(262,now);osc2.frequency.setValueAtTime(330,now+0.08);
    gain.gain.setValueAtTime(sfxVolume*0.3,now);
    gain.gain.exponentialRampToValueAtTime(0.001,now+0.3);
    osc.connect(gain);osc2.connect(gain);gain.connect(audioCtx.destination);
    osc.start(now);osc2.start(now);osc.stop(now+0.3);osc2.stop(now+0.3);
  }
  else if(type==="pickupPower"){
    // Energizing power-up
    osc=audioCtx.createOscillator();osc2=audioCtx.createOscillator();
    gain=audioCtx.createGain();
    osc.type="square";osc2.type="sawtooth";
    osc.frequency.setValueAtTime(220,now);
    osc.frequency.exponentialRampToValueAtTime(880,now+0.15);
    osc2.frequency.setValueAtTime(440,now);
    osc2.frequency.exponentialRampToValueAtTime(1760,now+0.15);
    gain.gain.setValueAtTime(sfxVolume*0.25,now);
    gain.gain.setValueAtTime(sfxVolume*0.35,now+0.1);
    gain.gain.exponentialRampToValueAtTime(0.001,now+0.25);
    osc.connect(gain);osc2.connect(gain);gain.connect(audioCtx.destination);
    osc.start(now);osc2.start(now);osc.stop(now+0.25);osc2.stop(now+0.25);
  }
  else if(type==="pickupInvinc"){
    // Triumphant fanfare arpeggio
    osc=audioCtx.createOscillator();
    gain=audioCtx.createGain();
    osc.type="square";
    osc.frequency.setValueAtTime(392,now);
    osc.frequency.setValueAtTime(523,now+0.07);
    osc.frequency.setValueAtTime(659,now+0.14);
    osc.frequency.setValueAtTime(784,now+0.21);
    osc.frequency.setValueAtTime(1047,now+0.28);
    gain.gain.setValueAtTime(sfxVolume*0.3,now);
    gain.gain.exponentialRampToValueAtTime(0.001,now+0.45);
    osc.connect(gain);gain.connect(audioCtx.destination);
    osc.start(now);osc.stop(now+0.45);
  }
  else if(type==="levelUp"){
    // Epic level transition fanfare
    osc=audioCtx.createOscillator();osc2=audioCtx.createOscillator();
    gain=audioCtx.createGain();
    osc.type="square";osc2.type="triangle";
    osc.frequency.setValueAtTime(262,now);
    osc.frequency.setValueAtTime(330,now+0.15);
    osc.frequency.setValueAtTime(392,now+0.3);
    osc.frequency.setValueAtTime(523,now+0.45);
    osc2.frequency.setValueAtTime(523,now);
    osc2.frequency.setValueAtTime(659,now+0.15);
    osc2.frequency.setValueAtTime(784,now+0.3);
    osc2.frequency.setValueAtTime(1047,now+0.45);
    gain.gain.setValueAtTime(sfxVolume*0.35,now);
    gain.gain.setValueAtTime(sfxVolume*0.4,now+0.3);
    gain.gain.exponentialRampToValueAtTime(0.001,now+0.7);
    osc.connect(gain);osc2.connect(gain);gain.connect(audioCtx.destination);
    osc.start(now);osc2.start(now);osc.stop(now+0.7);osc2.stop(now+0.7);
  }
  else if(type==="gameOver"){
    // Sad descending tones
    osc=audioCtx.createOscillator();osc2=audioCtx.createOscillator();
    gain=audioCtx.createGain();
    osc.type="square";osc2.type="triangle";
    osc.frequency.setValueAtTime(440,now);
    osc.frequency.setValueAtTime(392,now+0.2);
    osc.frequency.setValueAtTime(330,now+0.4);
    osc.frequency.setValueAtTime(262,now+0.6);
    osc2.frequency.setValueAtTime(220,now);
    osc2.frequency.setValueAtTime(196,now+0.2);
    osc2.frequency.setValueAtTime(165,now+0.4);
    osc2.frequency.setValueAtTime(131,now+0.6);
    gain.gain.setValueAtTime(sfxVolume*0.35,now);
    gain.gain.exponentialRampToValueAtTime(0.001,now+0.9);
    osc.connect(gain);osc2.connect(gain);gain.connect(audioCtx.destination);
    osc.start(now);osc2.start(now);osc.stop(now+0.9);osc2.stop(now+0.9);
  }
  else if(type==="bossRoar"){
    // Deep rumbling roar
    osc=audioCtx.createOscillator();osc2=audioCtx.createOscillator();
    gain=audioCtx.createGain();
    filter=audioCtx.createBiquadFilter();
    osc.type="sawtooth";osc2.type="square";
    osc.frequency.setValueAtTime(60,now);
    osc.frequency.exponentialRampToValueAtTime(40,now+0.5);
    osc2.frequency.setValueAtTime(80,now);
    osc2.frequency.exponentialRampToValueAtTime(50,now+0.4);
    filter.type="lowpass";filter.frequency.value=150;
    gain.gain.setValueAtTime(sfxVolume*0.5,now);
    gain.gain.exponentialRampToValueAtTime(0.001,now+0.6);
    osc.connect(filter);osc2.connect(filter);filter.connect(gain);gain.connect(audioCtx.destination);
    osc.start(now);osc2.start(now);osc.stop(now+0.6);osc2.stop(now+0.6);
  }
  else if(type==="bossHit"){
    // Heavy impact with rumble
    osc=audioCtx.createOscillator();osc2=audioCtx.createOscillator();
    gain=audioCtx.createGain();
    filter=audioCtx.createBiquadFilter();
    osc.type="square";osc2.type="sawtooth";
    osc.frequency.setValueAtTime(150,now);
    osc.frequency.exponentialRampToValueAtTime(50,now+0.2);
    osc2.frequency.setValueAtTime(100,now);
    osc2.frequency.exponentialRampToValueAtTime(30,now+0.25);
    filter.type="lowpass";filter.frequency.setValueAtTime(400,now);
    filter.frequency.exponentialRampToValueAtTime(80,now+0.2);
    gain.gain.setValueAtTime(sfxVolume*0.5,now);
    gain.gain.exponentialRampToValueAtTime(0.001,now+0.3);
    osc.connect(filter);osc2.connect(filter);filter.connect(gain);gain.connect(audioCtx.destination);
    osc.start(now);osc2.start(now);osc.stop(now+0.3);osc2.stop(now+0.3);
  }
  else if(type==="bossDeath"){
    // Epic death sound - long descending rumble
    osc=audioCtx.createOscillator();osc2=audioCtx.createOscillator();
    gain=audioCtx.createGain();
    filter=audioCtx.createBiquadFilter();
    osc.type="sawtooth";osc2.type="square";
    osc.frequency.setValueAtTime(100,now);
    osc.frequency.exponentialRampToValueAtTime(20,now+1.0);
    osc2.frequency.setValueAtTime(150,now);
    osc2.frequency.exponentialRampToValueAtTime(25,now+0.8);
    filter.type="lowpass";filter.frequency.setValueAtTime(300,now);
    filter.frequency.exponentialRampToValueAtTime(50,now+1.0);
    gain.gain.setValueAtTime(sfxVolume*0.6,now);
    gain.gain.setValueAtTime(sfxVolume*0.5,now+0.3);
    gain.gain.exponentialRampToValueAtTime(0.001,now+1.2);
    osc.connect(filter);osc2.connect(filter);filter.connect(gain);gain.connect(audioCtx.destination);
    osc.start(now);osc2.start(now);osc.stop(now+1.2);osc2.stop(now+1.2);
  }
  else if(type==="bossSpawn"){
    // Rumbling emergence
    osc=audioCtx.createOscillator();osc2=audioCtx.createOscillator();
    gain=audioCtx.createGain();
    filter=audioCtx.createBiquadFilter();
    osc.type="sawtooth";osc2.type="triangle";
    osc.frequency.setValueAtTime(30,now);
    osc.frequency.exponentialRampToValueAtTime(80,now+0.4);
    osc.frequency.exponentialRampToValueAtTime(50,now+0.6);
    osc2.frequency.setValueAtTime(50,now);
    osc2.frequency.exponentialRampToValueAtTime(100,now+0.3);
    filter.type="lowpass";filter.frequency.value=200;
    gain.gain.setValueAtTime(sfxVolume*0.4,now);
    gain.gain.exponentialRampToValueAtTime(0.001,now+0.7);
    osc.connect(filter);osc2.connect(filter);filter.connect(gain);gain.connect(audioCtx.destination);
    osc.start(now);osc2.start(now);osc.stop(now+0.7);osc2.stop(now+0.7);
  }
  else if(type==="bossRumble"){
    // Low rumbling for burrowing telegraph
    osc=audioCtx.createOscillator();osc2=audioCtx.createOscillator();
    gain=audioCtx.createGain();
    filter=audioCtx.createBiquadFilter();
    osc.type="triangle";osc2.type="sawtooth";
    osc.frequency.setValueAtTime(25,now);
    osc.frequency.linearRampToValueAtTime(45,now+0.5);
    osc2.frequency.setValueAtTime(35,now);
    osc2.frequency.linearRampToValueAtTime(55,now+0.5);
    filter.type="lowpass";filter.frequency.value=120;
    gain.gain.setValueAtTime(sfxVolume*0.35,now);
    gain.gain.linearRampToValueAtTime(sfxVolume*0.5,now+0.3);
    gain.gain.exponentialRampToValueAtTime(0.001,now+0.6);
    osc.connect(filter);osc2.connect(filter);filter.connect(gain);gain.connect(audioCtx.destination);
    osc.start(now);osc2.start(now);osc.stop(now+0.6);osc2.stop(now+0.6);
  }
  else if(type==="bossHurt"){
    // Heavy thud with screech
    osc=audioCtx.createOscillator();osc2=audioCtx.createOscillator();
    gain=audioCtx.createGain();
    osc.type="square";osc2.type="sawtooth";
    osc.frequency.setValueAtTime(120,now);
    osc.frequency.exponentialRampToValueAtTime(40,now+0.2);
    osc2.frequency.setValueAtTime(300,now);
    osc2.frequency.exponentialRampToValueAtTime(80,now+0.15);
    gain.gain.setValueAtTime(sfxVolume*0.45,now);
    gain.gain.exponentialRampToValueAtTime(0.001,now+0.25);
    osc.connect(gain);osc2.connect(gain);gain.connect(audioCtx.destination);
    osc.start(now);osc2.start(now);osc.stop(now+0.25);osc2.stop(now+0.25);
  }
  else if(type==="bossLunge"){
    // Whooshing lunge
    osc=audioCtx.createOscillator();
    gain=audioCtx.createGain();
    filter=audioCtx.createBiquadFilter();
    osc.type="sawtooth";
    osc.frequency.setValueAtTime(150,now);
    osc.frequency.exponentialRampToValueAtTime(400,now+0.1);
    osc.frequency.exponentialRampToValueAtTime(100,now+0.3);
    filter.type="bandpass";filter.frequency.value=300;filter.Q.value=3;
    gain.gain.setValueAtTime(sfxVolume*0.35,now);
    gain.gain.exponentialRampToValueAtTime(0.001,now+0.35);
    osc.connect(filter);filter.connect(gain);gain.connect(audioCtx.destination);
    osc.start(now);osc.stop(now+0.35);
  }
  else if(type==="bossSpit"){
    // Wet spitting sound
    osc=audioCtx.createOscillator();osc2=audioCtx.createOscillator();
    gain=audioCtx.createGain();
    osc.type="square";osc2.type="triangle";
    osc.frequency.setValueAtTime(200,now);
    osc.frequency.exponentialRampToValueAtTime(80,now+0.1);
    osc2.frequency.setValueAtTime(300,now);
    osc2.frequency.exponentialRampToValueAtTime(100,now+0.08);
    gain.gain.setValueAtTime(sfxVolume*0.25,now);
    gain.gain.exponentialRampToValueAtTime(0.001,now+0.15);
    osc.connect(gain);osc2.connect(gain);gain.connect(audioCtx.destination);
    osc.start(now);osc2.start(now);osc.stop(now+0.15);osc2.stop(now+0.15);
  }
  else if(type==="bossTremor"){
    // Ground shaking rumble
    osc=audioCtx.createOscillator();osc2=audioCtx.createOscillator();
    gain=audioCtx.createGain();
    filter=audioCtx.createBiquadFilter();
    osc.type="triangle";osc2.type="sawtooth";
    osc.frequency.setValueAtTime(40,now);
    osc.frequency.setValueAtTime(50,now+0.2);
    osc.frequency.setValueAtTime(35,now+0.4);
    osc2.frequency.setValueAtTime(60,now);
    osc2.frequency.setValueAtTime(70,now+0.2);
    osc2.frequency.setValueAtTime(45,now+0.4);
    filter.type="lowpass";filter.frequency.value=120;
    gain.gain.setValueAtTime(sfxVolume*0.4,now);
    gain.gain.setValueAtTime(sfxVolume*0.5,now+0.3);
    gain.gain.exponentialRampToValueAtTime(0.001,now+0.6);
    osc.connect(filter);osc2.connect(filter);filter.connect(gain);gain.connect(audioCtx.destination);
    osc.start(now);osc2.start(now);osc.stop(now+0.6);osc2.stop(now+0.6);
  }
  else if(type==="bossPhase"){
    // Angry phase transition
    osc=audioCtx.createOscillator();osc2=audioCtx.createOscillator();
    gain=audioCtx.createGain();
    osc.type="sawtooth";osc2.type="square";
    osc.frequency.setValueAtTime(80,now);
    osc.frequency.exponentialRampToValueAtTime(200,now+0.2);
    osc.frequency.exponentialRampToValueAtTime(60,now+0.4);
    osc2.frequency.setValueAtTime(100,now);
    osc2.frequency.exponentialRampToValueAtTime(250,now+0.2);
    gain.gain.setValueAtTime(sfxVolume*0.45,now);
    gain.gain.exponentialRampToValueAtTime(0.001,now+0.5);
    osc.connect(gain);osc2.connect(gain);gain.connect(audioCtx.destination);
    osc.start(now);osc2.start(now);osc.stop(now+0.5);osc2.stop(now+0.5);
  }
  else if(type==="bossDefeat"){
    // Dying roar
    osc=audioCtx.createOscillator();osc2=audioCtx.createOscillator();
    gain=audioCtx.createGain();
    filter=audioCtx.createBiquadFilter();
    osc.type="sawtooth";osc2.type="square";
    osc.frequency.setValueAtTime(150,now);
    osc.frequency.exponentialRampToValueAtTime(30,now+0.8);
    osc2.frequency.setValueAtTime(200,now);
    osc2.frequency.exponentialRampToValueAtTime(40,now+0.6);
    filter.type="lowpass";filter.frequency.setValueAtTime(400,now);
    filter.frequency.exponentialRampToValueAtTime(60,now+0.8);
    gain.gain.setValueAtTime(sfxVolume*0.55,now);
    gain.gain.exponentialRampToValueAtTime(0.001,now+1.0);
    osc.connect(filter);osc2.connect(filter);filter.connect(gain);gain.connect(audioCtx.destination);
    osc.start(now);osc2.start(now);osc.stop(now+1.0);osc2.stop(now+1.0);
  }
  else if(type==="bossVictory"){
    // Victory fanfare
    osc=audioCtx.createOscillator();osc2=audioCtx.createOscillator();
    gain=audioCtx.createGain();
    osc.type="square";osc2.type="triangle";
    osc.frequency.setValueAtTime(392,now);
    osc.frequency.setValueAtTime(523,now+0.12);
    osc.frequency.setValueAtTime(659,now+0.24);
    osc.frequency.setValueAtTime(784,now+0.36);
    osc2.frequency.setValueAtTime(196,now);
    osc2.frequency.setValueAtTime(262,now+0.12);
    osc2.frequency.setValueAtTime(330,now+0.24);
    osc2.frequency.setValueAtTime(392,now+0.36);
    gain.gain.setValueAtTime(sfxVolume*0.35,now);
    gain.gain.exponentialRampToValueAtTime(0.001,now+0.6);
    osc.connect(gain);osc2.connect(gain);gain.connect(audioCtx.destination);
    osc.start(now);osc2.start(now);osc.stop(now+0.6);osc2.stop(now+0.6);
  }
}

// Music functions (for custom music files)
function loadMusic(url){
  bgMusic=new Audio(url);
  bgMusic.loop=true;
  bgMusic.volume=musicVolume;
}
function playMusic(){if(bgMusic&&!audioMuted){bgMusic.play().catch(function(){});}}
function pauseMusic(){if(bgMusic){bgMusic.pause();}}
function stopMusic(){if(bgMusic){bgMusic.pause();bgMusic.currentTime=0;}}
function setMusicVolume(v){musicVolume=v;if(bgMusic)bgMusic.volume=v;}
function toggleMute(){
  audioMuted=!audioMuted;
  if(bgMusic){if(audioMuted)bgMusic.pause();else bgMusic.play().catch(function(){});}
}

// Pastel dusk palette (Level 1)
// SNES-style robot colors (more vivid metallic blue)
var C_ROBOT_BODY="#4080c8";
var C_ROBOT_DARK="#2860a0";
var C_ROBOT_LIGHT="#68a8e0";
var C_ROBOT_HI="#90c8f0";
var C_ROBOT_OUTLINE="#184878";
var C_ROBOT_ACCENT="#d8a020";
var C_ROBOT_ACCENT_DARK="#a87818";
var C_VISOR="#40e8ff";
var C_VISOR_HI="#80f8ff";
var C_VISOR_DIM="#2090b0";
var C_SHOULDER="#4477bb";
var C_SHIP_BODY="#665566";
var C_SHIP_DARK="#443344";
var C_SHIP_WING="#554455";
var C_SHIP_GLOW="#ff6644";
var C_SHIP_COCKPIT="#ffaa33";
var C_PROJ="#ff4444";
var C_PROJ_GLOW="rgba(255,60,60,0.3)";
var C_HEART_PU="#ff4488";
var C_HEART_PU_GLOW="rgba(255,68,136,0.3)";
var C_POWER="#44aaff";
var C_POWER_MID="#2288dd";
var C_POWER_GLOW="rgba(68,170,255,0.3)";
var C_HEART="#ff4466";
var C_DASH_READY="#44ffcc";

// Level 1 SNES-style desert colors (warm tan/beige like Super Star Wars)
var C_DUNE_FAR="#c9a07a";
var C_DUNE_FAR2="#d8b088";
var C_DUNE_MID="#e0b890";
var C_DUNE_NEAR="#e8c8a0";
var C_GROUND="#e0c098";
var C_GROUND_DARK="#d0a880";
var C_GROUND_DEEPER="#c09870";
var C_GROUND_LINE="#f0d8b8";
var C_SAND_SPEC="#f0d8b0";
var C_SAND_DARK="#c8a070";
var C_TDUNE_BASE="#c09068";
var C_TDUNE_INNER="#d0a078";
var C_TDUNE_HIGHLIGHT="#e8c8a8";
var C_TDUNE_SHADOW="#886048";
var C_TDUNE_CREST="#d8b090";
var C_TDUNE_EDGE="#785840";
// Distant structure colors (warm browns like Super Star Wars)
var C_MTN_FAR="#a08060";
var C_MTN_MID="#b89070";
var C_MTN_NEAR="#907050";

// Level 2 night colors
var C2_DUNE_FAR="#4a4060";
var C2_DUNE_FAR2="#5a5070";
var C2_DUNE_MID="#3a3555";
var C2_DUNE_NEAR="#504868";
var C2_GROUND="#2a2540";
var C2_GROUND_DARK="#201a35";
var C2_GROUND_DEEPER="#18132a";
var C2_GROUND_LINE="#3a3555";
var C2_SAND_SPEC="#4a4565";
var C2_SAND_DARK="#2a2545";
var C2_TDUNE_BASE="#3a3050";
var C2_TDUNE_INNER="#4a4060";
var C2_TDUNE_HIGHLIGHT="#6a6080";
var C2_TDUNE_SHADOW="#201a30";
var C2_TDUNE_CREST="#5a5070";
var C2_TDUNE_EDGE="#181320";

// Flier colors
var C_FLIER_BODY="#556688";
var C_FLIER_WING="#445577";
var C_FLIER_EYE="#ff8844";
var C_DROP="#aa6622";
var C_DROP_GLOW="rgba(170,100,30,0.3)";

// Droid colors (Level 1)
var C_DROID_BODY="#668877";
var C_DROID_DARK="#446655";
var C_DROID_LIGHT="#88aa99";
var C_DROID_EYE="#ff4444";
var C_LASER="#ff2222";
var C_LASER_GLOW="rgba(255,50,50,0.4)";

// Droid colors (Level 2 - red)
var C2_DROID_BODY="#aa4444";
var C2_DROID_DARK="#882222";
var C2_DROID_LIGHT="#cc6666";
var C2_DROID_EYE="#ffff44";

// Invincibility power-up colors
var C_INVINC="#ffcc00";
var C_INVINC_GLOW="rgba(255,200,0,0.4)";

// Level 3 cave colors
var C3_DUNE_FAR="#2a2018";
var C3_DUNE_FAR2="#3a2820";
var C3_DUNE_MID="#251810";
var C3_DUNE_NEAR="#352518";
var C3_GROUND="#1a1208";
var C3_GROUND_DARK="#120c04";
var C3_GROUND_DEEPER="#0a0600";
var C3_GROUND_LINE="#2a1c10";
var C3_SAND_SPEC="#3a2818";
var C3_SAND_DARK="#1a1208";
var C3_TDUNE_BASE="#2a1c10";
var C3_TDUNE_INNER="#3a2818";
var C3_TDUNE_HIGHLIGHT="#4a3828";
var C3_TDUNE_SHADOW="#100a04";
var C3_TDUNE_CREST="#3a2c1c";
var C3_TDUNE_EDGE="#0a0600";

// Level 3 enemy colors
var C_BIGWORM="#6a4030";
var C_BIGWORM_DARK="#4a2820";
var C_BIGWORM_EYE="#ff4422";
var C_DAGGER="#aa6644";
var C_DAGGER_GLOW="rgba(170,100,68,0.4)";
var C_SPIDER="#3a5040";
var C_SPIDER_DARK="#2a3830";
var C_SPIDER_EYE="#88ff44";
var C_GOO="#44ff66";
var C_GOO_GLOW="rgba(68,255,102,0.4)";
var C_TORCH="#ff8844";
var C_TORCH_GLOW="rgba(255,136,68,0.3)";

var canvas=document.getElementById("c");
var ctx=canvas.getContext("2d");
var wrap=document.getElementById("wrap");
var overlay=document.getElementById("overlay");
canvas.width=W;canvas.height=H;

var isMobile="ontouchstart"in window||navigator.maxTouchPoints>0;

// Fullscreen handling for mobile
var fullscreenPrompt=document.getElementById("fullscreen-prompt");
var isEmbedded=window.self!==window.top;

function enterFullscreen(){
  // On mobile in iframe, just open new tab immediately (iOS blocks async popups)
  if(isMobile && isEmbedded){
    window.open("https://game.dezertaudio.com/","_blank");
    fullscreenPrompt.classList.remove("visible");
    return;
  }

  var elem=document.documentElement;
  // Try fullscreen API (may fail in iframes)
  var fsPromise=null;
  if(elem.requestFullscreen){fsPromise=elem.requestFullscreen();}
  else if(elem.webkitRequestFullscreen){elem.webkitRequestFullscreen();fsPromise=Promise.resolve();}
  else if(elem.msRequestFullscreen){elem.msRequestFullscreen();fsPromise=Promise.resolve();}

  if(fsPromise){
    fsPromise.then(function(){
      fullscreenPrompt.classList.remove("visible");
      // Lock to landscape if supported
      if(screen.orientation&&screen.orientation.lock){
        screen.orientation.lock("landscape").catch(function(){});
      }
    }).catch(function(){
      // Fullscreen blocked (iframe on desktop)
      fullscreenPrompt.classList.remove("visible");
    });
  } else {
    fullscreenPrompt.classList.remove("visible");
  }
}

document.getElementById("btn-fullscreen").addEventListener("click",enterFullscreen);

// Show fullscreen prompt on mobile
if(isMobile){
  fullscreenPrompt.classList.add("visible");
}

// Handle fullscreen exit
document.addEventListener("fullscreenchange",function(){
  if(!document.fullscreenElement&&!document.webkitFullscreenElement){
    if(isMobile) fullscreenPrompt.classList.add("visible");
  }
});
document.addEventListener("webkitfullscreenchange",function(){
  if(!document.webkitFullscreenElement){
    if(isMobile) fullscreenPrompt.classList.add("visible");
  }
});

// DOM refs
var scrTitle=document.getElementById("scr-title");
var scrHowto=document.getElementById("scr-howto");
var scrPaused=document.getElementById("scr-paused");
var scrPauseHowto=document.getElementById("scr-pause-howto");
var scrLeaderboard=document.getElementById("scr-leaderboard");
var scrGameover=document.getElementById("scr-gameover");
var titleBest=document.getElementById("title-best");
var howtoText=document.getElementById("howto-text");
var pauseHint=document.getElementById("pause-hint");
var goScore=document.getElementById("go-score");
var goBest=document.getElementById("go-best");
var domHud=document.getElementById("dom-hud");
var hudHearts=document.getElementById("hud-hearts");
var hudCenter=document.getElementById("hud-center");
var hudHi=document.getElementById("hud-hi");
var hudLevel=document.getElementById("hud-level");
var hudDash=document.getElementById("hud-dash");
var hudDashLabel=document.getElementById("hud-dash-label");
var hudDashCharges=document.getElementById("hud-dash-charges");
var hudSafe=document.getElementById("hud-safe");
var hudPower=document.getElementById("hud-power");
var hudPowerLabel=document.getElementById("hud-power-label");
var hudPowerFill=document.getElementById("hud-power-fill");
bossHud=document.getElementById("boss-hud");
bossHealthFill=document.getElementById("boss-health-fill");

// Pixelated SNES-style heart
var heartSVG='<svg viewBox="0 0 10 9" style="image-rendering:pixelated"><rect x="1" y="0" width="2" height="1" fill="#ff4466"/><rect x="5" y="0" width="2" height="1" fill="#ff4466"/><rect x="0" y="1" width="4" height="1" fill="#ff4466"/><rect x="4" y="1" width="4" height="1" fill="#ff4466"/><rect x="0" y="2" width="8" height="1" fill="#ff4466"/><rect x="0" y="3" width="8" height="1" fill="#ff4466"/><rect x="1" y="4" width="6" height="1" fill="#ff4466"/><rect x="2" y="5" width="4" height="1" fill="#ff4466"/><rect x="3" y="6" width="2" height="1" fill="#ff4466"/><rect x="1" y="0" width="1" height="1" fill="#ff8899"/><rect x="5" y="0" width="1" height="1" fill="#ff8899"/><rect x="0" y="1" width="1" height="1" fill="#ff8899"/><rect x="4" y="1" width="1" height="1" fill="#ff8899"/></svg>';
function buildHearts(count,max){
  hudHearts.innerHTML="";
  for(var i=0;i<max;i++){
    var d=document.createElement("div");
    d.className="hud-heart"+(i>=count?" empty":"");
    d.innerHTML=heartSVG;
    hudHearts.appendChild(d);
  }
}

function buildDashPips(charges,maxCharges){
  hudDashCharges.innerHTML="";
  for(var i=0;i<maxCharges;i++){
    var d=document.createElement("div");
    d.className="dash-pip "+(i<charges?"full":"empty");
    hudDashCharges.appendChild(d);
  }
}

var desktopHelp=
  "You are a warrior robot in the desert.\n"+
  "Run forward, dodge enemies, collect energy!\n\n"+
  "<b>CONTROLS:</b>\n"+
  "LEFT / RIGHT  or  A / D  =  Run\n"+
  "UP / W / SPACE  =  Jump\n"+
  "DOWN / S  =  Crouch (duck under shots)\n"+
  "SHIFT  =  Dash (uses 1 charge)\n"+
  "ENTER  =  Pause\n\n"+
  "<b>PICKUPS:</b>\n"+
  "Blue POWERcells  =  refill dash + boost\n"+
  "Pink hearts  =  +1 life\n"+
  "Golden D  =  FREQ MODE (rare!)\n\n"+
  "<b>TIP:</b> Stomp enemies for extra points!\n"+
  "LEVEL 2 at 500 dist | LEVEL 3 at 1000 dist";
var mobileHelp=
  "You are a warrior robot in the desert.\n"+
  "Run forward, dodge enemies, collect energy!\n\n"+
  "<b>CONTROLS:</b>\n"+
  "\u25C0 \u25B6  =  Run  |  \u25BC  =  Crouch\n"+
  "JUMP  |  DASH\n\n"+
  "<b>PICKUPS:</b>\n"+
  "Blue POWERcells  =  refill dash + boost\n"+
  "Pink hearts  =  +1 life\n"+
  "Golden D  =  FREQ MODE (rare!)\n\n"+
  "<b>TIP:</b> Stomp enemies for extra points!\n"+
  "LEVEL 2 at 500 dist | LEVEL 3 at 1000 dist";
howtoText.innerHTML=isMobile?mobileHelp:desktopHelp;
pauseHint.textContent=isMobile?"Tap RESUME":"ENTER = RESUME";

function showScreen(name){
  scrTitle.classList.add("ov-hidden");scrHowto.classList.add("ov-hidden");
  scrPaused.classList.add("ov-hidden");scrGameover.classList.add("ov-hidden");
  scrPauseHowto.classList.add("ov-hidden");scrLeaderboard.classList.add("ov-hidden");
  if(name==="title"){scrTitle.classList.remove("ov-hidden");overlay.classList.add("active");domHud.classList.remove("visible");}
  else if(name==="howto"){scrHowto.classList.remove("ov-hidden");overlay.classList.add("active");}
  else if(name==="paused"){scrPaused.classList.remove("ov-hidden");overlay.classList.add("active");}
  else if(name==="pause-howto"){scrPauseHowto.classList.remove("ov-hidden");overlay.classList.add("active");}
  else if(name==="leaderboard"){scrLeaderboard.classList.remove("ov-hidden");overlay.classList.add("active");}
  else if(name==="gameover"){scrGameover.classList.remove("ov-hidden");overlay.classList.add("active");}
  else{overlay.classList.remove("active");domHud.classList.add("visible");}
}

// Mobile controls - landscape with joystick
var mobileButtons=[];
var joystickZone=document.getElementById("joystick-zone");
var joystickKnob=document.getElementById("joystick-knob");
var rotatePrompt=document.getElementById("rotate-prompt");
var mobilePause=document.getElementById("mobile-pause");
var joystickActive=false,joystickTouchId=null;
var joystickCenter={x:60,y:60};
var joystickValue={x:0,y:0};

if(isMobile){
  // Only JUMP and DASH buttons on right side (big)
  [{id:"mj",text:"JUMP",right:"12px",bottom:"70px",w:90,h:70},
   {id:"md",text:"DASH",right:"12px",bottom:"8px",w:90,h:55}
  ].forEach(function(d){
    var b=document.createElement("button");
    b.className="mobile-btn";b.textContent=d.text;b.style.display="block";
    b.style.width=d.w+"px";b.style.height=d.h+"px";
    if(d.x) b.style.left=d.x;if(d.right) b.style.right=d.right;
    b.style.bottom=d.bottom;b.style.background="rgba(255,200,180,0.3)";
    b.style.color="#ffcc99";b.style.border="3px solid rgba(255,200,180,0.6)";
    document.body.appendChild(b);mobileButtons.push({el:b,id:d.id});
  });

  // Mobile pause button handler
  mobilePause.addEventListener("touchstart",function(e){
    e.preventDefault();e.stopPropagation();
    if(state==="playing"){state="paused";showScreen("paused");}
    else if(state==="paused"){state="playing";showScreen("game");}
  },{passive:false});

  // Joystick touch handlers
  joystickZone.addEventListener("touchstart",function(e){
    e.preventDefault();
    var t=e.changedTouches[0];
    joystickTouchId=t.identifier;
    joystickActive=true;
    updateJoystick(t);
  },{passive:false});

  joystickZone.addEventListener("touchmove",function(e){
    e.preventDefault();
    for(var i=0;i<e.changedTouches.length;i++){
      if(e.changedTouches[i].identifier===joystickTouchId){
        updateJoystick(e.changedTouches[i]);
        break;
      }
    }
  },{passive:false});

  joystickZone.addEventListener("touchend",function(e){
    for(var i=0;i<e.changedTouches.length;i++){
      if(e.changedTouches[i].identifier===joystickTouchId){
        joystickActive=false;
        joystickTouchId=null;
        joystickValue.x=0;joystickValue.y=0;
        joystickKnob.style.left="35px";joystickKnob.style.top="35px";
        held.left=false;held.right=false;held.down=false;
        break;
      }
    }
  });

  function updateJoystick(touch){
    var rect=joystickZone.getBoundingClientRect();
    var cx=rect.left+60,cy=rect.top+60;
    var dx=touch.clientX-cx,dy=touch.clientY-cy;
    var dist=Math.sqrt(dx*dx+dy*dy);
    var maxDist=40;
    if(dist>maxDist){dx=dx/dist*maxDist;dy=dy/dist*maxDist;dist=maxDist;}
    joystickKnob.style.left=(35+dx)+"px";
    joystickKnob.style.top=(35+dy)+"px";
    joystickValue.x=dx/maxDist;
    joystickValue.y=dy/maxDist;
    // Update held state based on joystick
    held.left=joystickValue.x<-0.3;
    held.right=joystickValue.x>0.3;
    held.down=joystickValue.y>0.5; // Crouch when pushing down
  }

  // Orientation check
  function checkOrientation(){
    var isLandscape=window.innerWidth>window.innerHeight;
    rotatePrompt.style.display=isLandscape?"none":"flex";
    joystickZone.style.display=isLandscape?"block":"none";
    mobilePause.style.display=isLandscape?"block":"none";
    mobileButtons.forEach(function(mb){mb.el.style.display=isLandscape?"block":"none";});
  }
  window.addEventListener("resize",checkOrientation);
  window.addEventListener("orientationchange",checkOrientation);
  checkOrientation();
}

// === STATE ===
var state="title";
var cam={x:0};
var player={x:60,y:GROUND_Y,vx:0,vy:0,onGround:true,wasOnGround:true,
  coyoteTimer:0,jumpBufferTimer:0,dashTimer:0,dashCharges:1,dashDir:1,
  invuln:0,lives:MAX_LIVES,animFrame:0,animTimer:0,facing:1,runDust:0,
  powerTimer:0,prevY:GROUND_Y,invincTimer:0,crouching:false};
var CROUCH_HEIGHT=10; // Reduced hitbox when crouching (normal is PLAYER_H=20)
var MAX_DASH_CHARGES=3;
var enemies=[],projectiles=[],platforms=[],particles=[];
var fliers=[],drops=[],droids=[],lasers=[];
var terrainDunes=[];
var dunesFar=[],dunesMid=[],dunesClose=[];
var sandSpecs=[],props=[],glowDomes=[];
var heartPickups=[],powerCells=[],invincPickups=[];
var sandworms=[];
var bigworms=[],daggers=[];
var spiders=[],gooDrops=[];
var torches=[];
var stars=[];
var score=0,distance=0,maxX=0;
var bestScore=parseInt(localStorage.getItem("freqfx_best"))||0;
// Scoring: distance (1:1) + enemy kills (5-10pts) + item pickups (2pts)
var SCORE_ENEMY_KILL=10;
var SCORE_ITEM_PICKUP=2;
// Score popups and combo system
var scorePopups=[];
var stompCombo=0; // Resets when player touches ground
var gameTime=0,spawnTimer=0,wormTimer=0,flierTimer=0,droidTimer=0;
var lastTime=0,shakeTimer=0,shimmerOffset=0;
var held={left:false,right:false,jump:false,dash:false,down:false};
var lastGenX=0,lastPowerX=0,lastHeartX=0,lastInvincX=0;

// Level system
var level=1;
var levelTransitionTimer=0;
var spawnPauseTimer=0;
var pitFallTimer=0,pitFallScroll=0;
var bigwormTimer=0,spiderTimer=0;
var level3GraceTimer=0; // Invuln grace period during L3 transition
var LEVEL_3_GRACE_TIME=2.5; // Total grace: pit fall + 0.5s after landing

// Invincibility once per level gate
var invincSpawned={1:false,2:false,3:false};

// FREQ mode message timer
var freqModeTimer=0;
var FREQ_MODE_MSG_TIME=2.0;

// Stomp flash effect + cooldown
var stompFlash=0;
var stompCooldown=0;

titleBest.textContent="BEST: "+bestScore;

// === TERRAIN HEIGHT ===
function groundYAt(worldX){
  var y=GROUND_Y;
  for(var i=0;i<terrainDunes.length;i++){
    var d=terrainDunes[i];
    var dx=worldX-d.x;
    var radius=d.w/2;
    if(dx>-radius&&dx<radius){
      var bump=d.h*0.5*(1+Math.cos(Math.PI*dx/radius));
      var surfY=GROUND_Y-bump;
      if(surfY<y) y=surfY;
    }
  }
  return y;
}

// === INIT ===
function initWorld(){
  dunesFar=[];dunesMid=[];dunesClose=[];sandSpecs=[];props=[];glowDomes=[];stars=[];
  for(var i=0;i<14;i++) dunesFar.push({x:i*36,h:5+Math.random()*8,w:28+Math.random()*24});
  for(var j=0;j<12;j++) dunesMid.push({x:j*38,h:4+Math.random()*6,w:22+Math.random()*20});
  for(var k=0;k<10;k++) dunesClose.push({x:k*46,h:3+Math.random()*4,w:18+Math.random()*16});
  for(var s=0;s<40;s++) sandSpecs.push({x:Math.random()*W*3,y:GROUND_Y+2+Math.random()*25,c:Math.random()>0.5?C_SAND_SPEC:C_SAND_DARK});
  for(var st=0;st<50;st++) stars.push({x:Math.random()*W,y:Math.random()*80,b:0.3+Math.random()*0.7,s:Math.random()*3});
  for(var g=0;g<8;g++) glowDomes.push({x:80+g*70+Math.random()*40,r:4+Math.random()*5});
  for(var p=0;p<20;p++){
    var px=120+p*60+Math.random()*40;
    var type=Math.random();
    if(type<0.1) props.push({x:px,type:"antenna",h:8+Math.floor(Math.random()*8)});
    else if(type<0.4) props.push({x:px,type:"panel",w:5+Math.floor(Math.random()*4),h:3+Math.floor(Math.random()*2)});
    else if(type<0.65) props.push({x:px,type:"wreck",w:6+Math.floor(Math.random()*5)});
    else props.push({x:px,type:"dome",r:3+Math.floor(Math.random()*3)});
  }
}

function platformOverlaps(px,pw,py){
  for(var i=0;i<platforms.length;i++){
    var other=platforms[i];
    if(Math.abs(py-other.y)<6) continue;
    var oLeft=other.x,oRight=other.x+other.w;
    var nLeft=px,nRight=px+pw;
    var overlap=Math.max(0,Math.min(nRight,oRight)-Math.max(nLeft,oLeft));
    var minW=Math.min(pw,other.w);
    if(minW>0&&overlap/minW>0.25) return true;
  }
  return false;
}

function generateWorld(upToX){
  while(lastGenX<upToX){
    var segStart=lastGenX;
    lastGenX+=80+Math.random()*100;
    var r=Math.random();
    if(r<0.5){
      var dw=40+Math.floor(Math.random()*30);
      var dh=10+Math.floor(Math.random()*12);
      terrainDunes.push({x:segStart+40+Math.random()*30,w:dw,h:dh});
    }
    // Platform spawn chance is higher in Level 2, even higher in Level 3
    var platChance=level===3?0.5:level===2?0.4:0.25;
    if(Math.random()<platChance){
      var itemX=segStart+20+Math.random()*40;
      var localGround=groundYAt(itemX);
      // Level 3: platforms go higher (3-4 tiers)
      var extraHeight=level===3?20+Math.random()*15:0;
      var itemY=localGround-MAX_JUMP_HEIGHT-12-Math.random()*10-extraHeight;
      if(itemY<18) itemY=18;
      var itemType="power";
      if(Math.random()<0.2&&(itemX-lastHeartX)>HEART_MIN_DIST) itemType="heart";
      var highW=26+Math.floor(Math.random()*10);
      var highY=itemY+10;
      var highX=itemX-highW/2;
      var needStep=localGround-highY>MAX_JUMP_HEIGHT;

      // Varied platform layout patterns - Level 3 gets more complex patterns
      var layoutPattern=Math.floor(Math.random()*(level===3?8:5));
      if(needStep){
        var lowY=localGround-MAX_JUMP_HEIGHT+4;
        var lowW=22+Math.floor(Math.random()*8);
        var offset=18+Math.floor(Math.random()*12);

        if(level===3){
          // Level 3: 3-4 tier platform challenges
          var tier1Y=localGround-MAX_JUMP_HEIGHT+6;
          var tier2Y=localGround-MAX_JUMP_HEIGHT*1.5;
          var tier3Y=localGround-MAX_JUMP_HEIGHT*2+10;
          var tier1W=20+Math.floor(Math.random()*8);
          var tier2W=18+Math.floor(Math.random()*6);
          var tier3W=16+Math.floor(Math.random()*6);

          if(layoutPattern<3){
            // 3-tier zigzag left
            var t1X=highX+highW+offset*0.3;
            var t2X=highX-offset*0.5;
            var t3X=highX+offset*0.2;
            if(!platformOverlaps(t1X,tier1W,tier1Y)) platforms.push({x:t1X,y:tier1Y,w:tier1W});
            if(!platformOverlaps(t2X,tier2W,tier2Y)) platforms.push({x:t2X,y:tier2Y,w:tier2W});
            if(!platformOverlaps(t3X,tier3W,tier3Y)) platforms.push({x:t3X,y:tier3Y,w:tier3W});
          } else if(layoutPattern<5){
            // 3-tier zigzag right
            var t1X=highX-offset*0.5;
            var t2X=highX+highW+offset*0.3;
            var t3X=highX;
            if(!platformOverlaps(t1X,tier1W,tier1Y)) platforms.push({x:t1X,y:tier1Y,w:tier1W});
            if(!platformOverlaps(t2X,tier2W,tier2Y)) platforms.push({x:t2X,y:tier2Y,w:tier2W});
            if(!platformOverlaps(t3X,tier3W,tier3Y)) platforms.push({x:t3X,y:tier3Y,w:tier3W});
          } else if(layoutPattern<7){
            // 4-tier staircase
            var tier4Y=localGround-MAX_JUMP_HEIGHT*2.3;
            var tier4W=14+Math.floor(Math.random()*5);
            var t1X=highX+highW+offset*0.5;
            var t2X=highX+offset*0.3;
            var t3X=highX-offset*0.3;
            var t4X=highX+offset*0.1;
            if(!platformOverlaps(t1X,tier1W,tier1Y)) platforms.push({x:t1X,y:tier1Y,w:tier1W});
            if(!platformOverlaps(t2X,tier2W,tier2Y)) platforms.push({x:t2X,y:tier2Y,w:tier2W});
            if(!platformOverlaps(t3X,tier3W,tier3Y)) platforms.push({x:t3X,y:tier3Y,w:tier3W});
            if(tier4Y>=16&&!platformOverlaps(t4X,tier4W,tier4Y)) platforms.push({x:t4X,y:tier4Y,w:tier4W});
          } else {
            // 4-tier tower
            var tier4Y=localGround-MAX_JUMP_HEIGHT*2.4;
            var tier4W=14+Math.floor(Math.random()*5);
            var centerX=highX+highW/2;
            if(!platformOverlaps(centerX-tier1W/2+10,tier1W,tier1Y)) platforms.push({x:centerX-tier1W/2+10,y:tier1Y,w:tier1W});
            if(!platformOverlaps(centerX-tier2W/2-8,tier2W,tier2Y)) platforms.push({x:centerX-tier2W/2-8,y:tier2Y,w:tier2W});
            if(!platformOverlaps(centerX-tier3W/2+6,tier3W,tier3Y)) platforms.push({x:centerX-tier3W/2+6,y:tier3Y,w:tier3W});
            if(tier4Y>=16&&!platformOverlaps(centerX-tier4W/2,tier4W,tier4Y)) platforms.push({x:centerX-tier4W/2,y:tier4Y,w:tier4W});
          }
        } else if(layoutPattern===0){
          // Pattern 0: Step on left
          var lowX=highX-offset;
          if(!platformOverlaps(lowX,lowW,lowY)) platforms.push({x:lowX,y:lowY,w:lowW});
        } else if(layoutPattern===1){
          // Pattern 1: Step on right
          var lowX=highX+highW+offset-lowW;
          if(!platformOverlaps(lowX,lowW,lowY)) platforms.push({x:lowX,y:lowY,w:lowW});
        } else if(layoutPattern===2){
          // Pattern 2: Two steps (zigzag left-right)
          var midY=localGround-MAX_JUMP_HEIGHT*0.6;
          var midW=18+Math.floor(Math.random()*6);
          var midX=highX-offset*0.7;
          if(!platformOverlaps(midX,midW,midY)) platforms.push({x:midX,y:midY,w:midW});
          var lowX=highX+highW+offset*0.5-lowW;
          if(!platformOverlaps(lowX,lowW,lowY)) platforms.push({x:lowX,y:lowY,w:lowW});
        } else if(layoutPattern===3){
          // Pattern 3: Two steps (zigzag right-left)
          var midY=localGround-MAX_JUMP_HEIGHT*0.6;
          var midW=18+Math.floor(Math.random()*6);
          var midX=highX+highW+offset*0.5;
          if(!platformOverlaps(midX,midW,midY)) platforms.push({x:midX,y:midY,w:midW});
          var lowX=highX-offset;
          if(!platformOverlaps(lowX,lowW,lowY)) platforms.push({x:lowX,y:lowY,w:lowW});
        } else {
          // Pattern 4: Centered step directly below
          var lowX=highX+(highW-lowW)/2;
          if(!platformOverlaps(lowX,lowW,lowY)) platforms.push({x:lowX,y:lowY,w:lowW});
        }
        if(!platformOverlaps(highX,highW,highY)) platforms.push({x:highX,y:highY,w:highW});
      } else {
        if(!platformOverlaps(highX,highW,highY)) platforms.push({x:highX,y:highY,w:highW});
      }
      // NOTE: Removed random extra platforms in Level 2 - only add platforms with items
      if(itemType==="heart"){
        heartPickups.push({x:itemX,y:itemY,bob:Math.random()*6.28});
        lastHeartX=itemX;
      } else {
        powerCells.push({x:itemX,y:itemY,bob:Math.random()*6.28});
        lastPowerX=itemX;
      }
    }
    // Level 2+: pickups ONLY on upper platforms (skip ground-level spawns)
    if(level===1&&Math.random()<0.12&&(segStart-lastPowerX)>POWER_MIN_DIST){
      for(var di=terrainDunes.length-1;di>=0;di--){
        var td=terrainDunes[di];
        if(Math.abs(td.x-segStart)<60){
          powerCells.push({x:td.x,y:GROUND_Y-td.h-12,bob:Math.random()*6.28});
          lastPowerX=td.x;break;
        }
      }
    }
    if(level===1&&Math.random()<0.02&&(segStart-lastHeartX)>HEART_MIN_DIST){
      var hpx=segStart+30+Math.random()*40;
      heartPickups.push({x:hpx,y:groundYAt(hpx)-12,bob:Math.random()*6.28});
      lastHeartX=hpx;
    }
    // Invincibility power-up: ONCE per level only, on upper platform
    if(!invincSpawned[level]&&(segStart-lastInvincX)>INVINC_MIN_DIST&&Math.random()<0.15){
      // Set flag FIRST to prevent any duplicate spawns
      invincSpawned[level]=true;
      var invX=segStart+25+Math.random()*35;
      var invLocalGround=groundYAt(invX);
      var invY=invLocalGround-MAX_JUMP_HEIGHT-20-Math.random()*8;
      if(invY<25) invY=25;
      // Create step platforms to reach it
      var invPlatW=24+Math.floor(Math.random()*8);
      var invPlatY=invY+8;
      var invPlatX=invX-invPlatW/2;
      var invNeedStep=invLocalGround-invPlatY>MAX_JUMP_HEIGHT;
      if(invNeedStep){
        var invLowY=invLocalGround-MAX_JUMP_HEIGHT+4;
        var invLowW=20+Math.floor(Math.random()*6);
        var invLowX=invPlatX-20-Math.floor(Math.random()*8);
        if(!platformOverlaps(invLowX,invLowW,invLowY)) platforms.push({x:invLowX,y:invLowY,w:invLowW});
      }
      if(!platformOverlaps(invPlatX,invPlatW,invPlatY)) platforms.push({x:invPlatX,y:invPlatY,w:invPlatW});
      invincPickups.push({x:invX,y:invY,bob:Math.random()*6.28});
      lastInvincX=invX;
    }
    // Level 3: spawn torches for lighting
    if(level===3&&Math.random()<0.15){
      torches.push({x:segStart+20+Math.random()*60,flicker:Math.random()*6.28});
    }
  }
}

function resetGame(){
  player.x=60;player.y=GROUND_Y;player.vx=0;player.vy=0;
  player.onGround=true;player.wasOnGround=true;
  player.coyoteTimer=0;player.jumpBufferTimer=0;
  player.dashTimer=0;player.dashCharges=1;player.invuln=SAFE_START;
  player.lives=MAX_LIVES;player.animFrame=0;player.animTimer=0;player.facing=1;player.runDust=0;
  player.powerTimer=0;player.prevY=GROUND_Y;player.invincTimer=0;player.crouching=false;
  cam.x=0;enemies=[];projectiles=[];platforms=[];terrainDunes=[];particles=[];
  fliers=[];drops=[];droids=[];lasers=[];
  bigworms=[];daggers=[];spiders=[];gooDrops=[];torches=[];
  heartPickups=[];powerCells=[];invincPickups=[];sandworms=[];scorePopups=[];
  score=0;distance=0;maxX=60;gameTime=0;spawnTimer=SAFE_START;shakeTimer=0;lastGenX=0;lastPowerX=0;lastHeartX=0;lastInvincX=0;
  stompFlash=0;stompCooldown=0;stompCombo=0;
  level=1;levelTransitionTimer=0;freqModeTimer=0;spawnPauseTimer=0;pitFallTimer=0;pitFallScroll=0;level3GraceTimer=0;
  invincSpawned={1:false,2:false,3:false};
  wormTimer=WORM_MIN_INTERVAL+Math.random()*(WORM_MAX_INTERVAL-WORM_MIN_INTERVAL);
  flierTimer=5+Math.random()*3;
  droidTimer=8+Math.random()*4;
  bigwormTimer=6+Math.random()*4;
  spiderTimer=4+Math.random()*3;
  // Reset boss
  boss.active=false;boss.health=0;boss.state="inactive";boss.defeated=false;
  boss.timer=0;boss.hurtTimer=0;boss.flashTimer=0;boss.defeatTimer=0;
  boss.phase=1;boss.x=0;boss.y=GROUND_Y;boss.segmentOffsets=[];
  bossSpawned=false;
  bossProjectiles=[];
  playerLasers=[];
  playerLaserCooldown=0;
  scoreSubmitted=false;
  if(bossHud) bossHud.classList.remove("visible");
  initWorld();
  generateWorld(cam.x+W+400);
  buildHearts(player.lives,Math.max(MAX_LIVES,player.lives));
  buildDashPips(player.dashCharges,MAX_DASH_CHARGES);
  hudLevel.textContent="LVL 1";
  hudLevel.style.color="#88ccff";
  hudDashLabel.textContent="DASH";
}

// === SPAWNING ===
function worldRight(){return cam.x+W+50;}

function spawnEnemy(){
  if(gameTime<SAFE_START||spawnPauseTimer>0) return;
  var ewx=worldRight()+Math.random()*80;
  var baseY=GROUND_Y-30-Math.random()*30;
  var pattern=Math.random()>0.5?"sine":"straight";
  enemies.push({x:ewx,y:baseY,baseY:baseY,w:14,h:10,
    vx:-SHIP_SPEED*(0.8+Math.random()*0.4),pattern:pattern,age:0,
    fireTimer:1+Math.random()*SHIP_FIRE_INTERVAL,telegraphing:false,telegraphTimer:0});
}

function spawnSandworm(){
  if(spawnPauseTimer>0) return;
  var startX=cam.x+W+40+Math.random()*60;
  sandworms.push({x:startX,y:GROUND_Y,vx:-WORM_SPEED,state:"telegraph",timer:WORM_TELEGRAPH,length:WORM_LENGTH});
}

function spawnFlier(){
  if(spawnPauseTimer>0) return;
  var fx=worldRight()+Math.random()*60;
  var baseY=GROUND_Y-50-Math.random()*20;
  fliers.push({x:fx,y:baseY,baseY:baseY,w:12,h:8,
    vx:-FLIER_SPEED*(0.8+Math.random()*0.3),age:0,
    dropTimer:2+Math.random()*FLIER_DROP_INTERVAL,telegraphing:false,telegraphTimer:0});
}

function spawnDroid(){
  if(spawnPauseTimer>0) return;
  var speedMult=level===3?getL3DifficultyMult():1;
  var dx=worldRight()+Math.random()*80;
  var gy=groundYAt(dx);
  var fireInt=level===3?DROID_L3_FIRE_INTERVAL:DROID_FIRE_INTERVAL;
  droids.push({x:dx,y:gy,w:10,h:12,vx:DROID_SPEED*speedMult,patrolStart:dx,
    fireTimer:(1.5+Math.random()*fireInt)/speedMult,telegraphing:false,telegraphTimer:0});
}

// Level 3 enemies - speed scales with distance
function getL3DifficultyMult(){
  var distPast1000=Math.max(0,distance-LEVEL_3_THRESHOLD);
  return 1+Math.floor(distPast1000/200)*0.1; // +10% every 200 dist
}

function spawnBigworm(){
  if(spawnPauseTimer>0) return;
  var speedMult=getL3DifficultyMult();
  var startX=cam.x+W+60+Math.random()*80;
  bigworms.push({x:startX,y:GROUND_Y,vx:-BIGWORM_SPEED*speedMult,length:BIGWORM_LENGTH,
    fireTimer:(1+Math.random()*BIGWORM_FIRE_INTERVAL)/speedMult,telegraphing:false,telegraphTimer:0});
}

function spawnSpider(){
  if(spawnPauseTimer>0) return;
  var speedMult=getL3DifficultyMult();
  var sx=worldRight()+Math.random()*60;
  spiders.push({x:sx,y:20+Math.random()*15,w:10,h:8,vx:-SPIDER_SPEED*(0.7+Math.random()*0.4)*speedMult,
    dropTimer:(1.5+Math.random()*SPIDER_DROP_INTERVAL)/speedMult,telegraphing:false,telegraphTimer:0});
}

function spawnDust(x,y,count,color){
  for(var i=0;i<count;i++){
    particles.push({x:x,y:y,vx:(Math.random()-0.5)*30,vy:-Math.random()*25-5,
      life:0.25+Math.random()*0.25,color:color||"#d4b898",size:1});
  }
}

function spawnParticles(x,y,color,count){
  for(var i=0;i<count;i++){
    particles.push({x:x,y:y,vx:(Math.random()-0.5)*80,vy:-Math.random()*60,
      life:0.3+Math.random()*0.3,color:color,size:1+Math.floor(Math.random()*2)});
  }
}

function spawnScorePopup(x,y,value,combo){
  var text="+"+value;
  var color="#ffcc00";
  if(combo>1){text="+"+value+" x"+combo;color="#ff8844";}
  scorePopups.push({x:x,y:y,text:text,timer:1.2,color:color});
}

function rectsOverlap(ax,ay,aw,ah,bx,by,bw,bh){
  return ax<bx+bw&&ax+aw>bx&&ay<by+bh&&ay+ah>by;
}

// === BOSS: Cave Worm System ===
var BOSS_BURROW_TIME=0.7; // Telegraph time before emerging
var bossArenaLeft=0,bossArenaRight=0; // Arena boundaries

function spawnBoss(){
  if(bossSpawned||boss.active) return;
  bossSpawned=true;
  boss.active=true;
  boss.health=BOSS_MAX_HEALTH;
  boss.x=cam.x+W/2+40; // Start more centered
  boss.y=GROUND_Y;
  boss.emergeX=boss.x;
  boss.emergeY=GROUND_Y;
  boss.state="burrowing"; // Start with telegraph
  boss.timer=BOSS_BURROW_TIME;
  boss.phase=1;
  boss.facing=-1;
  boss.defeated=false;
  boss.defeatTimer=0;
  boss.flashTimer=0;
  boss.hurtTimer=0;
  boss.segmentOffsets=[];
  for(var i=0;i<BOSS_SEGMENTS;i++) boss.segmentOffsets.push(0);
  bossProjectiles=[];
  // Clear regular enemies and pause spawning
  enemies=[];fliers=[];droids=[];sandworms=[];bigworms=[];spiders=[];
  projectiles=[];lasers=[];daggers=[];gooDrops=[];drops=[];
  spawnPauseTimer=999; // Pause indefinitely until boss defeated
  // Change DASH label to SHOOT for boss fight
  hudDashLabel.textContent="SHOOT";

  // === SPAWN BOSS ARENA PLATFORMS ===
  // Create two platforms on left and right for jumping onto worm
  bossArenaLeft=cam.x+40;
  bossArenaRight=cam.x+W-40;
  var platY=GROUND_Y-25; // Platform height - good for jumping to worm
  var platW=35;
  // Left platform
  platforms.push({x:bossArenaLeft,y:platY,w:platW});
  // Right platform
  platforms.push({x:bossArenaRight-platW,y:platY,w:platW});
  // Middle elevated platform (optional extra)
  platforms.push({x:cam.x+W/2-20,y:GROUND_Y-40,w:40});

  // Show boss HUD
  if(bossHud) bossHud.classList.add("visible");
  if(bossHealthFill) bossHealthFill.style.width="100%";
  playSfx("bossRumble"); // Rumble during burrowing telegraph
  shakeTimer=0.3;
}

function chooseBossAttack(){
  var attacks=["lunge","spit"];
  if(boss.phase>=2) attacks.push("tremor");
  var idx=Math.floor(Math.random()*attacks.length);
  return attacks[idx];
}

function updateBoss(dt){
  if(!boss.active) return;

  // Update segment wave animation
  for(var i=0;i<BOSS_SEGMENTS;i++){
    boss.segmentOffsets[i]=Math.sin(gameTime*4+i*0.5)*3;
  }

  // Hurt flash countdown
  if(boss.flashTimer>0) boss.flashTimer-=dt;
  if(boss.hurtTimer>0) boss.hurtTimer-=dt;

  // Phase check
  if(boss.health<=2&&boss.phase===1){
    boss.phase=2;
    shakeTimer=0.3;
    playSfx("bossPhase");
  }

  // Defeated state
  if(boss.defeated){
    boss.defeatTimer-=dt;
    if(boss.defeatTimer<=0){
      bossDefeated();
    }
    return;
  }

  boss.timer-=dt;

  // === BURROWING STATE - Telegraph before emerging ===
  if(boss.state==="burrowing"){
    // Ground rumble effect - particles show where worm will emerge
    var rumbleIntensity=1-boss.timer/BOSS_BURROW_TIME; // Gets stronger
    if(Math.random()<0.3+rumbleIntensity*0.5){
      var rx=boss.x+(Math.random()-0.5)*50*rumbleIntensity;
      particles.push({x:rx,y:GROUND_Y-2-Math.random()*8,
        vx:(Math.random()-0.5)*20,vy:-Math.random()*30-10,
        life:0.3+Math.random()*0.2,color:Math.random()<0.5?"#aa9988":"#887766",size:2});
    }
    // Small screen shake building up
    if(rumbleIntensity>0.5) shakeTimer=Math.max(shakeTimer,0.05);
    if(boss.timer<=0){
      boss.state="spawning";
      boss.timer=BOSS_EMERGE_TIME;
      playSfx("bossSpawn");
      shakeTimer=0.4;
    }
  }
  else if(boss.state==="spawning"){
    // Emerging from ground
    var progress=1-boss.timer/BOSS_EMERGE_TIME;
    boss.y=GROUND_Y-progress*BOSS_EMERGE_HEIGHT;
    // Dust particles
    if(Math.random()<0.6){
      spawnDust(boss.x+(Math.random()-0.5)*40,GROUND_Y,3,"#aa8866");
    }
    if(boss.timer<=0){
      boss.state="idle";
      boss.timer=boss.phase===2?BOSS_IDLE_TIME_P2:BOSS_IDLE_TIME;
      boss.y=GROUND_Y-BOSS_EMERGE_HEIGHT;
    }
  }
  else if(boss.state==="idle"){
    // Face player
    boss.facing=player.x<boss.x?-1:1;
    if(boss.timer<=0){
      boss.currentAttack=chooseBossAttack();
      boss.state="telegraph";
      boss.timer=BOSS_TELEGRAPH_TIME;
      boss.telegraphing=true;
    }
  }
  else if(boss.state==="telegraph"){
    if(boss.timer<=0){
      boss.telegraphing=false;
      boss.state="attacking";
      boss.timer=BOSS_ATTACK_DURATION;
      // Start attack
      if(boss.currentAttack==="lunge"){
        boss.lungeTarget=player.x;
        boss.lungeVx=boss.facing*BOSS_LUNGE_SPEED;
        playSfx("bossLunge");
      } else if(boss.currentAttack==="spit"){
        boss.spitCount=boss.phase===2?5:3;
        boss.attackTimer=0;
        playSfx("bossSpit");
      } else if(boss.currentAttack==="tremor"){
        boss.tremoring=true;
        shakeTimer=BOSS_ATTACK_DURATION;
        playSfx("bossTremor");
      }
    }
  }
  else if(boss.state==="attacking"){
    if(boss.currentAttack==="lunge"){
      boss.x+=boss.lungeVx*dt;
      // Stop at screen edge or past target
      if(boss.x<cam.x+40||boss.x>cam.x+W-40){
        boss.lungeVx=0;
        boss.timer=0;
      }
    } else if(boss.currentAttack==="spit"){
      boss.attackTimer+=dt;
      if(boss.spitCount>0&&boss.attackTimer>0.18){
        boss.attackTimer=0;
        boss.spitCount--;
        // Fire acid projectile from mouth center - sprays in arc
        var mouthX=boss.x;
        var mouthY=boss.y-15;
        var dx=player.x-mouthX,dy=player.y-mouthY;
        var dist=Math.sqrt(dx*dx+dy*dy)||1;
        var spread=(Math.random()-0.5)*0.5; // More spread for spray effect
        var baseAngle=Math.atan2(dy,dx);
        var projAngle=baseAngle+spread;
        bossProjectiles.push({
          x:mouthX,y:mouthY,
          vx:Math.cos(projAngle)*BOSS_PROJ_SPEED*1.1,
          vy:Math.sin(projAngle)*BOSS_PROJ_SPEED*0.8-20, // Slight upward arc
          life:4
        });
        playSfx("bossSpit");
      }
    } else if(boss.currentAttack==="tremor"){
      // Tremor damages grounded player
      if(player.onGround&&player.invuln<=0&&player.invincTimer<=0&&player.dashTimer<=0){
        // Check if player is nearby
        var dist=Math.abs(player.x-boss.x);
        if(dist<120){
          player.lives--;player.invuln=INVULN_TIME;
          shakeTimer=0.3;playSfx("playerHit");
          spawnParticles(player.x,player.y-8,"#aa6644",8);
          buildHearts(player.lives,Math.max(MAX_LIVES,player.lives));
          if(player.lives<=0) return; // Will trigger gameOver in main update
        }
      }
    }
    if(boss.timer<=0){
      boss.tremoring=false;
      boss.state="submerging";
      boss.timer=BOSS_SUBMERGE_TIME;
    }
  }
  else if(boss.state==="submerging"){
    var progress=boss.timer/BOSS_SUBMERGE_TIME;
    boss.y=GROUND_Y-progress*BOSS_EMERGE_HEIGHT;
    if(Math.random()<0.4){
      spawnDust(boss.x+(Math.random()-0.5)*30,GROUND_Y,2,"#aa8866");
    }
    if(boss.timer<=0){
      boss.state="underground";
      boss.timer=0.8+Math.random()*0.5;
    }
  }
  else if(boss.state==="underground"){
    // Move to new position
    var targetX=player.x+(Math.random()-0.5)*100;
    targetX=Math.max(cam.x+60,Math.min(cam.x+W-60,targetX));
    boss.x+=(targetX-boss.x)*dt*2;
    if(boss.timer<=0){
      boss.state="burrowing"; // Telegraph before emerging
      boss.timer=BOSS_BURROW_TIME;
      boss.emergeX=boss.x;
      playSfx("bossRumble");
    }
  }
}

function updateBossProjectiles(dt){
  for(var i=bossProjectiles.length-1;i>=0;i--){
    var p=bossProjectiles[i];
    p.x+=p.vx*dt;
    p.vy+=BOSS_PROJ_GRAVITY*dt;
    p.y+=p.vy*dt;
    p.life-=dt;
    if(p.life<=0||p.y>GROUND_Y+10||p.x<cam.x-50||p.x>cam.x+W+50){
      bossProjectiles.splice(i,1);
      continue;
    }
    // Collision with player (smaller hitbox when crouching)
    var pH=player.crouching?CROUCH_HEIGHT:PLAYER_H;
    var pr={x:player.x-PLAYER_W/2+HIT_SHRINK,y:player.y-pH+HIT_SHRINK,
      w:PLAYER_W-HIT_SHRINK*2,h:pH-HIT_SHRINK*2};
    if(player.invincTimer>0){
      if(rectsOverlap(pr.x,pr.y,pr.w,pr.h,p.x-5,p.y-5,10,10)){
        spawnParticles(p.x,p.y,C_INVINC,4);
        bossProjectiles.splice(i,1);continue;
      }
    } else if(player.invuln<=0&&player.dashTimer<=0&&player.powerTimer<=0){
      if(rectsOverlap(pr.x,pr.y,pr.w,pr.h,p.x-5,p.y-5,10,10)){
        player.lives--;player.invuln=INVULN_TIME;
        shakeTimer=0.2;playSfx("playerHit");
        spawnParticles(p.x,p.y,"#66ff66",6);
        bossProjectiles.splice(i,1);
        buildHearts(player.lives,Math.max(MAX_LIVES,player.lives));
        if(player.lives<=0) return; // Will trigger gameOver in main update
      }
    }
  }
}

function updatePlayerLasers(dt){
  if(playerLaserCooldown>0) playerLaserCooldown-=dt;

  for(var i=playerLasers.length-1;i>=0;i--){
    var laser=playerLasers[i];
    laser.x+=laser.vx*dt;
    laser.life-=dt;

    // Remove if off screen or expired
    if(laser.life<=0||laser.x<cam.x-20||laser.x>cam.x+W+20){
      playerLasers.splice(i,1);
      continue;
    }

    // Check collision with boss (only when mouth is WIDE open during spit attack)
    if(boss.active&&!boss.defeated&&boss.state!=="underground"&&boss.state!=="burrowing"){
      var bossHitX=boss.x-20;
      var bossHitY=boss.y-25;
      var bossHitW=40;
      var bossHitH=30;

      if(rectsOverlap(laser.x-4,laser.y-2,8,4,bossHitX,bossHitY,bossHitW,bossHitH)){
        // Check if mouth is WIDE open (vulnerable) - ONLY during spit attack
        var mouthOpen=boss.state==="attacking"&&boss.currentAttack==="spit";

        if(mouthOpen&&boss.hurtTimer<=0){
          damageBoss();
          spawnParticles(laser.x,laser.y,"#88ffff",8);
          playerLasers.splice(i,1);
          continue;
        } else {
          // Mouth closed - laser deflects
          spawnParticles(laser.x,laser.y,"#888888",4);
          playerLasers.splice(i,1);
          playSfx("stomp"); // Clank sound
          continue;
        }
      }
    }
  }
}

function checkBossCollision(){
  // No collision during underground or burrowing (grace period for telegraph)
  if(!boss.active||boss.defeated||boss.state==="underground"||boss.state==="burrowing") return;

  var pH=player.crouching?CROUCH_HEIGHT:PLAYER_H;
  var pr={x:player.x-PLAYER_W/2+HIT_SHRINK,y:player.y-pH+HIT_SHRINK,
    w:PLAYER_W-HIT_SHRINK*2,h:pH-HIT_SHRINK*2};
  var hasPower=player.powerTimer>0;
  var hasInvinc=player.invincTimer>0;
  var isDashing=player.dashTimer>0;
  var isInvuln=player.invuln>0||isDashing||hasPower||hasInvinc;

  // Worm dimensions - tighter hitbox to match visual
  var bodyWidth=28;  // Reduced from 36 for fairer collision
  var wormTop=boss.y-8;
  var wormLeft=boss.x-bodyWidth/2;
  var wormRight=boss.x+bodyWidth/2;

  // === EMERGE DAMAGE - Only when worm is mostly out (last 40% of emerge) ===
  if(boss.state==="spawning"&&boss.timer<BOSS_EMERGE_TIME*0.4&&!isInvuln){
    var distToWorm=Math.abs(player.x-boss.x);
    if(distToWorm<bodyWidth&&player.y>boss.y-20){
      // Player is standing where worm emerges - BIG knockback!
      player.lives--;player.invuln=INVULN_TIME;
      shakeTimer=0.5;playSfx("playerHit");
      spawnParticles(player.x,player.y-8,"#cc8866",15);
      buildHearts(player.lives,Math.max(MAX_LIVES,player.lives));
      if(player.lives<=0){gameOver();return;}
      // Launch player away dramatically
      player.vx=(player.x<boss.x?-1:1)*180;
      player.vy=JUMP_VEL*1.2;
      player.onGround=false;
      return;
    }
  }

  // Skip other collision during emerge animation
  if(boss.state==="spawning") return;

  // NOTE: Boss can only be damaged by player lasers when mouth is open
  // No stomp or power mode damage - must shoot it!

  // === BODY COLLISION - Touching the worm body damages player ===
  var bodyTop=boss.y-BOSS_EMERGE_HEIGHT+10;
  var bodyBottom=boss.y;

  if(rectsOverlap(pr.x,pr.y,pr.w,pr.h,wormLeft,bodyTop,bodyWidth,bodyBottom-bodyTop)){
    if(hasInvinc){
      // Invincible just bounces off
      player.vx=(player.x<boss.x?-1:1)*120;
      return;
    } else if(!isInvuln){
      player.lives--;player.invuln=INVULN_TIME;
      shakeTimer=0.35;playSfx("playerHit");
      spawnParticles(player.x,player.y-8,"#cc8866",12);
      buildHearts(player.lives,Math.max(MAX_LIVES,player.lives));
      if(player.lives<=0){gameOver();return;}
      // Knockback away from worm
      player.vx=(player.x<boss.x?-1:1)*130;
      player.vy=JUMP_VEL*0.5;
      return; // Don't check other collision after taking damage
    }
  }

  // === LUNGE ATTACK - Only damages if worm is actually moving AND close ===
  if(boss.state==="attacking"&&boss.currentAttack==="lunge"&&player.invuln<=0){
    // Only damage if worm is actually lunging (has velocity) and player is within hitbox
    if(Math.abs(boss.lungeVx)>10){
      var lungeHitbox={
        x:boss.x-bodyWidth/2-3,
        y:bodyTop,
        w:bodyWidth+6,
        h:bodyBottom-bodyTop+8
      };
      if(rectsOverlap(pr.x,pr.y,pr.w,pr.h,lungeHitbox.x,lungeHitbox.y,lungeHitbox.w,lungeHitbox.h)){
        player.lives--;player.invuln=INVULN_TIME;
        shakeTimer=0.4;playSfx("playerHit");
        spawnParticles(player.x,player.y-8,"#ffaa66",15);
        buildHearts(player.lives,Math.max(MAX_LIVES,player.lives));
        if(player.lives<=0){gameOver();return;}
        // Strong knockback in lunge direction
        player.vx=boss.lungeVx>0?150:-150;
        player.vy=JUMP_VEL*0.8;
        player.onGround=false;
      }
    }
  }
}

function damageBoss(){
  if(boss.hurtTimer>0||boss.defeated) return;
  boss.health--;
  boss.hurtTimer=BOSS_HURT_TIME;
  boss.flashTimer=0.3;
  shakeTimer=0.3;
  playSfx("bossHurt");
  stompFlash=0.1;
  spawnParticles(boss.x,boss.y-25,"#ff6644",15);
  spawnParticles(boss.x,boss.y-25,"#ffffff",5);
  // Update health bar
  if(bossHealthFill){
    bossHealthFill.style.width=Math.max(0,boss.health/BOSS_MAX_HEALTH*100)+"%";
  }
  if(boss.health<=0){
    boss.defeated=true;
    boss.defeatTimer=BOSS_DEFEATED_TIME;
    playSfx("bossDefeat");
    shakeTimer=1.0;
  }
}

function bossDefeated(){
  boss.active=false;
  score+=BOSS_DEFEAT_SCORE;
  // Hide boss HUD
  if(bossHud) bossHud.classList.remove("visible");
  // Change SHOOT label back to DASH
  hudDashLabel.textContent="DASH";
  // Resume enemy spawning
  spawnPauseTimer=2.0; // Brief pause before enemies return
  // Victory particles
  for(var i=0;i<30;i++){
    particles.push({x:boss.x+(Math.random()-0.5)*60,y:boss.y-25+(Math.random()-0.5)*40,
      vx:(Math.random()-0.5)*100,vy:-Math.random()*80-20,
      life:0.5+Math.random()*0.5,color:Math.random()<0.5?"#ff8844":"#ffcc44",size:2+Math.floor(Math.random()*2)});
  }
  playSfx("bossVictory");
}

// === INPUT ===
var keys={};
function startGame(){initAudio();resetGame();state="playing";showScreen("playing");playLevelMusic(1);}

document.addEventListener("keydown",function(e){
  if(keys[e.code]){e.preventDefault();return;}
  keys[e.code]=true;
  if(state==="title"){
    if(e.code==="Enter"||e.code==="Space") startGame();
  } else if(state==="playing"){
    if(e.code==="ArrowLeft"||e.code==="KeyA") held.left=true;
    if(e.code==="ArrowRight"||e.code==="KeyD") held.right=true;
    if(e.code==="ArrowUp"||e.code==="KeyW"||e.code==="Space"){held.jump=true;player.jumpBufferTimer=JUMP_BUFFER_MS;}
    if(e.code==="ArrowDown"||e.code==="KeyS") held.down=true;
    if(e.code==="ShiftLeft"||e.code==="ShiftRight") held.dash=true;
    if(e.code==="Enter"){state="paused";showScreen("paused");}
  } else if(state==="paused"){
    if(e.code==="Enter"){state="playing";showScreen("playing");}
  }
  // Note: gameover state has no keyboard shortcuts - must click RETRY button
  if(["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].indexOf(e.code)!==-1) e.preventDefault();
});
document.addEventListener("keyup",function(e){
  keys[e.code]=false;
  if(e.code==="ArrowLeft"||e.code==="KeyA") held.left=false;
  if(e.code==="ArrowRight"||e.code==="KeyD") held.right=false;
  if(e.code==="ArrowUp"||e.code==="KeyW"||e.code==="Space") held.jump=false;
  if(e.code==="ArrowDown"||e.code==="KeyS") held.down=false;
  if(e.code==="ShiftLeft"||e.code==="ShiftRight") held.dash=false;
});

document.getElementById("btn-start").addEventListener("click",startGame);
document.getElementById("btn-howto").addEventListener("click",function(){showScreen("howto");});
document.getElementById("btn-title-lb").addEventListener("click",function(){loadLeaderboard();showScreen("leaderboard");});
document.getElementById("btn-back").addEventListener("click",function(){showScreen("title");});
document.getElementById("btn-resume").addEventListener("click",function(){state="playing";showScreen("playing");});
document.getElementById("btn-retry").addEventListener("click",startGame);
document.getElementById("btn-submit-score").addEventListener("click",function(){
  var nameInput=document.getElementById("lb-name-input");
  submitScore(nameInput.value,score);
});
document.getElementById("btn-leaderboard").addEventListener("click",function(){
  loadLeaderboard();
  showScreen("leaderboard");
});
document.getElementById("lb-name-input").addEventListener("keypress",function(e){
  if(e.key==="Enter"){
    var nameInput=document.getElementById("lb-name-input");
    submitScore(nameInput.value,score);
  }
});
// Volume and pause menu controls
var volSlider=document.getElementById("vol-slider");
var btnMute=document.getElementById("btn-mute");
var pauseHowtoText=document.getElementById("pause-howto-text");
function updateMusicVolume(){
  var v=parseInt(volSlider.value)/100;
  musicVolume=v;
  if(level1Music)level1Music.volume=v;
  if(level2Music)level2Music.volume=v;
  if(level3Music)level3Music.volume=v;
  if(v===0){btnMute.textContent="üîá";}
  else{btnMute.textContent="üîä";}
}
volSlider.addEventListener("input",updateMusicVolume);
volSlider.addEventListener("change",updateMusicVolume);
volSlider.addEventListener("touchend",updateMusicVolume);
btnMute.addEventListener("click",function(){
  audioMuted=!audioMuted;
  if(audioMuted){
    btnMute.textContent="üîá";
    if(level1Music)level1Music.pause();
    if(level2Music)level2Music.pause();
    if(level3Music)level3Music.pause();
  }else{
    btnMute.textContent="üîä";
    playLevelMusic(level);
  }
});
document.getElementById("btn-pause-howto").addEventListener("click",function(){
  pauseHowtoText.innerHTML=howtoText.innerHTML;
  showScreen("pause-howto");
});
document.getElementById("btn-pause-back").addEventListener("click",function(){
  showScreen("paused");
});
document.getElementById("btn-pause-lb").addEventListener("click",function(){
  loadLeaderboard();
  showScreen("leaderboard");
});
document.getElementById("btn-lb-back").addEventListener("click",function(){
  if(state==="paused") showScreen("paused");
  else if(state==="gameover") showScreen("gameover");
  else showScreen("title");
});

function loadLeaderboard(){
  var container=document.getElementById("lb-scores");
  container.innerHTML='<div class="lb-loading">Loading...</div>';
  fetch(LEADERBOARD_API+"/leaderboard")
    .then(function(r){return r.json();})
    .then(function(data){
      if(!data.items||data.items.length===0){
        container.innerHTML='<div class="lb-empty">No scores yet.<br>Be the first!</div>';
        return;
      }
      container.innerHTML=data.items.map(function(item,i){
        var cls="lb-row";
        if(i===0) cls+=" lb-top1";
        else if(i===1) cls+=" lb-top2";
        else if(i===2) cls+=" lb-top3";
        return '<div class="'+cls+'">'+
          '<span class="lb-rank">'+item.rank+'</span>'+
          '<span class="lb-name">'+item.playerName+'</span>'+
          '<span class="lb-score">'+item.score+'</span>'+
          '<span class="lb-level">'+item.level+'</span>'+
        '</div>';
      }).join("");
    })
    .catch(function(){
      container.innerHTML='<div class="lb-error">Could not load leaderboard</div>';
    });
}

if(isMobile){
  mobileButtons.forEach(function(mb){
    mb.el.addEventListener("touchstart",function(e){
      e.preventDefault();e.stopPropagation();if(state!=="playing") return;
      if(mb.id==="ml") held.left=true;if(mb.id==="mr") held.right=true;
      if(mb.id==="mj"){held.jump=true;player.jumpBufferTimer=JUMP_BUFFER_MS;}
      if(mb.id==="md") held.dash=true;
    },{passive:false});
    mb.el.addEventListener("touchend",function(e){
      e.preventDefault();e.stopPropagation();
      if(mb.id==="ml") held.left=false;if(mb.id==="mr") held.right=false;
      if(mb.id==="mj") held.jump=false;if(mb.id==="md") held.dash=false;
    },{passive:false});
    mb.el.addEventListener("touchcancel",function(){
      if(mb.id==="ml") held.left=false;if(mb.id==="mr") held.right=false;
      if(mb.id==="mj") held.jump=false;if(mb.id==="md") held.dash=false;
    });
  });
}

// === STOMP HELPERS ===
function checkStomp(enemyTop,enemyLeft,enemyRight){
  if(stompCooldown>0) return false;
  if(player.vy<=0) return false;
  var prevBottom=player.prevY;
  var currBottom=player.y;
  if(prevBottom>enemyTop+2) return false;
  if(currBottom<enemyTop-2) return false;
  var pLeft=player.x-PLAYER_W/2+2;
  var pRight=player.x+PLAYER_W/2-2;
  if(pRight<=enemyLeft+2||pLeft>=enemyRight-2) return false;
  return true;
}

function doStomp(entityX,entityY,entityTop,scoreBonus){
  stompCombo++;
  var multiplier=Math.min(stompCombo,5); // Cap at 5x
  var finalScore=scoreBonus*multiplier;
  score+=finalScore;
  spawnScorePopup(entityX,entityY-10,scoreBonus,multiplier);
  player.vy=STOMP_BOUNCE_VEL;
  player.y=entityTop-1;
  player.onGround=false;
  stompCooldown=STOMP_COOLDOWN;
  stompFlash=0.15;
  playSfx("enemyHit");
  spawnParticles(entityX,entityY,"#ffaa44",12);
  spawnParticles(entityX,entityY,"#ffffff",4);
}

// === UPDATE ===
function update(dt){
  if(state!=="playing") return;
  // Safety check - always trigger game over if lives depleted
  if(player.lives<=0&&state==="playing"){gameOver();return;}
  gameTime+=dt;shimmerOffset+=dt;

  player.prevY=player.y;

  if(player.dashTimer>0) player.dashTimer=Math.max(0,player.dashTimer-dt);
  if(player.invuln>0) player.invuln=Math.max(0,player.invuln-dt);
  if(player.powerTimer>0) player.powerTimer=Math.max(0,player.powerTimer-dt);
  if(player.invincTimer>0) player.invincTimer=Math.max(0,player.invincTimer-dt);
  if(shakeTimer>0) shakeTimer=Math.max(0,shakeTimer-dt);
  if(stompFlash>0) stompFlash=Math.max(0,stompFlash-dt);
  if(stompCooldown>0) stompCooldown=Math.max(0,stompCooldown-dt);
  if(levelTransitionTimer>0) levelTransitionTimer=Math.max(0,levelTransitionTimer-dt);
  if(freqModeTimer>0) freqModeTimer=Math.max(0,freqModeTimer-dt);
  if(spawnPauseTimer>0&&!boss.active) spawnPauseTimer=Math.max(0,spawnPauseTimer-dt);
  if(player.jumpBufferTimer>0) player.jumpBufferTimer=Math.max(0,player.jumpBufferTimer-dt*1000);
  if(player.coyoteTimer>0) player.coyoteTimer=Math.max(0,player.coyoteTimer-dt*1000);

  // Level transition check (based on distance, not score)
  if(level===1&&distance>=LEVEL_2_THRESHOLD){
    level=2;
    levelTransitionTimer=LEVEL_TRANSITION_TIME;
    spawnPauseTimer=SPAWN_PAUSE_TIME;
    lastInvincX=cam.x; // Reset for new level spawn distance
    playLevelMusic(2);
    playSfx("levelUp");
    hudLevel.textContent="LVL 2";
    hudLevel.style.color="#cc88ff";
  }
  // Level 3 transition with long visible pit fall (based on distance)
  if(level===2&&distance>=LEVEL_3_THRESHOLD&&pitFallTimer<=0){
    pitFallTimer=LEVEL_3_TRANSITION_TIME;
    pitFallScroll=0;
    spawnPauseTimer=LEVEL_3_TRANSITION_TIME+1.5; // Extended spawn delay
    level3GraceTimer=LEVEL_3_GRACE_TIME; // Start invuln grace period
    // Clear all projectiles/hazards and enemies from Level 2
    projectiles=[];lasers=[];daggers=[];gooDrops=[];
    enemies=[];fliers=[];droids=[];sandworms=[];bigworms=[];spiders=[];
  }
  if(pitFallTimer>0){
    pitFallTimer-=dt;
    pitFallScroll+=PIT_FALL_SPEED*dt;
    player.vy=0; // Freeze vertical during transition (visual only)
    player.vx=0; // Freeze horizontal during transition
    player.y=GROUND_Y-20; // Keep player centered vertically during fall
    if(pitFallTimer<=0){
      level=3;
      levelTransitionTimer=LEVEL_TRANSITION_TIME;
      playLevelMusic(3);
      playSfx("levelUp");
      // Safe landing: clamp to ground, no velocity
      player.y=GROUND_Y;player.vy=0;player.onGround=true;
      player.invuln=Math.max(player.invuln,0.5); // Extra invuln frames on landing
      hudLevel.textContent="LVL 3";
      hudLevel.style.color="#ff8844";
      pitFallScroll=0;
      spawnPauseTimer=1.5; // Extra spawn delay after landing
      lastInvincX=cam.x; // Reset for new level spawn distance
      // Reset spawn timers to prevent immediate spawns
      bigwormTimer=3+Math.random()*2;
      spiderTimer=2.5+Math.random()*2;
      droidTimer=4+Math.random()*3;
      // Clear any stray projectiles again
      projectiles=[];lasers=[];daggers=[];gooDrops=[];
    }
  }
  // Decrement Level 3 grace timer
  if(level3GraceTimer>0) level3GraceTimer-=dt;

  // Boss spawn trigger - immediately when entering Level 3 (distance 1000)
  if(distance>=BOSS_SPAWN_THRESHOLD&&!bossSpawned&&!boss.active){
    spawnBoss();
  }

  var hasPower=player.powerTimer>0;
  var curMaxRun=hasPower?MAX_RUN*POWER_SPEED_MULT:MAX_RUN;
  var curAccel=hasPower?MOVE_ACCEL*POWER_SPEED_MULT:MOVE_ACCEL;

  // During boss fight: shift shoots laser. Otherwise: dash
  if(held.dash){
    if(boss.active&&!boss.defeated){
      // Boss fight - shoot laser
      if(playerLaserCooldown<=0){
        playerLasers.push({
          x:player.x+player.facing*6,
          y:player.y-10,
          vx:player.facing*PLAYER_LASER_SPEED,
          life:2
        });
        playerLaserCooldown=PLAYER_LASER_COOLDOWN;
        playSfx("playerLaser");
      }
    } else if(player.dashTimer<=0&&player.dashCharges>0){
      // Normal gameplay - dash
      player.dashTimer=DASH_DURATION;
      player.dashCharges--;
      player.dashDir=player.facing;
      playSfx("dash");
      spawnParticles(player.x,player.y-8,C_DASH_READY,6);
      buildDashPips(player.dashCharges,MAX_DASH_CHARGES);
    }
  }

  // Crouch - only on ground, reduces hitbox to duck under projectiles
  player.crouching=held.down&&player.onGround&&player.dashTimer<=0;

  var isDashing=player.dashTimer>0;
  if(isDashing){
    player.vx=DASH_SPEED*player.dashDir;
  } else if(player.crouching){
    // Slow down when crouching
    if(player.vx>0) player.vx=Math.max(0,player.vx-MOVE_DECEL*2*dt);
    else if(player.vx<0) player.vx=Math.min(0,player.vx+MOVE_DECEL*2*dt);
  } else {
    if(held.left){player.vx=Math.max(player.vx-curAccel*dt,-curMaxRun);player.facing=-1;}
    else if(held.right){player.vx=Math.min(player.vx+curAccel*dt,curMaxRun);player.facing=1;}
    else {
      if(player.vx>0) player.vx=Math.max(0,player.vx-MOVE_DECEL*dt);
      else if(player.vx<0) player.vx=Math.min(0,player.vx+MOVE_DECEL*dt);
    }
  }

  var prevY=player.y;
  player.wasOnGround=player.onGround;
  if(!player.onGround) player.vy+=GRAVITY*dt;
  player.y+=player.vy*dt;

  var onSomething=false;
  for(var pi=0;pi<platforms.length;pi++){
    var pl=platforms[pi];
    if(player.x>pl.x-PLAYER_W/2+3&&player.x<pl.x+pl.w+PLAYER_W/2-3){
      if(player.vy>=0&&prevY<=pl.y+2&&player.y>=pl.y){
        player.y=pl.y;player.vy=0;onSomething=true;break;
      }
    }
  }

  if(!onSomething){
    var surfY=groundYAt(player.x);
    if(player.y>=surfY){player.y=surfY;player.vy=0;onSomething=true;}
  }

  if(player.y>=GROUND_Y){player.y=GROUND_Y;player.vy=0;onSomething=true;}

  if(onSomething){
    if(!player.onGround){player.coyoteTimer=COYOTE_MS;spawnDust(player.x,player.y,3);playSfx("land");stompCombo=0;}
    player.onGround=true;
  } else {
    if(player.onGround&&player.vy>=0) player.coyoteTimer=COYOTE_MS;
    player.onGround=false;
  }

  player.x+=player.vx*dt;
  if(player.x<16) player.x=16;
  // Boss arena wall - can't run past the fight
  if(boss.active&&!boss.defeated){
    if(player.x<bossArenaLeft+10){player.x=bossArenaLeft+10;player.vx=0;}
    if(player.x>bossArenaRight-10){player.x=bossArenaRight-10;player.vx=0;}
  }

  if(player.onGround){
    var newSurf=groundYAt(player.x);
    if(newSurf<GROUND_Y) player.y=Math.min(player.y,newSurf);
    else player.y=Math.min(player.y,GROUND_Y);
  }

  var screenX=player.x-cam.x;
  // Lock camera during boss fight
  if(!(boss.active&&!boss.defeated)){
    if(screenX>CAM_RIGHT_MARGIN) cam.x=player.x-CAM_RIGHT_MARGIN;
    else if(screenX<CAM_LEFT_MARGIN) cam.x=player.x-CAM_LEFT_MARGIN;
  }
  if(cam.x<0) cam.x=0;

  // Don't accumulate distance/score during boss fight
  if(player.x>maxX&&!(boss.active&&!boss.defeated)){
    var gained=Math.floor((player.x-maxX)/DIST_PER_POINT);
    if(gained>0){distance+=gained;score+=gained;maxX+=gained*DIST_PER_POINT;}
  }

  var canJump=player.onGround||player.coyoteTimer>0;
  if(player.jumpBufferTimer>0&&canJump){
    player.vy=JUMP_VEL;player.onGround=false;
    player.coyoteTimer=0;player.jumpBufferTimer=0;
    playSfx("jump");
    spawnDust(player.x,player.y,5,"#c8aa88");
  }
  if(!held.jump&&player.vy<JUMP_VEL*0.4) player.vy=JUMP_VEL*0.4;

  if(player.onGround&&Math.abs(player.vx)>40){
    player.runDust+=dt;
    if(player.runDust>0.1){player.runDust=0;spawnDust(player.x-player.facing*4,player.y,1);}
  } else player.runDust=0;

  if(hasPower&&Math.random()<0.3){
    particles.push({x:player.x-player.facing*6,y:player.y-8,vx:(Math.random()-0.5)*20,vy:-Math.random()*15,
      life:0.2+Math.random()*0.2,color:C_POWER,size:1});
  }

  if(hasInvinc&&Math.random()<0.4){
    particles.push({x:player.x+(Math.random()-0.5)*12,y:player.y-8+(Math.random()-0.5)*12,
      vx:(Math.random()-0.5)*30,vy:-Math.random()*20-5,
      life:0.25+Math.random()*0.2,color:Math.random()<0.5?C_INVINC:"#ffffff",size:1+Math.floor(Math.random()*2)});
  }

  if(!player.onGround){player.animFrame=4;}
  else if(Math.abs(player.vx)>10){
    player.animTimer+=dt;
    if(player.animTimer>0.1){player.animTimer=0;player.animFrame=(player.animFrame+1)%4;}
  } else {player.animFrame=0;player.animTimer=0;}

  generateWorld(cam.x+W+500);

  // Spawning based on level (Level 3 cave has no ships/sandworms)
  spawnTimer-=dt;
  if(spawnTimer<=0){
    spawnTimer=Math.max(SPAWN_BASE-gameTime*SPAWN_RAMP,SPAWN_MIN);
    if(level===1){
      spawnEnemy();
      if(gameTime>30&&Math.random()<0.2) spawnEnemy();
    } else if(level===2){
      // Level 2: fewer ships, add fliers/droids
      if(Math.random()<0.3) spawnEnemy();
    }
    // Level 3: no ships spawn in the cave
  }

  // Sandworms only in Level 1 and 2 (surface levels)
  if(gameTime>SAFE_START&&level!==3){
    wormTimer-=dt;
    if(wormTimer<=0){
      wormTimer=WORM_MIN_INTERVAL+Math.random()*(WORM_MAX_INTERVAL-WORM_MIN_INTERVAL);
      wormTimer=Math.max(8,wormTimer-gameTime*0.05);
      spawnSandworm();
    }
  }

  // Level 2 enemies
  if(level===2){
    flierTimer-=dt;
    if(flierTimer<=0){
      flierTimer=4+Math.random()*4;
      spawnFlier();
    }
    droidTimer-=dt;
    if(droidTimer<=0){
      droidTimer=6+Math.random()*5;
      spawnDroid();
    }
  }

  // Level 3 enemies (cave only: big worms, spiders, red droids - NO ships/fliers)
  // PROGRESSIVE DIFFICULTY: +10% every 200 distance past 1000
  if(level===3){
    var distPast1000=Math.max(0,distance-LEVEL_3_THRESHOLD);
    var difficultyMult=1+Math.floor(distPast1000/200)*0.1; // 1.0, 1.1, 1.2, etc.
    var spawnMult=1/difficultyMult; // Faster spawns = shorter timers

    bigwormTimer-=dt;
    if(bigwormTimer<=0){
      bigwormTimer=(2.0+Math.random()*1.5)*spawnMult;
      spawnBigworm();
    }
    spiderTimer-=dt;
    if(spiderTimer<=0){
      spiderTimer=(1.5+Math.random()*1.5)*spawnMult;
      spawnSpider();
    }
    // Red droids with increased fire rate - spawn more often
    droidTimer-=dt;
    if(droidTimer<=0){
      droidTimer=(2.5+Math.random()*2)*spawnMult;
      spawnDroid();
    }
  }

  // Props
  var lastPropX=props.length>0?props[props.length-1].x:0;
  if(lastPropX<cam.x+W+200){
    var npx=lastPropX+40+Math.random()*50;
    var t2=Math.random();
    var visibleAntennas=0;
    for(var ai=0;ai<props.length;ai++){
      if(props[ai].type==="antenna"){
        var asx=props[ai].x-cam.x;
        if(asx>-20&&asx<W+20) visibleAntennas++;
      }
    }
    var lastAntennaX=0;
    for(var aj=props.length-1;aj>=0;aj--){
      if(props[aj].type==="antenna"){lastAntennaX=props[aj].x;break;}
    }
    if(t2<0.08&&visibleAntennas<2&&(npx-lastAntennaX)>200){
      props.push({x:npx,type:"antenna",h:8+Math.floor(Math.random()*8)});
    } else if(t2<0.35){
      props.push({x:npx,type:"panel",w:5+Math.floor(Math.random()*4),h:3+Math.floor(Math.random()*2)});
    } else if(t2<0.6){
      props.push({x:npx,type:"wreck",w:6+Math.floor(Math.random()*5)});
    } else {
      props.push({x:npx,type:"dome",r:3+Math.floor(Math.random()*3)});
    }
  }
  var lastDomeX=glowDomes.length>0?glowDomes[glowDomes.length-1].x:0;
  if(lastDomeX<cam.x+W+150) glowDomes.push({x:lastDomeX+60+Math.random()*80,r:4+Math.random()*5});

  var hasInvinc=player.invincTimer>0;
  var inGracePeriod=level3GraceTimer>0||pitFallTimer>0;
  var isInvuln=player.invuln>0||isDashing||hasPower||hasInvinc||inGracePeriod;
  var pHeight=player.crouching?CROUCH_HEIGHT:PLAYER_H;
  var pr={x:player.x-PLAYER_W/2+HIT_SHRINK,y:player.y-pHeight+HIT_SHRINK,
    w:PLAYER_W-HIT_SHRINK*2,h:pHeight-HIT_SHRINK*2};

  // Ships
  for(var i=enemies.length-1;i>=0;i--){
    var en=enemies[i];
    en.age+=dt;en.x+=en.vx*dt;
    if(en.pattern==="sine") en.y=en.baseY+Math.sin(en.age*SHIP_SINE_FREQ)*SHIP_SINE_AMP;
    en.fireTimer-=dt;
    if(en.fireTimer<=SHIP_FIRE_TELEGRAPH&&!en.telegraphing){
      en.telegraphing=true;en.telegraphTimer=SHIP_FIRE_TELEGRAPH;
    }
    if(en.telegraphing){
      en.telegraphTimer-=dt;
      if(en.telegraphTimer<=0){
        en.telegraphing=false;
        en.fireTimer=SHIP_FIRE_INTERVAL+Math.random()*1.5;
        if(projectiles.length<MAX_PROJECTILES){
          projectiles.push({x:en.x,y:en.y+4,vx:-PROJ_SPEED*0.6,vy:PROJ_SPEED*0.5,life:4});
        }
      }
    }
    if(en.x<cam.x-100||en.x>cam.x+W+200){enemies.splice(i,1);continue;}
    var ex=en.x-en.w/2+HIT_SHRINK,ey=en.y-en.h/2+HIT_SHRINK;
    var ew=en.w-HIT_SHRINK*2,eh=en.h-HIT_SHRINK*2;
    var shipTop=en.y-en.h/2;
    var shipLeft=en.x-en.w/2,shipRight=en.x+en.w/2;
    if(checkStomp(shipTop,shipLeft,shipRight)){
      doStomp(en.x,en.y,shipTop,STOMP_SHIP_SCORE);
      enemies.splice(i,1);continue;
    }
    if(rectsOverlap(pr.x,pr.y,pr.w,pr.h,ex,ey,ew,eh)){
      if(hasInvinc){
        // Invincible player destroys enemy on contact
        score+=STOMP_SHIP_SCORE;
        spawnScorePopup(en.x,en.y-10,STOMP_SHIP_SCORE,1);
        spawnParticles(en.x,en.y,C_INVINC,8);
        spawnParticles(en.x,en.y,"#ffffff",4);
        enemies.splice(i,1);continue;
      } else if(!isInvuln){
        player.lives--;player.invuln=INVULN_TIME;shakeTimer=0.3;playSfx("playerHit");
        spawnParticles(en.x,en.y,C_SHIP_GLOW,10);enemies.splice(i,1);
        buildHearts(player.lives,Math.max(MAX_LIVES,player.lives));
        if(player.lives<=0){gameOver();return;}
      }
    }
  }

  // Projectiles
  for(var pi2=projectiles.length-1;pi2>=0;pi2--){
    var proj=projectiles[pi2];
    proj.x+=proj.vx*dt;proj.y+=proj.vy*dt;proj.life-=dt;
    if(proj.life<=0||proj.x<cam.x-40||proj.y>GROUND_Y+10){projectiles.splice(pi2,1);continue;}
    if(hasInvinc&&rectsOverlap(pr.x,pr.y,pr.w,pr.h,proj.x-3,proj.y-3,6,6)){
      spawnParticles(proj.x,proj.y,C_INVINC,4);projectiles.splice(pi2,1);continue;
    }
    if(!isInvuln&&rectsOverlap(pr.x,pr.y,pr.w,pr.h,proj.x-3,proj.y-3,6,6)){
      player.lives--;player.invuln=INVULN_TIME;shakeTimer=0.2;playSfx("playerHit");
      spawnParticles(proj.x,proj.y,C_PROJ,6);projectiles.splice(pi2,1);
      buildHearts(player.lives,Math.max(MAX_LIVES,player.lives));
      if(player.lives<=0){gameOver();return;}
    }
  }

  // Sandworms
  for(var wi=sandworms.length-1;wi>=0;wi--){
    var wm=sandworms[wi];
    if(wm.state==="telegraph"){
      wm.timer-=dt;
      if(Math.random()<0.4){
        particles.push({x:wm.x+(Math.random()-0.5)*20,y:GROUND_Y-1,
          vx:(Math.random()-0.5)*15,vy:-Math.random()*20-5,
          life:0.2+Math.random()*0.15,color:"#c8a878",size:1});
      }
      if(wm.timer<=0) wm.state="active";
    } else if(wm.state==="active"){
      wm.x+=wm.vx*dt;
      if(Math.random()<0.5){
        particles.push({x:wm.x+wm.length/2,y:GROUND_Y-2,
          vx:(Math.random()-0.5)*10,vy:-Math.random()*15,
          life:0.15+Math.random()*0.1,color:"#b89868",size:1});
      }
      var wmLeft=wm.x-wm.length/2,wmRight=wm.x+wm.length/2,wmTop=GROUND_Y-10;
      if(checkStomp(wmTop,wmLeft,wmRight)){
        doStomp(wm.x,GROUND_Y-5,wmTop,STOMP_WORM_SCORE);
        spawnParticles(wm.x,GROUND_Y-4,"#c8a878",8);
        sandworms.splice(wi,1);continue;
      }
      if(rectsOverlap(pr.x,pr.y,pr.w,pr.h,wmLeft,wmTop,wm.length,10)){
        if(hasInvinc){
          score+=STOMP_WORM_SCORE;
          spawnScorePopup(wm.x,GROUND_Y-15,STOMP_WORM_SCORE,1);
          spawnParticles(wm.x,GROUND_Y-4,C_INVINC,10);
          spawnParticles(wm.x,GROUND_Y-4,"#ffffff",5);
          sandworms.splice(wi,1);continue;
        } else if(!isInvuln){
          player.lives--;player.invuln=INVULN_TIME;shakeTimer=0.3;playSfx("playerHit");
          spawnParticles(wm.x,GROUND_Y-4,"#c8a878",8);
          buildHearts(player.lives,Math.max(MAX_LIVES,player.lives));
          if(player.lives<=0){gameOver();return;}
        }
      }
      if(wm.x<cam.x-100){sandworms.splice(wi,1);continue;}
    }
    if(wm.x<cam.x-200||wm.x>cam.x+W+300){sandworms.splice(wi,1);}
  }

  // Fliers (Level 2)
  for(var fi=fliers.length-1;fi>=0;fi--){
    var fl=fliers[fi];
    fl.age+=dt;fl.x+=fl.vx*dt;
    fl.y=fl.baseY+Math.sin(fl.age*FLIER_SINE_FREQ)*FLIER_SINE_AMP;
    fl.dropTimer-=dt;
    if(fl.dropTimer<=FLIER_DROP_TELEGRAPH&&!fl.telegraphing){
      fl.telegraphing=true;fl.telegraphTimer=FLIER_DROP_TELEGRAPH;
    }
    if(fl.telegraphing){
      fl.telegraphTimer-=dt;
      if(fl.telegraphTimer<=0){
        fl.telegraphing=false;
        fl.dropTimer=FLIER_DROP_INTERVAL+Math.random()*1.5;
        if(drops.length<MAX_DROPS){
          drops.push({x:fl.x,y:fl.y+4,vy:0,age:0});
        }
      }
    }
    if(fl.x<cam.x-100||fl.x>cam.x+W+200){fliers.splice(fi,1);continue;}
    var flTop=fl.y-fl.h/2,flLeft=fl.x-fl.w/2,flRight=fl.x+fl.w/2;
    var fx2=fl.x-fl.w/2+2,fy2=fl.y-fl.h/2+2,fw2=fl.w-4,fh2=fl.h-4;
    if(checkStomp(flTop,flLeft,flRight)){
      doStomp(fl.x,fl.y,flTop,STOMP_FLIER_SCORE);
      fliers.splice(fi,1);continue;
    }
    if(rectsOverlap(pr.x,pr.y,pr.w,pr.h,fx2,fy2,fw2,fh2)){
      if(hasInvinc){
        score+=STOMP_FLIER_SCORE;
        spawnScorePopup(fl.x,fl.y-10,STOMP_FLIER_SCORE,1);
        spawnParticles(fl.x,fl.y,C_INVINC,8);
        spawnParticles(fl.x,fl.y,"#ffffff",4);
        fliers.splice(fi,1);continue;
      } else if(!isInvuln){
        player.lives--;player.invuln=INVULN_TIME;shakeTimer=0.3;playSfx("playerHit");
        spawnParticles(fl.x,fl.y,C_FLIER_BODY,8);fliers.splice(fi,1);
        buildHearts(player.lives,Math.max(MAX_LIVES,player.lives));
        if(player.lives<=0){gameOver();return;}
      }
    }
  }

  // Drops (from fliers)
  for(var di=drops.length-1;di>=0;di--){
    var dr=drops[di];
    dr.age+=dt;
    dr.vy+=DROP_GRAVITY*dt;
    dr.y+=dr.vy*dt;
    if(dr.y>GROUND_Y+10){drops.splice(di,1);continue;}
    if(hasInvinc&&rectsOverlap(pr.x,pr.y,pr.w,pr.h,dr.x-4,dr.y-4,8,8)){
      spawnParticles(dr.x,dr.y,C_INVINC,4);drops.splice(di,1);continue;
    }
    if(!isInvuln&&rectsOverlap(pr.x,pr.y,pr.w,pr.h,dr.x-4,dr.y-4,8,8)){
      player.lives--;player.invuln=INVULN_TIME;shakeTimer=0.2;playSfx("playerHit");
      spawnParticles(dr.x,dr.y,C_DROP,6);drops.splice(di,1);
      buildHearts(player.lives,Math.max(MAX_LIVES,player.lives));
      if(player.lives<=0){gameOver();return;}
    }
  }

  // Droids (Level 2 and 3 - more aggressive in L3)
  var droidFireInt=level===3?DROID_L3_FIRE_INTERVAL:DROID_FIRE_INTERVAL;
  var maxLasersNow=level===3?MAX_LASERS_L3:MAX_LASERS;
  for(var dri=droids.length-1;dri>=0;dri--){
    var drd=droids[dri];
    drd.x+=drd.vx*dt;
    if(drd.x>drd.patrolStart+DROID_PATROL_DIST) drd.vx=-DROID_SPEED;
    else if(drd.x<drd.patrolStart-DROID_PATROL_DIST) drd.vx=DROID_SPEED;
    drd.y=groundYAt(drd.x);
    drd.fireTimer-=dt;
    if(drd.fireTimer<=DROID_FIRE_TELEGRAPH&&!drd.telegraphing){
      drd.telegraphing=true;drd.telegraphTimer=DROID_FIRE_TELEGRAPH;
    }
    if(drd.telegraphing){
      drd.telegraphTimer-=dt;
      if(drd.telegraphTimer<=0){
        drd.telegraphing=false;
        drd.fireTimer=droidFireInt+Math.random()*1.0;
        if(lasers.length<maxLasersNow){
          var laserDir=player.x<drd.x?-1:1;
          lasers.push({x:drd.x+laserDir*5,y:drd.y-6,vx:laserDir*LASER_SPEED,life:3});
        }
      }
    }
    if(drd.x<cam.x-100||drd.x>cam.x+W+200){droids.splice(dri,1);continue;}
    var drTop=drd.y-drd.h,drLeft=drd.x-drd.w/2,drRight=drd.x+drd.w/2;
    var drx2=drLeft+2,dry2=drTop+2,drw2=drd.w-4,drh2=drd.h-4;
    if(checkStomp(drTop,drLeft,drRight)){
      doStomp(drd.x,drd.y-drd.h/2,drTop,STOMP_DROID_SCORE);
      droids.splice(dri,1);continue;
    }
    if(rectsOverlap(pr.x,pr.y,pr.w,pr.h,drx2,dry2,drw2,drh2)){
      if(hasInvinc){
        score+=STOMP_DROID_SCORE;
        spawnScorePopup(drd.x,drd.y-16,STOMP_DROID_SCORE,1);
        spawnParticles(drd.x,drd.y-6,C_INVINC,8);
        spawnParticles(drd.x,drd.y-6,"#ffffff",4);
        droids.splice(dri,1);continue;
      } else if(!isInvuln){
        player.lives--;player.invuln=INVULN_TIME;shakeTimer=0.3;playSfx("playerHit");
        spawnParticles(drd.x,drd.y-6,C_DROID_BODY,10);droids.splice(dri,1);
        buildHearts(player.lives,Math.max(MAX_LIVES,player.lives));
        if(player.lives<=0){gameOver();return;}
      }
    }
  }

  // Lasers (from droids)
  for(var li=lasers.length-1;li>=0;li--){
    var las=lasers[li];
    las.x+=las.vx*dt;las.life-=dt;
    if(las.life<=0||las.x<cam.x-40||las.x>cam.x+W+40){lasers.splice(li,1);continue;}
    if(hasInvinc&&rectsOverlap(pr.x,pr.y,pr.w,pr.h,las.x-6,las.y-2,12,4)){
      spawnParticles(las.x,las.y,C_INVINC,4);lasers.splice(li,1);continue;
    }
    if(!isInvuln&&rectsOverlap(pr.x,pr.y,pr.w,pr.h,las.x-6,las.y-2,12,4)){
      player.lives--;player.invuln=INVULN_TIME;shakeTimer=0.2;playSfx("playerHit");
      spawnParticles(las.x,las.y,C_LASER,6);lasers.splice(li,1);
      buildHearts(player.lives,Math.max(MAX_LIVES,player.lives));
      if(player.lives<=0){gameOver();return;}
    }
  }

  // Big Worms (Level 3) - shoot daggers
  for(var bwi=bigworms.length-1;bwi>=0;bwi--){
    var bw=bigworms[bwi];
    bw.x+=bw.vx*dt;
    bw.fireTimer-=dt;
    if(bw.fireTimer<=BIGWORM_FIRE_TELEGRAPH&&!bw.telegraphing){
      bw.telegraphing=true;bw.telegraphTimer=BIGWORM_FIRE_TELEGRAPH;
    }
    if(bw.telegraphing){
      bw.telegraphTimer-=dt;
      if(bw.telegraphTimer<=0){
        bw.telegraphing=false;
        bw.fireTimer=BIGWORM_FIRE_INTERVAL+Math.random()*1.0;
        if(daggers.length<MAX_DAGGERS){
          var ddir=player.x<bw.x?-1:1;
          daggers.push({x:bw.x+ddir*10,y:GROUND_Y-8,vx:ddir*DAGGER_SPEED,vy:-30,life:3});
        }
      }
    }
    if(bw.x<cam.x-150){bigworms.splice(bwi,1);continue;}
    var bwLeft=bw.x-bw.length/2,bwRight=bw.x+bw.length/2,bwTop=GROUND_Y-14;
    if(checkStomp(bwTop,bwLeft,bwRight)){
      doStomp(bw.x,GROUND_Y-7,bwTop,STOMP_BIGWORM_SCORE);
      spawnParticles(bw.x,GROUND_Y-6,C_BIGWORM,10);
      bigworms.splice(bwi,1);continue;
    }
    if(rectsOverlap(pr.x,pr.y,pr.w,pr.h,bwLeft,bwTop,bw.length,14)){
      if(hasInvinc){
        score+=STOMP_BIGWORM_SCORE;
        spawnScorePopup(bw.x,GROUND_Y-20,STOMP_BIGWORM_SCORE,1);
        spawnParticles(bw.x,GROUND_Y-6,C_INVINC,10);
        bigworms.splice(bwi,1);continue;
      } else if(!isInvuln){
        player.lives--;player.invuln=INVULN_TIME;shakeTimer=0.3;playSfx("playerHit");
        spawnParticles(bw.x,GROUND_Y-6,C_BIGWORM,8);
        buildHearts(player.lives,Math.max(MAX_LIVES,player.lives));
        if(player.lives<=0){gameOver();return;}
      }
    }
  }

  // Daggers (from big worms)
  for(var dgi=daggers.length-1;dgi>=0;dgi--){
    var dg=daggers[dgi];
    dg.x+=dg.vx*dt;dg.vy+=150*dt;dg.y+=dg.vy*dt;dg.life-=dt;
    if(dg.life<=0||dg.x<cam.x-40||dg.y>GROUND_Y+10){daggers.splice(dgi,1);continue;}
    if(hasInvinc&&rectsOverlap(pr.x,pr.y,pr.w,pr.h,dg.x-4,dg.y-4,8,8)){
      spawnParticles(dg.x,dg.y,C_INVINC,4);daggers.splice(dgi,1);continue;
    }
    if(!isInvuln&&rectsOverlap(pr.x,pr.y,pr.w,pr.h,dg.x-4,dg.y-4,8,8)){
      player.lives--;player.invuln=INVULN_TIME;shakeTimer=0.2;playSfx("playerHit");
      spawnParticles(dg.x,dg.y,C_DAGGER,6);daggers.splice(dgi,1);
      buildHearts(player.lives,Math.max(MAX_LIVES,player.lives));
      if(player.lives<=0){gameOver();return;}
    }
  }

  // Spiders (Level 3) - ceiling crawlers that drop goo
  for(var spi=spiders.length-1;spi>=0;spi--){
    var sp=spiders[spi];
    sp.x+=sp.vx*dt;
    sp.dropTimer-=dt;
    if(sp.dropTimer<=SPIDER_DROP_TELEGRAPH&&!sp.telegraphing){
      sp.telegraphing=true;sp.telegraphTimer=SPIDER_DROP_TELEGRAPH;
    }
    if(sp.telegraphing){
      sp.telegraphTimer-=dt;
      if(sp.telegraphTimer<=0){
        sp.telegraphing=false;
        sp.dropTimer=SPIDER_DROP_INTERVAL+Math.random()*1.5;
        if(gooDrops.length<MAX_GOO){
          gooDrops.push({x:sp.x,y:sp.y+4,vy:0});
        }
      }
    }
    if(sp.x<cam.x-80||sp.x>cam.x+W+150){spiders.splice(spi,1);continue;}
    var spTop=sp.y-sp.h/2,spLeft=sp.x-sp.w/2,spRight=sp.x+sp.w/2;
    var spx2=sp.x-sp.w/2+2,spy2=sp.y-sp.h/2+2,spw2=sp.w-4,sph2=sp.h-4;
    // Can't stomp ceiling spiders easily, but if you jump into them...
    if(rectsOverlap(pr.x,pr.y,pr.w,pr.h,spx2,spy2,spw2,sph2)){
      if(hasInvinc){
        score+=STOMP_SPIDER_SCORE;
        spawnScorePopup(sp.x,sp.y-10,STOMP_SPIDER_SCORE,1);
        spawnParticles(sp.x,sp.y,C_INVINC,8);
        spiders.splice(spi,1);continue;
      } else if(!isInvuln){
        player.lives--;player.invuln=INVULN_TIME;shakeTimer=0.3;playSfx("playerHit");
        spawnParticles(sp.x,sp.y,C_SPIDER,8);spiders.splice(spi,1);
        buildHearts(player.lives,Math.max(MAX_LIVES,player.lives));
        if(player.lives<=0){gameOver();return;}
      }
    }
  }

  // Goo drops (from spiders)
  for(var gi=gooDrops.length-1;gi>=0;gi--){
    var goo=gooDrops[gi];
    goo.vy+=GOO_GRAVITY*dt;
    goo.y+=goo.vy*dt;
    if(goo.y>GROUND_Y+10){gooDrops.splice(gi,1);continue;}
    if(hasInvinc&&rectsOverlap(pr.x,pr.y,pr.w,pr.h,goo.x-5,goo.y-5,10,10)){
      spawnParticles(goo.x,goo.y,C_INVINC,4);gooDrops.splice(gi,1);continue;
    }
    if(!isInvuln&&rectsOverlap(pr.x,pr.y,pr.w,pr.h,goo.x-5,goo.y-5,10,10)){
      player.lives--;player.invuln=INVULN_TIME;shakeTimer=0.2;playSfx("playerHit");
      spawnParticles(goo.x,goo.y,C_GOO,6);gooDrops.splice(gi,1);
      buildHearts(player.lives,Math.max(MAX_LIVES,player.lives));
      if(player.lives<=0){gameOver();return;}
    }
  }

  // Pickups
  for(var hi=heartPickups.length-1;hi>=0;hi--){
    var hp=heartPickups[hi];hp.bob+=dt*3;
    if(hp.x<cam.x-80){heartPickups.splice(hi,1);continue;}
    var hpY=hp.y+Math.sin(hp.bob)*2;
    if(rectsOverlap(pr.x,pr.y,pr.w,pr.h,hp.x-5,hpY-5,10,10)){
      player.lives=Math.min(LIVES_CAP,player.lives+1);
      buildHearts(player.lives,Math.max(MAX_LIVES,player.lives));
      score+=SCORE_ITEM_PICKUP;
      spawnScorePopup(hp.x,hpY-10,SCORE_ITEM_PICKUP,1);
      playSfx("pickupHeart");
      spawnParticles(hp.x,hpY,C_HEART_PU,10);
      heartPickups.splice(hi,1);
    }
  }

  for(var pc=powerCells.length-1;pc>=0;pc--){
    var pw=powerCells[pc];pw.bob+=dt*3;
    if(pw.x<cam.x-80){powerCells.splice(pc,1);continue;}
    var pwY=pw.y+Math.sin(pw.bob)*2;
    if(rectsOverlap(pr.x,pr.y,pr.w,pr.h,pw.x-5,pwY-5,10,10)){
      player.powerTimer=POWER_DURATION;
      player.dashCharges=Math.min(MAX_DASH_CHARGES,player.dashCharges+1);
      buildDashPips(player.dashCharges,MAX_DASH_CHARGES);
      score+=SCORE_ITEM_PICKUP;
      spawnScorePopup(pw.x,pwY-10,SCORE_ITEM_PICKUP,1);
      playSfx("pickupPower");
      spawnParticles(pw.x,pwY,C_POWER,12);
      powerCells.splice(pc,1);
    }
  }

  // Invincibility pickups
  for(var iv=invincPickups.length-1;iv>=0;iv--){
    var inp=invincPickups[iv];inp.bob+=dt*4;
    if(inp.x<cam.x-80){invincPickups.splice(iv,1);continue;}
    var inpY=inp.y+Math.sin(inp.bob)*3;
    if(rectsOverlap(pr.x,pr.y,pr.w,pr.h,inp.x-6,inpY-6,12,12)){
      player.invincTimer=INVINC_DURATION;
      freqModeTimer=FREQ_MODE_MSG_TIME;
      score+=SCORE_ITEM_PICKUP;
      spawnScorePopup(inp.x,inpY-10,SCORE_ITEM_PICKUP,1);
      playSfx("pickupInvinc");
      spawnParticles(inp.x,inpY,C_INVINC,16);
      spawnParticles(inp.x,inpY,"#ffffff",8);
      invincPickups.splice(iv,1);
    }
  }

  // Boss updates
  if(boss.active){
    updateBoss(dt);
    updateBossProjectiles(dt);
    updatePlayerLasers(dt);
    checkBossCollision();
    if(player.lives<=0){gameOver();return;}
  }

  // Cleanup
  while(platforms.length>0&&platforms[0].x+platforms[0].w<cam.x-120) platforms.shift();
  while(terrainDunes.length>0&&terrainDunes[0].x+terrainDunes[0].w<cam.x-120) terrainDunes.shift();
  while(props.length>0&&props[0].x<cam.x-60) props.shift();
  while(glowDomes.length>0&&glowDomes[0].x<cam.x-60) glowDomes.shift();

  for(var m=particles.length-1;m>=0;m--){
    var pt=particles[m];
    pt.x+=pt.vx*dt;pt.y+=pt.vy*dt;pt.vy+=150*dt;pt.life-=dt;
    if(pt.life<=0) particles.splice(m,1);
  }

  // Score popups float up and fade
  for(var sp=scorePopups.length-1;sp>=0;sp--){
    var pop=scorePopups[sp];
    pop.y-=30*dt; // Float up
    pop.timer-=dt;
    if(pop.timer<=0) scorePopups.splice(sp,1);
  }

  for(var ss=0;ss<sandSpecs.length;ss++){
    var sp=sandSpecs[ss];
    if(sp.x<cam.x-40){sp.x=cam.x+W+Math.random()*100;sp.y=GROUND_Y+2+Math.random()*25;}
    else if(sp.x>cam.x+W+120){sp.x=cam.x-20-Math.random()*40;sp.y=GROUND_Y+2+Math.random()*25;}
  }

  // DOM HUD - show score (distance + bonuses) and distance
  hudCenter.textContent="SCORE: "+score+" | DIST: "+distance;
  hudHi.textContent="HI: "+bestScore;
  if(player.invuln>0&&gameTime<SAFE_START+0.5) hudSafe.style.display="block";
  else hudSafe.style.display="none";
  if(hasPower){
    hudPower.classList.add("visible");
    hudPowerFill.style.width=Math.floor((player.powerTimer/POWER_DURATION)*100)+"%";
  } else {
    hudPower.classList.remove("visible");
  }
}

function gameOver(){
  state="gameover";
  stopLevelMusic();
  playSfx("gameOver");
  scoreSubmitted=false;
  if(score>bestScore){bestScore=score;localStorage.setItem("freqfx_best",bestScore.toString());}
  goScore.textContent="SCORE: "+score;
  if(score>=bestScore&&score>0){goBest.className="ov-go-best";goBest.textContent="NEW BEST!";}
  else{goBest.className="ov-go-best-dim";goBest.textContent="BEST: "+bestScore;}
  titleBest.textContent="BEST: "+bestScore;
  // Reset leaderboard UI
  var lbSubmit=document.getElementById("leaderboard-submit");
  var lbStatus=document.getElementById("leaderboard-status");
  var lbInput=document.getElementById("lb-name-input");
  lbSubmit.classList.add("ov-hidden");
  lbStatus.textContent="";
  lbStatus.className="ov-lb-status";
  lbInput.value=localStorage.getItem("freqfx_name")||"";
  // Check if score qualifies for leaderboard
  checkLeaderboardQualify(score);
  showScreen("gameover");
  try{window.parent.postMessage({type:"FREQFX_GAME_OVER",score:score,best:bestScore},"*");}catch(e){}
}

// === LEADERBOARD FUNCTIONS ===
function checkLeaderboardQualify(playerScore){
  if(playerScore<10) return; // Minimum score to qualify
  var lbSubmit=document.getElementById("leaderboard-submit");
  var lbStatus=document.getElementById("leaderboard-status");
  lbStatus.textContent="Checking leaderboard...";
  fetch(LEADERBOARD_API+"/leaderboard")
    .then(function(r){return r.json();})
    .then(function(data){
      leaderboardCache=data.items||[];
      var qualifies=leaderboardCache.length<50||playerScore>leaderboardCache[leaderboardCache.length-1].score;
      if(qualifies){
        lbSubmit.classList.remove("ov-hidden");
        lbStatus.textContent="You made the top 50!";
      } else {
        lbStatus.textContent="";
      }
    })
    .catch(function(){
      // If fetch fails, still allow submission
      lbSubmit.classList.remove("ov-hidden");
      lbStatus.textContent="";
    });
}

function submitScore(playerName,playerScore){
  var lbStatus=document.getElementById("leaderboard-status");
  var lbSubmit=document.getElementById("leaderboard-submit");
  if(scoreSubmitted){lbStatus.textContent="Already submitted!";return;}
  if(!playerName||playerName.trim().length===0){
    lbStatus.textContent="Enter a name!";
    lbStatus.className="ov-lb-status error";
    return;
  }
  if(isNameBanned(playerName)){
    lbStatus.textContent="Invalid name!";
    lbStatus.className="ov-lb-status error";
    return;
  }
  lbStatus.textContent="Submitting...";
  lbStatus.className="ov-lb-status";
  localStorage.setItem("freqfx_name",playerName.trim());
  fetch(LEADERBOARD_API+"/submitScore",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({playerName:playerName.trim().toUpperCase(),score:playerScore,level:level})
  })
    .then(function(r){
      if(!r.ok){
        console.error("Leaderboard HTTP error:",r.status,r.statusText);
        throw new Error("HTTP "+r.status);
      }
      return r.json();
    })
    .then(function(data){
      console.log("Leaderboard response:",data);
      if(data.success){
        scoreSubmitted=true;
        lbSubmit.classList.add("ov-hidden");
        lbStatus.textContent="Score submitted!";
        lbStatus.className="ov-lb-status";
      } else if(data.message){
        // Show server message (e.g. "You already have a higher score")
        lbStatus.textContent=data.message;
        lbStatus.className="ov-lb-status";
      } else if(data.error){
        console.error("Leaderboard error:",data.error);
        lbStatus.textContent=data.error;
        lbStatus.className="ov-lb-status error";
      } else {
        console.error("Unexpected response format:",JSON.stringify(data));
        lbStatus.textContent="Error submitting";
        lbStatus.className="ov-lb-status error";
      }
    })
    .catch(function(err){
      console.error("Leaderboard fetch error:",err);
      lbStatus.textContent="Connection error";
      lbStatus.className="ov-lb-status error";
    });
}

// === DRAW ===
function F(v){return Math.floor(v);}
function R(x,y,w,h,c){ctx.fillStyle=c;ctx.fillRect(F(x),F(y),w,h);}
function wxf(worldX){return worldX-cam.x;}

function drawShadow(sx,sy,w){
  if(level===1){
    // Enhanced shadow with gradient for Level 1
    ctx.globalAlpha=0.08;ctx.fillStyle="#4a3020";
    ctx.beginPath();ctx.ellipse(F(sx+1),F(sy+1),w*1.3,3,0,0,6.29);ctx.fill();
    ctx.globalAlpha=0.2;ctx.fillStyle="#3a2010";
    ctx.beginPath();ctx.ellipse(F(sx),F(sy),w,2.5,0,0,6.29);ctx.fill();
    ctx.globalAlpha=0.12;ctx.fillStyle="#000";
    ctx.beginPath();ctx.ellipse(F(sx),F(sy),w*0.7,2,0,0,6.29);ctx.fill();
  } else {
    ctx.globalAlpha=0.15;ctx.fillStyle="#000";
    ctx.beginPath();ctx.ellipse(F(sx),F(sy),w,2,0,0,6.29);ctx.fill();
  }
  ctx.globalAlpha=1;
}

// Cave ceiling stalactites and rock formations (Level 3)
function drawCaveCeiling(){
  var scrollX=cam.x*0.05; // Slow parallax for depth
  // Dark rock layer at very top
  R(0,0,W,18,"#0a0604");
  // Irregular stalactites along ceiling
  ctx.fillStyle="#1a1008";
  for(var i=0;i<20;i++){
    var seed=i*73+13;
    var bx=(i*20+((seed*7)%15)-scrollX*0.3)%W;
    if(bx<-15) bx+=W+30;
    var bh=8+((seed*11)%12);
    ctx.beginPath();
    ctx.moveTo(bx-4-((seed*3)%4),15);
    ctx.lineTo(bx+((seed*5)%3)-1,15+bh);
    ctx.lineTo(bx+4+((seed*2)%4),15);
    ctx.fill();
  }
  // Shorter stalactites layer
  ctx.fillStyle="#241810";
  for(var i=0;i<25;i++){
    var seed=i*97+31;
    var bx=(i*16+((seed*5)%12)-scrollX*0.4)%W;
    if(bx<-12) bx+=W+24;
    var bh=5+((seed*7)%8);
    ctx.beginPath();
    ctx.moveTo(bx-3,12);
    ctx.lineTo(bx,12+bh);
    ctx.lineTo(bx+3,12);
    ctx.fill();
  }
  // Rock edge along top
  ctx.fillStyle="#0d0805";
  ctx.beginPath();
  ctx.moveTo(0,16);
  for(var x=0;x<=W;x+=8){
    var seed=x*47+F(scrollX*0.2);
    var yoff=2+((seed*13)%5);
    ctx.lineTo(x,16+yoff);
  }
  ctx.lineTo(W,0);ctx.lineTo(0,0);
  ctx.fill();
  // Darker edge highlight
  ctx.strokeStyle="#060402";ctx.lineWidth=1;
  ctx.beginPath();
  ctx.moveTo(0,18);
  for(var x=0;x<=W;x+=6){
    var seed=x*53+F(scrollX*0.15);
    var yoff=1+((seed*11)%4);
    ctx.lineTo(x,17+yoff);
  }
  ctx.stroke();
}

// Cave darkness overlay with torch light pools (Level 3)
function drawCaveOverlay(){
  if(level!==3) return;
  // Overall cave darkness vignette
  ctx.globalAlpha=0.4;
  ctx.fillStyle="#000";
  ctx.fillRect(0,0,W,H);
  // Torch light pools - subtract darkness around torches
  ctx.globalCompositeOperation="destination-out";
  for(var i=0;i<torches.length;i++){
    var t=torches[i],sx=wxf(t.x);
    if(sx<-60||sx>W+60) continue;
    var flick=Math.sin(t.flicker*5)*0.1+0.9;
    var grad=ctx.createRadialGradient(sx,GROUND_Y-15,0,sx,GROUND_Y-15,55*flick);
    grad.addColorStop(0,"rgba(0,0,0,0.7)");
    grad.addColorStop(0.5,"rgba(0,0,0,0.4)");
    grad.addColorStop(1,"rgba(0,0,0,0)");
    ctx.fillStyle=grad;
    ctx.fillRect(sx-60,GROUND_Y-70,120,80);
  }
  // Player glow (robot lights)
  var px=wxf(player.x);
  var grad=ctx.createRadialGradient(px,player.y-8,0,px,player.y-8,35);
  grad.addColorStop(0,"rgba(0,0,0,0.5)");
  grad.addColorStop(0.6,"rgba(0,0,0,0.2)");
  grad.addColorStop(1,"rgba(0,0,0,0)");
  ctx.fillStyle=grad;
  ctx.fillRect(px-40,player.y-45,80,60);
  ctx.globalCompositeOperation="source-over";
  ctx.globalAlpha=1;
}

function drawSky(){
  var bands=24;
  for(var i=0;i<bands;i++){
    var t=i/bands;var r,g,b;
    if(level===1){
      // Desert sky - purple/pink top to soft pink/blue horizon
      if(t<0.2){
        // Top - soft purple/lavender
        var t2=t/0.2;
        r=F(175+t2*35);g=F(140+t2*30);b=F(180-t2*10);
      } else if(t<0.45){
        // Upper mid - pink/salmon clouds
        var t2=(t-0.2)/0.25;
        r=F(210+t2*20);g=F(170+t2*30);b=F(170+t2*15);
      } else if(t<0.7){
        // Middle - soft pink blending lighter
        var t2=(t-0.45)/0.25;
        r=F(230-t2*15);g=F(200+t2*15);b=F(185+t2*20);
      } else {
        // Near horizon - pale pink/blue tint standing out from tan dunes
        var t2=(t-0.7)/0.3;
        r=F(215-t2*10);g=F(215+t2*10);b=F(205+t2*15);
      }
    } else if(level===2){
      // Level 2 night sky
      if(t<0.4){
        var t2=t/0.4;
        r=F(15+t2*15);g=F(10+t2*15);b=F(30+t2*25);
      } else if(t<0.7){
        var t2=(t-0.4)/0.3;
        r=F(30+t2*20);g=F(25+t2*15);b=F(55+t2*15);
      } else {
        var t2=(t-0.7)/0.3;
        r=F(50+t2*15);g=F(40+t2*15);b=F(70+t2*10);
      }
    } else {
      // Level 3 cave interior - dark rock background
      if(t<0.5){
        var t2=t/0.5;
        r=F(12+t2*10);g=F(8+t2*8);b=F(6+t2*5);
      } else {
        var t2=(t-0.5)/0.5;
        r=F(22+t2*8);g=F(16+t2*6);b=F(11+t2*5);
      }
    }
    R(0,i*(GROUND_Y/bands),W,Math.ceil(GROUND_Y/bands)+1,"rgb("+r+","+g+","+b+")");
  }

  // Stars (brighter in Level 2, none in Level 3 cave)
  if(level!==3){
    for(var si=0;si<stars.length;si++){
      var st=stars[si];
      var twinkle=Math.sin(shimmerOffset*2+st.s*5)*0.3+0.7;
      ctx.globalAlpha=st.b*twinkle*(level===2?0.9:0.6);
      R(st.x,st.y,1,1,"#fff");
    }
  }
  ctx.globalAlpha=1;

  if(level===1){
    // Sun/moon Level 1
    ctx.globalAlpha=0.06;ctx.fillStyle="#ffe8cc";
    ctx.beginPath();ctx.arc(W-50,28,20,0,6.29);ctx.fill();
    ctx.globalAlpha=0.15;ctx.fillStyle="#ffe0c0";
    ctx.beginPath();ctx.arc(W-50,28,12,0,6.29);ctx.fill();
    ctx.globalAlpha=0.35;ctx.fillStyle="#ffeedd";
    ctx.beginPath();ctx.arc(W-50,28,8,0,6.29);ctx.fill();
    ctx.globalAlpha=1;
    ctx.globalAlpha=0.05;ctx.fillStyle="#ddccee";
    ctx.beginPath();ctx.arc(W-100,18,10,0,6.29);ctx.fill();
    ctx.globalAlpha=0.2;ctx.fillStyle="#ddccee";
    ctx.beginPath();ctx.arc(W-100,18,5,0,6.29);ctx.fill();
    ctx.globalAlpha=0.4;ctx.fillStyle="#eeddff";
    ctx.beginPath();ctx.arc(W-100,18,3,0,6.29);ctx.fill();
    ctx.globalAlpha=1;
  } else if(level===2){
    // Dual moons Level 2
    // Large moon (right)
    ctx.globalAlpha=0.08;ctx.fillStyle="#aabbdd";
    ctx.beginPath();ctx.arc(W-45,35,22,0,6.29);ctx.fill();
    ctx.globalAlpha=0.15;ctx.fillStyle="#bbccee";
    ctx.beginPath();ctx.arc(W-45,35,16,0,6.29);ctx.fill();
    ctx.globalAlpha=0.4;ctx.fillStyle="#ddeeff";
    ctx.beginPath();ctx.arc(W-45,35,10,0,6.29);ctx.fill();
    ctx.globalAlpha=0.6;ctx.fillStyle="#eef4ff";
    ctx.beginPath();ctx.arc(W-45,35,6,0,6.29);ctx.fill();
    // Small moon (left)
    ctx.globalAlpha=0.06;ctx.fillStyle="#ccaadd";
    ctx.beginPath();ctx.arc(40,25,14,0,6.29);ctx.fill();
    ctx.globalAlpha=0.12;ctx.fillStyle="#ddbbee";
    ctx.beginPath();ctx.arc(40,25,9,0,6.29);ctx.fill();
    ctx.globalAlpha=0.35;ctx.fillStyle="#eeccff";
    ctx.beginPath();ctx.arc(40,25,5,0,6.29);ctx.fill();
    ctx.globalAlpha=1;
  } else if(level===3){
    // Level 3 cave interior - ant farm / cross-section style
    drawCaveCeiling();
  }

  // Clouds (level-appropriate, none in cave)
  if(level!==3){
    ctx.globalAlpha=0.04;
    var cx1=((shimmerOffset*3)%300)-40;
    var cx2=((shimmerOffset*2+120)%340)-50;
    var cc=level===1?"#ffeedd":"#445566";
    R(cx1,40,60,4,cc);R(cx1+20,38,30,3,cc);
    R(cx2,55,50,3,cc);R(cx2+15,53,25,3,cc);
    ctx.globalAlpha=1;
  }
}

// Rolling dune background (Level 1) with atmospheric haze and varied shapes
function drawMountains(){
  if(level!==1) return;
  var scrollX,x,h,shade;

  // Layer 1: Far dunes - very hazy/faded
  scrollX=cam.x*0.01;
  ctx.fillStyle="rgba(210,195,175,0.7)";
  ctx.beginPath();ctx.moveTo(0,GROUND_Y);
  for(x=0;x<=W;x+=4){
    h=45+Math.sin((x+scrollX)*0.012)*18+Math.sin((x+scrollX)*0.029)*10+Math.sin((x+scrollX)*0.006)*8;
    ctx.lineTo(x,GROUND_Y-h);
  }
  ctx.lineTo(W,GROUND_Y);ctx.fill();
  // Shadow
  ctx.fillStyle="rgba(150,130,110,0.25)";
  ctx.beginPath();ctx.moveTo(0,GROUND_Y);
  for(x=0;x<=W;x+=4){
    h=44+Math.sin((x+scrollX)*0.012)*18+Math.sin((x+scrollX)*0.029)*10+Math.sin((x+scrollX)*0.006)*8;
    shade=(Math.cos((x+scrollX)*0.012)+1)/2;
    ctx.lineTo(x,GROUND_Y-h*shade*0.5);
  }
  ctx.lineTo(W,GROUND_Y);ctx.fill();

  // Layer 2: Mid-far dunes - hazy
  scrollX=cam.x*0.02;
  ctx.fillStyle="rgba(200,175,145,0.8)";
  ctx.beginPath();ctx.moveTo(0,GROUND_Y);
  for(x=0;x<=W;x+=3){
    h=35+Math.sin((x+scrollX)*0.017)*14+Math.sin((x+scrollX)*0.039)*8+Math.sin((x+scrollX)*0.008)*6;
    ctx.lineTo(x,GROUND_Y-h);
  }
  ctx.lineTo(W,GROUND_Y);ctx.fill();
  // Shadow
  ctx.fillStyle="rgba(130,100,70,0.3)";
  ctx.beginPath();ctx.moveTo(0,GROUND_Y);
  for(x=0;x<=W;x+=3){
    h=34+Math.sin((x+scrollX)*0.017)*14+Math.sin((x+scrollX)*0.039)*8+Math.sin((x+scrollX)*0.008)*6;
    shade=(Math.cos((x+scrollX)*0.017)+1)/2;
    ctx.lineTo(x,GROUND_Y-h*shade*0.55);
  }
  ctx.lineTo(W,GROUND_Y);ctx.fill();

  // Layer 3: Mid dunes - clearer
  scrollX=cam.x*0.035;
  ctx.fillStyle="#d5a575";
  ctx.beginPath();ctx.moveTo(0,GROUND_Y);
  for(x=0;x<=W;x+=3){
    h=26+Math.sin((x+scrollX)*0.023)*11+Math.sin((x+scrollX)*0.051)*6+Math.sin((x+scrollX)*0.01)*5;
    ctx.lineTo(x,GROUND_Y-h);
  }
  ctx.lineTo(W,GROUND_Y);ctx.fill();
  // Shadow
  ctx.fillStyle="rgba(100,70,45,0.4)";
  ctx.beginPath();ctx.moveTo(0,GROUND_Y);
  for(x=0;x<=W;x+=3){
    h=25+Math.sin((x+scrollX)*0.023)*11+Math.sin((x+scrollX)*0.051)*6+Math.sin((x+scrollX)*0.01)*5;
    shade=(Math.cos((x+scrollX)*0.023)+1)/2;
    ctx.lineTo(x,GROUND_Y-h*shade*0.6);
  }
  ctx.lineTo(W,GROUND_Y);ctx.fill();

  // Layer 4: Near dunes - most saturated
  scrollX=cam.x*0.05;
  ctx.fillStyle="#c8925c";
  ctx.beginPath();ctx.moveTo(0,GROUND_Y);
  for(x=0;x<=W;x+=2){
    h=18+Math.sin((x+scrollX)*0.031)*8+Math.sin((x+scrollX)*0.067)*4+Math.sin((x+scrollX)*0.013)*4;
    ctx.lineTo(x,GROUND_Y-h);
  }
  ctx.lineTo(W,GROUND_Y);ctx.fill();
  // Shadow
  ctx.fillStyle="rgba(80,50,30,0.45)";
  ctx.beginPath();ctx.moveTo(0,GROUND_Y);
  for(x=0;x<=W;x+=2){
    h=17+Math.sin((x+scrollX)*0.031)*8+Math.sin((x+scrollX)*0.067)*4+Math.sin((x+scrollX)*0.013)*4;
    shade=(Math.cos((x+scrollX)*0.031)+1)/2;
    ctx.lineTo(x,GROUND_Y-h*shade*0.65);
  }
  ctx.lineTo(W,GROUND_Y);ctx.fill();
}

// Level 2 night desert background
function drawNightDunes(){
  if(level!==2) return;
  var scrollX,x,h;

  // Layer 1: Far dunes (slowest) - dark purple/blue
  scrollX=cam.x*0.01;
  ctx.fillStyle="#4a4065";
  ctx.beginPath();ctx.moveTo(0,GROUND_Y);
  for(x=0;x<=W;x+=4){
    h=45+Math.sin((x+scrollX)*0.015)*20+Math.sin((x+scrollX)*0.025)*12;
    ctx.lineTo(x,GROUND_Y-h);
  }
  ctx.lineTo(W,GROUND_Y);ctx.fill();
  // Shadow side
  ctx.fillStyle="#2a2040";
  ctx.beginPath();ctx.moveTo(0,GROUND_Y);
  for(x=0;x<=W;x+=4){
    h=43+Math.sin((x+scrollX)*0.015)*20+Math.sin((x+scrollX)*0.025)*12;
    var shade=Math.cos((x+scrollX)*0.015);
    ctx.lineTo(x,GROUND_Y-(shade>0?h*0.5:h*0.85));
  }
  ctx.lineTo(W,GROUND_Y);ctx.fill();

  // Layer 2: Mid-far dunes
  scrollX=cam.x*0.02;
  ctx.fillStyle="#3a3555";
  ctx.beginPath();ctx.moveTo(0,GROUND_Y);
  for(x=0;x<=W;x+=3){
    h=35+Math.sin((x+scrollX)*0.022)*18+Math.sin((x+scrollX)*0.038)*10;
    ctx.lineTo(x,GROUND_Y-h);
  }
  ctx.lineTo(W,GROUND_Y);ctx.fill();
  // Shadow side
  ctx.fillStyle="#1a1530";
  ctx.beginPath();ctx.moveTo(0,GROUND_Y);
  for(x=0;x<=W;x+=3){
    h=33+Math.sin((x+scrollX)*0.022)*18+Math.sin((x+scrollX)*0.038)*10;
    var shade=Math.cos((x+scrollX)*0.022);
    ctx.lineTo(x,GROUND_Y-(shade>0?h*0.4:h*0.8));
  }
  ctx.lineTo(W,GROUND_Y);ctx.fill();

  // Layer 3: Mid dunes
  scrollX=cam.x*0.035;
  ctx.fillStyle="#454060";
  ctx.beginPath();ctx.moveTo(0,GROUND_Y);
  for(x=0;x<=W;x+=3){
    h=26+Math.sin((x+scrollX)*0.03)*14+Math.sin((x+scrollX)*0.05)*8;
    ctx.lineTo(x,GROUND_Y-h);
  }
  ctx.lineTo(W,GROUND_Y);ctx.fill();
  // Shadow side
  ctx.fillStyle="#201a35";
  ctx.beginPath();ctx.moveTo(0,GROUND_Y);
  for(x=0;x<=W;x+=3){
    h=24+Math.sin((x+scrollX)*0.03)*14+Math.sin((x+scrollX)*0.05)*8;
    var shade=Math.cos((x+scrollX)*0.03);
    ctx.lineTo(x,GROUND_Y-(shade>0?h*0.35:h*0.75));
  }
  ctx.lineTo(W,GROUND_Y);ctx.fill();

  // Layer 4: Near dunes
  scrollX=cam.x*0.05;
  ctx.fillStyle="#3a3050";
  ctx.beginPath();ctx.moveTo(0,GROUND_Y);
  for(x=0;x<=W;x+=2){
    h=18+Math.sin((x+scrollX)*0.04)*10+Math.sin((x+scrollX)*0.07)*6;
    ctx.lineTo(x,GROUND_Y-h);
  }
  ctx.lineTo(W,GROUND_Y);ctx.fill();
  // Shadow side
  ctx.fillStyle="#151020";
  ctx.beginPath();ctx.moveTo(0,GROUND_Y);
  for(x=0;x<=W;x+=2){
    h=16+Math.sin((x+scrollX)*0.04)*10+Math.sin((x+scrollX)*0.07)*6;
    var shade=Math.cos((x+scrollX)*0.04);
    ctx.lineTo(x,GROUND_Y-(shade>0?h*0.3:h*0.7));
  }
  ctx.lineTo(W,GROUND_Y);ctx.fill();
}

// Level 3 cave background
function drawCaveBackground(){
  if(level!==3) return;
  var scrollX,x,h,seed;

  // Layer 1: Far cave wall - jagged rocky silhouette
  scrollX=cam.x*0.01;
  ctx.fillStyle="#1a100c";
  ctx.beginPath();ctx.moveTo(0,GROUND_Y);
  for(x=0;x<=W;x+=6){
    seed=(x+scrollX)*0.5;
    // Jagged rocky pattern
    h=40+((F(seed*7)%20)-10)+((F(seed*3)%15)-7);
    ctx.lineTo(x,GROUND_Y-h);
  }
  ctx.lineTo(W,GROUND_Y);ctx.fill();
  // Darker depth
  ctx.fillStyle="#0c0806";
  ctx.beginPath();ctx.moveTo(0,GROUND_Y);
  for(x=0;x<=W;x+=6){
    seed=(x+scrollX)*0.5;
    h=35+((F(seed*7)%18)-9)+((F(seed*3)%12)-6);
    if((F(seed*11)%3)===0) h-=8; // random deep crevices
    ctx.lineTo(x,GROUND_Y-h);
  }
  ctx.lineTo(W,GROUND_Y);ctx.fill();

  // Layer 2: Mid cave wall - more detail
  scrollX=cam.x*0.02;
  ctx.fillStyle="#2a1810";
  ctx.beginPath();ctx.moveTo(0,GROUND_Y);
  for(x=0;x<=W;x+=4){
    seed=(x+scrollX)*0.7;
    h=32+((F(seed*9)%16)-8)+((F(seed*5)%12)-6);
    ctx.lineTo(x,GROUND_Y-h);
  }
  ctx.lineTo(W,GROUND_Y);ctx.fill();
  // Shadow recesses
  ctx.fillStyle="#100a06";
  ctx.beginPath();ctx.moveTo(0,GROUND_Y);
  for(x=0;x<=W;x+=4){
    seed=(x+scrollX)*0.7;
    h=28+((F(seed*9)%14)-7)+((F(seed*5)%10)-5);
    if((F(seed*13)%4)===0) h-=6;
    ctx.lineTo(x,GROUND_Y-h);
  }
  ctx.lineTo(W,GROUND_Y);ctx.fill();

  // Layer 3: Near rocky outcrops
  scrollX=cam.x*0.035;
  ctx.fillStyle="#3a2418";
  ctx.beginPath();ctx.moveTo(0,GROUND_Y);
  for(x=0;x<=W;x+=3){
    seed=(x+scrollX)*0.9;
    h=22+((F(seed*11)%14)-7)+((F(seed*7)%10)-5);
    ctx.lineTo(x,GROUND_Y-h);
  }
  ctx.lineTo(W,GROUND_Y);ctx.fill();
  // Dark cracks
  ctx.fillStyle="#140c08";
  ctx.beginPath();ctx.moveTo(0,GROUND_Y);
  for(x=0;x<=W;x+=3){
    seed=(x+scrollX)*0.9;
    h=18+((F(seed*11)%12)-6)+((F(seed*7)%8)-4);
    if((F(seed*17)%3)===0) h-=5;
    ctx.lineTo(x,GROUND_Y-h);
  }
  ctx.lineTo(W,GROUND_Y);ctx.fill();

  // Layer 4: Closest rock formations
  scrollX=cam.x*0.05;
  ctx.fillStyle="#2a1a12";
  ctx.beginPath();ctx.moveTo(0,GROUND_Y);
  for(x=0;x<=W;x+=2){
    seed=(x+scrollX)*1.1;
    h=14+((F(seed*13)%10)-5)+((F(seed*9)%8)-4);
    ctx.lineTo(x,GROUND_Y-h);
  }
  ctx.lineTo(W,GROUND_Y);ctx.fill();
  // Deep shadows
  ctx.fillStyle="#0a0604";
  ctx.beginPath();ctx.moveTo(0,GROUND_Y);
  for(x=0;x<=W;x+=2){
    seed=(x+scrollX)*1.1;
    h=10+((F(seed*13)%8)-4)+((F(seed*9)%6)-3);
    if((F(seed*19)%4)===0) h-=4;
    ctx.lineTo(x,GROUND_Y-h);
  }
  ctx.lineTo(W,GROUND_Y);ctx.fill();
}

// SNES-style clouds (Level 1 only)
function drawClouds(){
  if(level!==1) return;
  // Super Star Wars style - subtle dust haze near horizon, no fluffy clouds
  var scrollX=cam.x*0.01;
  ctx.fillStyle="rgba(240,210,170,0.15)";
  for(var i=0;i<3;i++){
    var seed=i*97+17;
    var cx=((seed*5+scrollX*0.2+i*120)%(W+150))-75;
    var cy=GROUND_Y-60+((seed*3)%30);
    var cw=60+((seed*7)%40);
    // Subtle dust wisps
    ctx.beginPath();
    ctx.ellipse(cx,cy,cw*0.6,cw*0.15,0,0,6.29);ctx.fill();
  }
}

function drawParallaxDunes(){
  if(level===1){
    // Simplified foreground - just rolling dune shapes with shadow
    var scrollX=cam.x*0.1;
    // Single foreground dune layer - more tan, less orange
    ctx.fillStyle="#c9a078";
    ctx.beginPath();ctx.moveTo(0,GROUND_Y);
    for(var x=0;x<=W;x+=3){
      var h=10+Math.sin((x+scrollX)*0.06)*6+Math.sin((x+scrollX)*0.1)*4;
      ctx.lineTo(x,GROUND_Y-h);
    }
    ctx.lineTo(W,GROUND_Y);ctx.fill();
    // Shadow on dunes
    ctx.fillStyle="rgba(90,60,40,0.32)";
    ctx.beginPath();ctx.moveTo(0,GROUND_Y);
    for(var x=0;x<=W;x+=3){
      var h=9+Math.sin((x+scrollX)*0.06)*6+Math.sin((x+scrollX)*0.1)*4;
      var shade=(Math.cos((x+scrollX)*0.06)+1)/2;
      ctx.lineTo(x,GROUND_Y-h*shade*0.6);
    }
    ctx.lineTo(W,GROUND_Y);ctx.fill();
  } else {
    // Original code for other levels
    var cFar=level===2?C2_DUNE_FAR:C3_DUNE_FAR;
    var cMid=level===2?C2_DUNE_MID:C3_DUNE_MID;
    var cNear=level===2?C2_DUNE_NEAR:C3_DUNE_NEAR;
    for(var i=0;i<dunesFar.length;i++){
      var d=dunesFar[i];
      var sx=((d.x-cam.x*0.08)%(W+40)+W+40)%(W+40)-20;
      ctx.fillStyle=cFar;
      ctx.beginPath();ctx.ellipse(F(sx+d.w/2),GROUND_Y-2,d.w/2,d.h+6,0,Math.PI,0);ctx.fill();
    }
    for(var j=0;j<dunesMid.length;j++){
      var dm=dunesMid[j];
      var smx=((dm.x-cam.x*0.2)%(W+40)+W+40)%(W+40)-20;
      ctx.fillStyle=cMid;
      ctx.beginPath();ctx.ellipse(F(smx+dm.w/2),GROUND_Y-1,dm.w/2,dm.h+3,0,Math.PI,0);ctx.fill();
    }
    for(var k=0;k<dunesClose.length;k++){
      var dc=dunesClose[k];
      var scx=((dc.x-cam.x*0.35)%(W+40)+W+40)%(W+40)-20;
      ctx.fillStyle=cNear;
      ctx.beginPath();ctx.ellipse(F(scx+dc.w/2),GROUND_Y,dc.w/2,dc.h+1,0,Math.PI,0);ctx.fill();
    }
  }
}

function drawGround(){
  var cG=level===1?C_GROUND:level===2?C2_GROUND:C3_GROUND;
  var cGD=level===1?C_GROUND_DARK:level===2?C2_GROUND_DARK:C3_GROUND_DARK;
  var cGDP=level===1?C_GROUND_DEEPER:level===2?C2_GROUND_DEEPER:C3_GROUND_DEEPER;
  var cGL=level===1?C_GROUND_LINE:level===2?C2_GROUND_LINE:C3_GROUND_LINE;
  R(0,GROUND_Y,W,H-GROUND_Y,cG);
  if(level===1){
    // Super Star Wars style ground - scrolls with world
    // Top highlight line
    R(0,GROUND_Y,W,1,"#f0d8b8");
    R(0,GROUND_Y+1,W,1,"#e8d0b0");
    // Gradient bands of sand
    R(0,GROUND_Y+2,W,3,"#e0c8a8");
    R(0,GROUND_Y+5,W,4,"#d8c0a0");
    R(0,GROUND_Y+9,W,5,"#d0b898");
    R(0,GROUND_Y+14,W,6,"#c8b090");
    R(0,GROUND_Y+20,W,H-GROUND_Y-20,"#c0a888");
    // Wave texture - scrolls with world (offset by cam.x) - reduced 20%
    var camOff=cam.x;
    ctx.strokeStyle="rgba(180,140,100,0.3)";ctx.lineWidth=1;
    for(var wy=GROUND_Y+3;wy<GROUND_Y+25;wy+=3){
      ctx.beginPath();
      for(var x=0;x<=W;x+=5){
        var worldX=x+camOff;
        var wx=x+Math.sin((worldX+wy*2.5)*0.12)*4;
        if(x===0)ctx.moveTo(wx,wy);else ctx.lineTo(wx,wy);
      }
      ctx.stroke();
    }
    // Shadow wave bands - scroll with world - reduced
    ctx.fillStyle="rgba(140,100,70,0.18)";
    for(var band=0;band<3;band++){
      var by=GROUND_Y+4+band*6;
      ctx.beginPath();ctx.moveTo(0,by);
      for(var x=0;x<=W;x+=8){
        var worldX=x+camOff;
        var wh=Math.sin((worldX+band*30)*0.08)*2;
        ctx.lineTo(x,by+wh);
      }
      ctx.lineTo(W,by+3);ctx.lineTo(0,by+3);ctx.fill();
    }
    // Shadow stripes - scroll with world - reduced
    ctx.fillStyle="rgba(120,88,56,0.2)";
    for(var stripe=0;stripe<6;stripe++){
      var worldStx=stripe*60;
      var stx=worldStx-camOff%60+(stripe===0?60:0);
      if(stx>-20&&stx<W+20){
        for(var sy=GROUND_Y+5;sy<GROUND_Y+22;sy+=4){
          var sw=15+Math.sin(sy*0.3)*5;
          R(stx+Math.sin(sy*0.2)*3,sy,sw,2,ctx.fillStyle);
        }
      }
    }
    // Wave ripples - scroll with world - reduced
    ctx.strokeStyle="rgba(160,116,76,0.35)";
    for(var wy=GROUND_Y+6;wy<GROUND_Y+20;wy+=4){
      ctx.beginPath();
      for(var x=0;x<=W;x+=4){
        var worldX=x+camOff;
        var wx=x+Math.sin((worldX+wy*3)*0.15)*3;
        if(x===0)ctx.moveTo(wx,wy);else ctx.lineTo(wx,wy);
      }
      ctx.stroke();
    }
    // Scattered pebbles - scroll with world - reduced
    for(var i=0;i<32;i++){
      var worldPx=i*30;
      var px=worldPx-camOff%960;
      if(px>-5&&px<W+5){
        var py=GROUND_Y+4+((i*13)%14);
        R(px+1,py+1,2,1,"#907050");
        R(px,py,2,1,"#b09878");
        R(px,py,1,1,"#c8b090");
      }
    }
  } else if(level===2){
    // Level 2 night desert ground - scrolls with world
    var camOff=cam.x;
    R(0,GROUND_Y,W,1,"#4a4565");
    R(0,GROUND_Y+1,W,1,"#3a3555");
    R(0,GROUND_Y+2,W,3,"#302a48");
    R(0,GROUND_Y+5,W,4,"#2a2540");
    R(0,GROUND_Y+9,W,5,"#252038");
    R(0,GROUND_Y+14,W,6,"#201a35");
    R(0,GROUND_Y+20,W,H-GROUND_Y-20,"#1a1530");
    // Wave texture
    ctx.strokeStyle="rgba(80,70,100,0.35)";ctx.lineWidth=1;
    for(var wy=GROUND_Y+3;wy<GROUND_Y+25;wy+=2){
      ctx.beginPath();
      for(var x=0;x<=W;x+=4){
        var worldX=x+camOff;
        var wx=x+Math.sin((worldX+wy*2.5)*0.12)*4;
        if(x===0)ctx.moveTo(wx,wy);else ctx.lineTo(wx,wy);
      }
      ctx.stroke();
    }
    // Shadow bands
    ctx.fillStyle="rgba(20,15,40,0.25)";
    for(var band=0;band<4;band++){
      var by=GROUND_Y+4+band*5;
      ctx.beginPath();ctx.moveTo(0,by);
      for(var x=0;x<=W;x+=6){
        var worldX=x+camOff;
        var wh=Math.sin((worldX+band*30)*0.08)*2;
        ctx.lineTo(x,by+wh);
      }
      ctx.lineTo(W,by+3);ctx.lineTo(0,by+3);ctx.fill();
    }
    // Scattered rocks
    for(var i=0;i<40;i++){
      var worldPx=i*25;
      var px=worldPx-camOff%1000;
      if(px>-5&&px<W+5){
        var py=GROUND_Y+4+((i*13)%14);
        R(px+1,py+1,2,1,"#151025");
        R(px,py,2,1,"#3a3555");
        R(px,py,1,1,"#4a4565");
      }
    }
  } else {
    // Level 3 cave ground - scrolls with world
    var camOff=cam.x;
    R(0,GROUND_Y,W,1,"#3a2820");
    R(0,GROUND_Y+1,W,1,"#2a1a14");
    R(0,GROUND_Y+2,W,3,"#221410");
    R(0,GROUND_Y+5,W,4,"#1a100c");
    R(0,GROUND_Y+9,W,5,"#140c08");
    R(0,GROUND_Y+14,W,6,"#100a06");
    R(0,GROUND_Y+20,W,H-GROUND_Y-20,"#0c0804");
    // Rocky texture
    ctx.strokeStyle="rgba(60,40,30,0.4)";ctx.lineWidth=1;
    for(var wy=GROUND_Y+3;wy<GROUND_Y+25;wy+=2){
      ctx.beginPath();
      for(var x=0;x<=W;x+=4){
        var worldX=x+camOff;
        var wx=x+Math.sin((worldX+wy*2)*0.1)*3;
        if(x===0)ctx.moveTo(wx,wy);else ctx.lineTo(wx,wy);
      }
      ctx.stroke();
    }
    // Shadow cracks
    ctx.fillStyle="rgba(5,3,2,0.3)";
    for(var band=0;band<4;band++){
      var by=GROUND_Y+4+band*5;
      ctx.beginPath();ctx.moveTo(0,by);
      for(var x=0;x<=W;x+=6){
        var worldX=x+camOff;
        var wh=Math.sin((worldX+band*25)*0.07)*2;
        ctx.lineTo(x,by+wh);
      }
      ctx.lineTo(W,by+3);ctx.lineTo(0,by+3);ctx.fill();
    }
    // Scattered rocks/debris
    for(var i=0;i<40;i++){
      var worldPx=i*25;
      var px=worldPx-camOff%1000;
      if(px>-5&&px<W+5){
        var py=GROUND_Y+4+((i*13)%14);
        R(px+1,py+1,2,1,"#050302");
        R(px,py,2,1,"#2a1a14");
        R(px,py,1,1,"#3a2820");
      }
    }
  }
  var cSpec=level===1?C_SAND_SPEC:level===2?C2_SAND_SPEC:C3_SAND_SPEC;
  var cSDark=level===1?C_SAND_DARK:level===2?C2_SAND_DARK:C3_SAND_DARK;
  for(var i=0;i<sandSpecs.length;i++){
    var s=sandSpecs[i],sx=wxf(s.x);
    if(sx>-2&&sx<W+2) R(sx,s.y,1,1,i%2===0?cSpec:cSDark);
  }
}

function drawTerrainDunes(){
  for(var i=0;i<terrainDunes.length;i++){
    var d=terrainDunes[i],sx=wxf(d.x);
    if(sx+d.w/2<-20||sx-d.w/2>W+20) continue;
    var radius=d.w/2;
    if(level===1){
      // Super Star Wars style detailed sand dune with deep shadows and wave texture
      // Deep shadow underneath
      ctx.fillStyle="#705038";
      ctx.beginPath();ctx.ellipse(F(sx+3),GROUND_Y+1,radius+4,d.h*0.4,0,Math.PI,0);ctx.fill();
      // Dark base/shadow
      ctx.fillStyle="#886048";
      ctx.beginPath();ctx.ellipse(F(sx+2),GROUND_Y,radius+2,d.h+2,0,Math.PI,0);ctx.fill();
      // Main dune body - layered colors
      ctx.fillStyle="#a88060";
      ctx.beginPath();ctx.ellipse(F(sx+1),GROUND_Y,radius+1,d.h+1,0,Math.PI,0);ctx.fill();
      ctx.fillStyle="#b89068";
      ctx.beginPath();ctx.ellipse(F(sx),GROUND_Y,radius,d.h,0,Math.PI,0);ctx.fill();
      ctx.fillStyle="#c8a078";
      ctx.beginPath();ctx.ellipse(F(sx),GROUND_Y,radius*0.9,d.h*0.9,0,Math.PI,0);ctx.fill();
      ctx.fillStyle="#d0a880";
      ctx.beginPath();ctx.ellipse(F(sx-1),GROUND_Y,radius*0.75,d.h*0.8,0,Math.PI,0);ctx.fill();
      // Left highlight (sun side)
      ctx.fillStyle="#e0c0a0";
      ctx.beginPath();ctx.ellipse(F(sx-radius*0.35),GROUND_Y,radius*0.4,d.h*0.75,0,Math.PI,0);ctx.fill();
      ctx.fillStyle="#e8c8a8";
      ctx.beginPath();ctx.ellipse(F(sx-radius*0.4),GROUND_Y,radius*0.25,d.h*0.55,0,Math.PI,0);ctx.fill();
      ctx.fillStyle="#f0d0b0";
      ctx.beginPath();ctx.ellipse(F(sx-radius*0.45),GROUND_Y,radius*0.12,d.h*0.35,0,Math.PI,0);ctx.fill();
      // Right shadow - deeper
      ctx.fillStyle="#906848";
      ctx.beginPath();ctx.ellipse(F(sx+radius*0.5),GROUND_Y,radius*0.4,d.h*0.75,0,Math.PI,0);ctx.fill();
      ctx.fillStyle="#7a5838";
      ctx.beginPath();ctx.ellipse(F(sx+radius*0.55),GROUND_Y,radius*0.25,d.h*0.5,0,Math.PI,0);ctx.fill();
      // Crest highlight
      ctx.fillStyle="#f8e0c0";
      ctx.fillRect(F(sx-radius*0.5),GROUND_Y-d.h,F(radius),1);
      ctx.fillStyle="#f0d8b8";
      ctx.fillRect(F(sx-radius*0.45),GROUND_Y-d.h+1,F(radius*0.9),1);
      ctx.fillStyle="#e8d0b0";
      ctx.fillRect(F(sx-radius*0.4),GROUND_Y-d.h+2,F(radius*0.8),1);
      // Sand wave ripple texture
      ctx.strokeStyle="rgba(140,100,60,0.4)";ctx.lineWidth=1;
      for(var r=0;r<5;r++){
        var ry=GROUND_Y-d.h*0.2-r*2.5;
        var rw=radius*0.7-r*3;
        if(rw>0){
          ctx.beginPath();
          ctx.moveTo(F(sx-rw/2),ry);
          ctx.quadraticCurveTo(F(sx),ry-1,F(sx+rw/2),ry);
          ctx.stroke();
        }
      }
      // Additional shadow wave lines
      ctx.strokeStyle="rgba(120,80,50,0.35)";
      for(var r=0;r<3;r++){
        var ry=GROUND_Y-d.h*0.5-r*3;
        var rw=radius*0.5-r*4;
        if(rw>0){
          ctx.beginPath();
          ctx.moveTo(F(sx+radius*0.1-rw/2),ry);
          ctx.quadraticCurveTo(F(sx+radius*0.15),ry+1,F(sx+radius*0.1+rw/2),ry);
          ctx.stroke();
        }
      }
    } else {
      var cBase=level===2?C2_TDUNE_BASE:C3_TDUNE_BASE;
      var cInner=level===2?C2_TDUNE_INNER:C3_TDUNE_INNER;
      var cHigh=level===2?C2_TDUNE_HIGHLIGHT:C3_TDUNE_HIGHLIGHT;
      var cShad=level===2?C2_TDUNE_SHADOW:C3_TDUNE_SHADOW;
      ctx.fillStyle=cBase;
      ctx.beginPath();ctx.ellipse(F(sx),GROUND_Y,radius,d.h,0,Math.PI,0);ctx.fill();
      ctx.fillStyle=cInner;
      ctx.beginPath();ctx.ellipse(F(sx),GROUND_Y,radius*0.85,d.h*0.85,0,Math.PI,0);ctx.fill();
      ctx.globalAlpha=0.22;ctx.fillStyle=cHigh;
      ctx.beginPath();ctx.ellipse(F(sx-radius*0.2),GROUND_Y,radius*0.35,d.h*0.7,0,Math.PI,0);ctx.fill();
      ctx.globalAlpha=0.18;ctx.fillStyle=cShad;
      ctx.beginPath();ctx.ellipse(F(sx+radius*0.3),GROUND_Y,radius*0.3,d.h*0.6,0,Math.PI,0);ctx.fill();
      ctx.globalAlpha=1;
    }
  }
}

function drawGlowDomes(){
  for(var i=0;i<glowDomes.length;i++){
    var g=glowDomes[i],sx=wxf(g.x);
    if(sx<-20||sx>W+20) continue;
    var gc=level===1?"#ffeedd":"#8888aa";
    ctx.globalAlpha=0.08;ctx.fillStyle=gc;
    ctx.beginPath();ctx.ellipse(F(sx),GROUND_Y,g.r*2,g.r,0,Math.PI,0);ctx.fill();
    ctx.globalAlpha=0.15;ctx.fillStyle=level===1?"#fff8ee":"#aaaacc";
    ctx.beginPath();ctx.ellipse(F(sx),GROUND_Y,g.r,g.r*0.6,0,Math.PI,0);ctx.fill();
    ctx.globalAlpha=1;
  }
}

function drawProps(){
  for(var i=0;i<props.length;i++){
    var p=props[i],sx=wxf(p.x);
    if(sx<-20||sx>W+20) continue;
    var gy=groundYAt(p.x);
    if(level===1){
      // Super Star Wars style desert props
      if(p.type==="antenna"){
        // Moisture vaporator style
        R(sx-1,gy-p.h,3,p.h,"#706050");
        R(sx,gy-p.h,1,p.h,"#908070");
        R(sx-2,gy-p.h+3,5,2,"#807060");
        R(sx-2,gy-p.h+3,5,1,"#a09080");
        R(sx,gy-p.h,2,2,"#cc4422");R(sx,gy-p.h,1,1,"#ff6644");
        R(sx-1,gy-3,3,3,"#605040");R(sx-1,gy-3,3,1,"#807060");
      } else if(p.type==="panel"){
        // Weathered tech panel
        R(sx-1,gy-p.h-1,p.w+2,p.h+2,"#504030");
        R(sx,gy-p.h,p.w,p.h,"#807060");
        R(sx,gy-p.h,p.w,1,"#a09080");
        R(sx+1,gy-p.h+1,p.w-2,1,"#908070");
        R(sx+p.w-1,gy-p.h,1,p.h,"#605040");
        // Panel detail
        R(sx+2,gy-p.h+3,2,2,"#504030");
        R(sx+p.w-4,gy-p.h+2,2,3,"#605040");
      } else if(p.type==="wreck"){
        // Desert wreckage
        R(sx-1,gy-4,p.w+2,5,"#504030");
        R(sx,gy-3,p.w,3,"#908880");
        R(sx+1,gy-4,p.w-2,1,"#a09890");
        R(sx,gy-2,2,2,"#706860");
        R(sx+p.w-3,gy-3,2,2,"#807870");
      } else {
        // Rock/boulder
        ctx.fillStyle="#a09078";
        ctx.beginPath();ctx.ellipse(F(sx),gy-1,p.r+2,p.r,0,Math.PI,0);ctx.fill();
        ctx.fillStyle="#b8a890";
        ctx.beginPath();ctx.ellipse(F(sx),gy-2,p.r,p.r*0.7,0,Math.PI,0);ctx.fill();
        ctx.fillStyle="#c8b8a0";
        ctx.beginPath();ctx.ellipse(F(sx-1),gy-3,p.r*0.5,p.r*0.3,0,Math.PI,0);ctx.fill();
      }
    } else {
      var pc1="#556677";var pc2="#445566";
      if(p.type==="antenna"){
        R(sx,gy-p.h,1,p.h,pc1);R(sx,gy-p.h,2,1,"#ff6644");R(sx-1,gy-2,3,2,pc2);
      } else if(p.type==="panel"){
        R(sx,gy-p.h,p.w,p.h,pc2);R(sx,gy-p.h,p.w,1,pc1);R(sx+p.w-1,gy-p.h,1,p.h,"#334455");
      } else if(p.type==="wreck"){
        R(sx,gy-3,p.w,3,"#445566");R(sx+1,gy-4,p.w-2,1,"#556677");
      } else {
        ctx.globalAlpha=0.1;ctx.fillStyle="#6666aa";
        ctx.beginPath();ctx.ellipse(F(sx),gy,p.r*2,p.r,0,Math.PI,0);ctx.fill();
        ctx.globalAlpha=1;
      }
    }
  }
}

function drawPlatforms(){
  for(var i=0;i<platforms.length;i++){
    var pl=platforms[i],sx=wxf(pl.x),sy=pl.y;
    if(sx+pl.w<-10||sx>W+10) continue;
    // Super Star Wars style stone/brick platform - all levels with different colors
    var outline,stone1,stone2,stone3,highlight,shadow;
    if(level===1){
      outline="#705840";stone1="#c0a080";stone2="#b09070";stone3="#a08060";
      highlight="#d8c0a0";shadow="#806850";
    } else if(level===2){
      // Night desert - purple/blue stone
      outline="#3a3058";stone1="#706090";stone2="#605080";stone3="#504070";
      highlight="#908ab0";shadow="#403058";
    } else {
      // Cave - dark brown/gray stone
      outline="#2a2018";stone1="#605040";stone2="#504030";stone3="#403020";
      highlight="#807060";shadow="#302010";
    }
    // Main body with outline
    R(sx-1,sy-1,pl.w+2,8,outline);
    R(sx,sy,pl.w,6,stone1);
    // Top highlight edge
    R(sx,sy,pl.w,1,highlight);
    R(sx+1,sy+1,pl.w-2,1,stone2);
    // Bottom shadow
    R(sx,sy+5,pl.w,1,shadow);
    // Side shading
    R(sx,sy,1,6,stone1);R(sx+1,sy+1,1,4,highlight);
    R(sx+pl.w-1,sy,1,6,shadow);R(sx+pl.w-2,sy+1,1,4,stone2);
    // Brick/stone pattern
    var brickW=8;
    for(var bx=sx+2;bx<sx+pl.w-4;bx+=brickW){
      R(bx,sy+2,1,3,stone3);
      if((F(bx/brickW))%2===0) R(bx+3,sy+1,1,2,stone2);
    }
    // Surface texture specks
    for(var tx=sx+3;tx<sx+pl.w-3;tx+=5){
      var ty=sy+2+((tx*7)%3);
      R(tx,ty,1,1,((tx*3)%2)?highlight:stone3);
    }
    // Drop shadow
    ctx.globalAlpha=0.15;R(sx+2,sy+7,pl.w-2,2,"#000");ctx.globalAlpha=1;
  }
}

function drawRobot(){
  var sx=wxf(player.x),sy=player.y;
  var hasInvinc=player.invincTimer>0;
  if(player.invuln>0&&player.powerTimer<=0&&!hasInvinc){
    var blinkRate=player.invuln>1?8:14;
    if(F(player.invuln*blinkRate)%2) return;
  }
  var f=player.facing,frame=player.animFrame;
  var isDashing=player.dashTimer>0;
  var hasPower=player.powerTimer>0;
  // FREQ-2 style robot - lighter cyan blues, pink visor, humanoid shape
  var blueDark=hasInvinc?"#aa8820":isDashing?"#115566":hasPower?"#224488":"#1a4060";
  var blueMid=hasInvinc?"#ccaa33":isDashing?"#22aacc":hasPower?"#3388cc":"#3080b0";
  var blueLight=hasInvinc?"#ddbb44":isDashing?"#44ddee":hasPower?"#55aaee":"#50a0d0";
  var blueBright=hasInvinc?"#eedd55":isDashing?"#66eeff":hasPower?"#77ccff":"#70c0e8";
  var glowEdge=hasInvinc?"#ffee66":isDashing?"#88ffff":hasPower?"#99ddff":"#90d8ff";
  var visor=hasInvinc?"#ffaa44":isDashing?"#66ffcc":hasPower?"#66aaff":"#ff55aa";
  var visorGlow=hasInvinc?"#ffcc66":isDashing?"#88ffee":hasPower?"#88ccff":"#ff88cc";
  var visorDark=hasInvinc?"#cc8822":isDashing?"#44ccaa":hasPower?"#4488cc":"#cc3388";
  var coreGlow=hasInvinc?"#ffcc44":isDashing?"#44ffcc":hasPower?"#4488ff":"#ff4488";
  var outline="#0a1828";
  var lf=0,rf=0;
  if(frame===1){lf=-2;rf=1;}else if(frame===3){lf=1;rf=-2;}
  var bx=F(sx),by=F(sy);
  var shadowY=GROUND_Y;
  var shadowScale=Math.max(0.5,1-(shadowY-by)/60);
  var scaleF=hasInvinc?INVINC_SCALE:1;
  if(hasInvinc){
    drawShadow(bx,shadowY+1,7*shadowScale);
    ctx.save();
    ctx.translate(bx,by);
    ctx.scale(scaleF,scaleF);
    ctx.translate(-bx,-by);
    var flickerAlpha=0.2+Math.sin(shimmerOffset*10)*0.1;
    ctx.globalAlpha=flickerAlpha;
    ctx.fillStyle=C_INVINC;
    ctx.beginPath();ctx.ellipse(bx,by-8,14,16,0,0,6.29);ctx.fill();
    ctx.globalAlpha=1;
  } else {
    drawShadow(bx,shadowY+1,5*shadowScale);
  }

  // CROUCHING POSE - compressed robot ducking down
  if(player.crouching){
    // Compact crouched body - only 10px tall
    var cy=by; // Bottom at feet
    // Rounded humanoid head (lowered for crouch)
    ctx.fillStyle=outline;
    ctx.beginPath();ctx.arc(F(bx),F(cy-7),6,0,6.29);ctx.fill();
    ctx.fillStyle=blueMid;
    ctx.beginPath();ctx.arc(F(bx),F(cy-7),5,0,6.29);ctx.fill();
    ctx.fillStyle=blueLight;
    ctx.beginPath();ctx.arc(F(bx),F(cy-8),3,0,3.14,true);ctx.fill();
    ctx.fillStyle=blueBright;
    ctx.beginPath();ctx.arc(F(bx),F(cy-9),2,0,3.14,true);ctx.fill();
    // Pink visor band across face
    var vx=f===1?bx-1:bx-4;
    R(vx-1,cy-8,8,3,outline);
    R(vx,cy-7,6,2,visor);
    R(vx+1,cy-7,4,1,visorGlow);
    // Compressed torso
    R(bx-5,cy-4,10,4,outline);
    R(bx-4,cy-3,8,2,blueMid);
    R(bx-3,cy-2,6,1,blueLight);
    R(bx-1,cy-3,2,1,coreGlow);
    // Crouched legs (bent)
    R(bx-5,cy-1,4,2,outline);R(bx-4,cy,2,1,blueMid);
    R(bx+1,cy-1,4,2,outline);R(bx+2,cy,2,1,blueMid);
    // Arms at sides
    R(bx-8,cy-5,3,4,outline);R(bx-7,cy-4,2,2,blueMid);
    R(bx+5,cy-5,3,4,outline);R(bx+5,cy-4,2,2,blueMid);
    if(hasInvinc) ctx.restore();
    return; // Skip normal drawing
  }

  // HELMET - rounded humanoid head with gradient shading
  ctx.fillStyle=outline;
  ctx.beginPath();ctx.arc(F(bx),F(by-14),7,0,6.29);ctx.fill();
  // Main head color - gradient from dark to bright
  ctx.fillStyle=blueDark;
  ctx.beginPath();ctx.arc(F(bx),F(by-14),6,0,6.29);ctx.fill();
  ctx.fillStyle=blueMid;
  ctx.beginPath();ctx.arc(F(bx),F(by-14),5,0,6.29);ctx.fill();
  // Top highlight - lighter cyan
  ctx.fillStyle=blueLight;
  ctx.beginPath();ctx.arc(F(bx),F(by-16),4,0,3.14,true);ctx.fill();
  ctx.fillStyle=blueBright;
  ctx.beginPath();ctx.arc(F(bx),F(by-17),3,0,3.14,true);ctx.fill();
  // Bright edge highlight
  ctx.fillStyle=glowEdge;
  ctx.beginPath();ctx.arc(F(bx),F(by-18),2,0,3.14,true);ctx.fill();
  // Small ear sensors
  R(bx-7,by-15,2,3,outline);R(bx-6,by-14,1,2,blueMid);
  R(bx+5,by-15,2,3,outline);R(bx+5,by-14,1,2,blueMid);
  // VISOR - pink/magenta band across face
  if(f===1){
    R(bx-3,by-15,9,4,outline);
    R(bx-2,by-14,8,3,visorDark);
    R(bx-1,by-14,7,2,visor);
    R(bx,by-13,5,1,visorGlow);
    ctx.globalAlpha=0.35;R(bx-2,by-16,8,5,visorGlow);ctx.globalAlpha=1;
  } else {
    R(bx-6,by-15,9,4,outline);
    R(bx-5,by-14,8,3,visorDark);
    R(bx-5,by-14,7,2,visor);
    R(bx-4,by-13,5,1,visorGlow);
    ctx.globalAlpha=0.35;R(bx-5,by-16,8,5,visorGlow);ctx.globalAlpha=1;
  }
  // TORSO - cyan armor with gradient shading
  R(bx-5,by-10,10,8,outline);
  R(bx-4,by-9,8,6,blueDark);
  R(bx-3,by-8,6,4,blueMid);
  R(bx-2,by-7,4,2,blueLight);
  // Edge highlights
  R(bx-4,by-9,1,5,blueLight);R(bx+3,by-9,1,5,blueLight);
  R(bx-3,by-9,1,2,blueBright);R(bx+2,by-9,1,2,blueBright);
  // PINK CORE - glowing center (matches visor)
  R(bx-1,by-7,2,2,outline);
  R(bx-1,by-7,2,2,coreGlow);
  ctx.globalAlpha=0.5+Math.sin(shimmerOffset*6)*0.2;
  R(bx-2,by-8,4,4,visor);ctx.globalAlpha=1;
  // Belt
  R(bx-4,by-3,8,2,outline);R(bx-3,by-2,6,1,blueMid);
  // SHOULDERS - rounded pauldrons with cyan gradient
  R(bx-10,by-11,5,5,outline);R(bx-9,by-10,4,4,blueDark);R(bx-8,by-9,3,3,blueMid);
  R(bx-9,by-10,1,3,blueLight);R(bx-7,by-9,1,2,blueBright);
  R(bx+5,by-11,5,5,outline);R(bx+5,by-10,4,4,blueDark);R(bx+5,by-9,3,3,blueMid);
  R(bx+8,by-10,1,3,blueLight);R(bx+6,by-9,1,2,blueBright);
  // ARMS with cyan gradient
  if(frame===4){
    R(bx-9,by-14,3,8,outline);R(bx-8,by-13,2,7,blueDark);R(bx-8,by-13,1,6,blueMid);
    R(bx-7,by-12,1,4,blueLight);
    R(bx+6,by-14,3,8,outline);R(bx+6,by-13,2,7,blueDark);R(bx+6,by-13,1,6,blueMid);
    R(bx+6,by-12,1,4,blueLight);
    R(bx-8,by-7,2,2,outline);R(bx-7,by-6,1,1,blueBright); // hand
    R(bx+6,by-7,2,2,outline);R(bx+6,by-6,1,1,blueBright);
  } else {
    var ao=frame===1?-1:frame===3?1:0;
    R(bx-9,by-7+ao,3,9,outline);R(bx-8,by-6+ao,2,8,blueDark);R(bx-8,by-6+ao,1,7,blueMid);
    R(bx-7,by-5+ao,1,5,blueLight);
    R(bx+6,by-7-ao,3,9,outline);R(bx+6,by-6-ao,2,8,blueDark);R(bx+6,by-6-ao,1,7,blueMid);
    R(bx+6,by-5-ao,1,5,blueLight);
    R(bx-8,by+ao,2,2,outline);R(bx-7,by+1+ao,1,1,blueBright); // hands
    R(bx+6,by-ao,2,2,outline);R(bx+6,by+1-ao,1,1,blueBright);
  }
  // BLASTER GUN - chunky sci-fi style with copper accents
  if(boss.active&&!boss.defeated){
    var gx=f===1?bx+6:bx-14;
    var gy=by-7;
    var copperDark="#8b4513";
    var copperMid="#b87333";
    var copperLight="#cd7f32";
    var gunmetal="#2a2a2a";
    var gunmetalLight="#3d3d3d";
    // Main gun body - dark gunmetal
    R(gx,gy,10,5,outline);
    R(gx+1,gy+1,8,3,gunmetal);
    R(gx+2,gy+1,6,1,gunmetalLight);
    // Upper barrel - copper tube
    R(gx+(f===1?8:-2),gy-1,6,3,outline);
    R(gx+(f===1?9:-1),gy,4,2,copperDark);
    R(gx+(f===1?9:-1),gy,4,1,copperMid);
    // Lower barrel - copper tube
    R(gx+(f===1?8:-2),gy+3,6,3,outline);
    R(gx+(f===1?9:-1),gy+3,4,2,copperDark);
    R(gx+(f===1?10:0),gy+3,2,1,copperMid);
    // Copper accent piece on body
    R(gx+3,gy+1,2,3,copperMid);
    R(gx+3,gy+1,1,2,copperLight);
    // Grip area
    R(gx+(f===1?0:8),gy+3,2,3,outline);
    R(gx+(f===1?0:8),gy+3,2,2,gunmetalLight);
    // Muzzle glow when recently fired
    if(playerLaserCooldown>PLAYER_LASER_COOLDOWN*0.7){
      ctx.globalAlpha=0.7;
      ctx.fillStyle="#44ffff";
      var muzzleX=f===1?gx+14:gx-2;
      ctx.beginPath();ctx.arc(F(muzzleX),F(gy+1),2,0,6.29);ctx.fill();
      ctx.beginPath();ctx.arc(F(muzzleX),F(gy+4),2,0,6.29);ctx.fill();
      ctx.globalAlpha=0.3;
      ctx.beginPath();ctx.arc(F(muzzleX),F(gy+2),5,0,6.29);ctx.fill();
      ctx.globalAlpha=1;
    }
  }
  // LEGS - cyan gradient
  if(frame===4){
    R(bx-4,by-1,3,5,outline);R(bx-3,by,2,4,blueDark);R(bx-3,by,1,3,blueMid);
    R(bx-2,by+1,1,2,blueLight);
    R(bx+1,by-1,3,5,outline);R(bx+1,by,2,4,blueDark);R(bx+1,by,1,3,blueMid);
    R(bx+2,by+1,1,2,blueLight);
    R(bx-4,by+3,4,1,blueBright);R(bx+1,by+3,4,1,blueBright); // boots
  } else {
    R(bx-5,by-1+lf,4,6+Math.abs(lf),outline);R(bx-4,by+lf,3,5+Math.abs(lf),blueDark);
    R(bx-4,by+lf,2,4+Math.abs(lf),blueMid);R(bx-3,by+1+lf,1,3,blueLight);
    R(bx+1,by-1+rf,4,6+Math.abs(rf),outline);R(bx+1,by+rf,3,5+Math.abs(rf),blueDark);
    R(bx+1,by+rf,2,4+Math.abs(rf),blueMid);R(bx+2,by+1+rf,1,3,blueLight);
    // Boots with cyan highlight
    R(bx-5,by+4+lf,5,1,outline);R(bx-4,by+3+lf,3,1,blueBright);R(bx-5,by+4+lf,2,1,glowEdge);
    R(bx+1,by+4+rf,5,1,outline);R(bx+1,by+3+rf,3,1,blueBright);R(bx+1,by+4+rf,2,1,glowEdge);
  }
  // Antenna - small with cyan tip
  R(bx+f*3,by-20,1,2,blueMid);R(bx+f*3,by-21,1,1,visor);
  if(isDashing){
    ctx.globalAlpha=0.4;R(bx-f*8-4,by-10,8,7,blueLight);
    ctx.globalAlpha=0.2;R(bx-f*16-3,by-8,6,4,blueLight);
    ctx.globalAlpha=0.1;R(bx-f*22-2,by-7,4,3,blueLight);
    ctx.globalAlpha=1;
  }
  if(hasInvinc) ctx.restore();
}

function drawEnemies(){
  for(var i=0;i<enemies.length;i++){
    var en=enemies[i],sx=wxf(en.x),sy=en.y;
    if(sx<-30||sx>W+30) continue;
    drawShadow(sx,GROUND_Y+1,6);
    // SNES-style detailed speeder bike
    var outline="#2a1a2a";
    // Main body with shading
    R(sx-8,sy-4,16,9,outline);
    R(sx-7,sy-3,14,7,C_SHIP_BODY);R(sx-6,sy-2,12,5,C_SHIP_DARK);
    R(sx-5,sy-1,10,3,"#665566"); // mid tone
    R(sx-4,sy-2,8,1,"#887788"); // top highlight
    // Front wings/fins
    R(sx-10,sy-3,3,6,outline);R(sx-9,sy-2,2,4,C_SHIP_WING);
    R(sx-9,sy-2,1,2,"#776677"); // wing highlight
    // Rear fins (top and bottom)
    R(sx+6,sy-7,3,4,outline);R(sx+6,sy+3,3,4,outline);
    R(sx+6,sy-6,2,3,C_SHIP_WING);R(sx+6,sy+3,2,3,C_SHIP_WING);
    R(sx+6,sy-6,1,2,"#665566");R(sx+6,sy+4,1,2,"#665566");
    // Cockpit/eye
    R(sx-7,sy-2,4,3,outline);
    R(sx-6,sy-1,3,2,en.telegraphing?"#ff4422":C_SHIP_COCKPIT);
    R(sx-5,sy,1,1,"#ffee88"); // pilot highlight
    // Engine glow
    R(sx+7,sy-2,3,4,outline);R(sx+7,sy-1,2,2,C_SHIP_GLOW);
    ctx.globalAlpha=0.3;R(sx+9,sy-2,4,4,C_SHIP_GLOW);ctx.globalAlpha=1;
    // Panel lines
    R(sx-2,sy-3,1,6,outline);R(sx+2,sy-2,1,4,"#332233");
    if(en.telegraphing){
      ctx.globalAlpha=0.5+Math.sin(en.telegraphTimer*20)*0.3;
      R(sx-11,sy-1,3,2,"#ff2222");ctx.globalAlpha=1;
    }
  }
}

function drawFliers(){
  for(var i=0;i<fliers.length;i++){
    var fl=fliers[i],sx=wxf(fl.x),sy=fl.y;
    if(sx<-30||sx>W+30) continue;
    drawShadow(sx,GROUND_Y+1,5);
    var outline="#223344";
    // SNES-style flying droid
    // Body with more detail
    R(sx-5,sy-4,10,7,outline);
    R(sx-4,sy-3,8,5,C_FLIER_BODY);
    R(sx-3,sy-2,6,3,"#667799"); // mid tone
    R(sx-3,sy-3,4,1,"#8899bb"); // top highlight
    // Wings with animation
    var wingFlap=Math.sin(fl.age*12)*2;
    R(sx-9,sy-2+wingFlap,5,3,outline);R(sx-8,sy-1+wingFlap,4,2,C_FLIER_WING);
    R(sx-8,sy-1+wingFlap,2,1,"#667799");
    R(sx+4,sy-2-wingFlap,5,3,outline);R(sx+4,sy-1-wingFlap,4,2,C_FLIER_WING);
    R(sx+4,sy-1-wingFlap,2,1,"#667799");
    // Eye/sensor with glow
    R(sx-4,sy-2,3,3,outline);
    R(sx-3,sy-1,2,2,fl.telegraphing?"#ff2222":C_FLIER_EYE);
    if(fl.telegraphing){ctx.globalAlpha=0.4;R(sx-4,sy-2,4,3,"#ff4422");ctx.globalAlpha=1;}
    R(sx-2,sy-1,1,1,"#ffcc88"); // eye highlight
    // Thruster
    R(sx+2,sy-1,2,2,"#445566");
    ctx.globalAlpha=0.3;R(sx+4,sy-1,3,2,"#4488aa");ctx.globalAlpha=1;
  }
}

function drawDrops(){
  for(var i=0;i<drops.length;i++){
    var dr=drops[i],sx=wxf(dr.x),sy=dr.y;
    if(sx<-10||sx>W+10) continue;
    // SNES-style coin/orb collectible
    var bob=Math.sin(dr.age*4)*1.5; // floating animation
    sy+=bob;
    ctx.globalAlpha=0.25;ctx.fillStyle=C_DROP_GLOW;
    ctx.beginPath();ctx.arc(F(sx),F(sy),8,0,6.29);ctx.fill();
    ctx.globalAlpha=1;
    // Coin outline
    R(sx-4,sy-4,8,8,"#885511");
    R(sx-3,sy-3,6,6,C_DROP);
    R(sx-2,sy-2,4,4,"#cc8833");
    // Shine highlight
    R(sx-2,sy-3,3,1,"#eebb55");
    R(sx-3,sy-2,1,2,"#eebb55");
    R(sx,sy,1,1,"#ffdd88");
    // Sparkle
    var sparkle=Math.sin(dr.age*8)>0.7;
    if(sparkle){
      ctx.globalAlpha=0.6;R(sx-1,sy-5,2,1,"#fff");R(sx-5,sy-1,1,2,"#fff");ctx.globalAlpha=1;
    }
  }
}

function drawDroids(){
  for(var i=0;i<droids.length;i++){
    var drd=droids[i],sx=wxf(drd.x),sy=drd.y;
    if(sx<-30||sx>W+30) continue;
    drawShadow(sx,GROUND_Y+1,4);
    // Level 2 droids are red
    var dBody=level===2?C2_DROID_BODY:C_DROID_BODY;
    var dDark=level===2?C2_DROID_DARK:C_DROID_DARK;
    var dLight=level===2?C2_DROID_LIGHT:C_DROID_LIGHT;
    var dEye=level===2?C2_DROID_EYE:C_DROID_EYE;
    var outline=level===2?"#220808":"#223322";
    // SNES-style detailed battle droid
    // Body with panel details
    R(sx-5,sy-11,10,12,outline);
    R(sx-4,sy-10,8,10,dBody);
    R(sx-3,sy-9,6,8,dDark);
    R(sx-2,sy-8,4,1,dLight); // chest highlight
    R(sx-3,sy-5,6,1,outline); // panel line
    R(sx-2,sy-4,4,2,dDark); // waist
    // Head with detail
    R(sx-4,sy-14,8,4,outline);
    R(sx-3,sy-13,6,3,dLight);
    R(sx-2,sy-12,4,2,dBody);
    R(sx-2,sy-13,4,1,level===2?"#aa6666":"#99bbaa"); // top highlight
    // Eye/visor
    R(sx-2,sy-12,4,2,outline);
    R(sx-1,sy-11,3,1,drd.telegraphing?"#ffffff":dEye);
    if(drd.telegraphing){ctx.globalAlpha=0.3;R(sx-2,sy-12,4,2,dEye);ctx.globalAlpha=1;}
    // Shoulders
    R(sx-6,sy-10,3,3,outline);R(sx+3,sy-10,3,3,outline);
    R(sx-5,sy-9,2,2,dBody);R(sx+3,sy-9,2,2,dBody);
    // Arms
    R(sx-6,sy-8,2,5,outline);R(sx+4,sy-8,2,5,outline);
    R(sx-5,sy-7,1,4,dDark);R(sx+4,sy-7,1,4,dDark);
    // Legs
    R(sx-4,sy-1,3,3,outline);R(sx+1,sy-1,3,3,outline);
    R(sx-3,sy,2,2,dDark);R(sx+1,sy,2,2,dDark);
    // Feet
    R(sx-4,sy+1,3,1,"#333");R(sx+1,sy+1,3,1,"#333");
    // Telegraphing arm glow
    if(drd.telegraphing){
      ctx.globalAlpha=0.5+Math.sin(drd.telegraphTimer*30)*0.3;
      R(sx-7,sy-7,3,2,"#ff4444");R(sx+4,sy-7,3,2,"#ff4444");
      ctx.globalAlpha=1;
    }
  }
}

function drawLasers(){
  for(var i=0;i<lasers.length;i++){
    var las=lasers[i],sx=wxf(las.x),sy=las.y;
    if(sx<-20||sx>W+20) continue;
    ctx.globalAlpha=0.3;ctx.fillStyle=C_LASER_GLOW;
    R(sx-8,sy-3,16,6,C_LASER_GLOW);
    ctx.globalAlpha=1;
    R(sx-6,sy-1,12,2,C_LASER);
    R(sx-4,sy,8,1,"#ff6666");
  }
}

// Level 3 enemies
function drawBigworms(){
  for(var i=0;i<bigworms.length;i++){
    var bw=bigworms[i];
    var sx=wxf(bw.x);
    if(sx<-100||sx>W+100) continue;
    var segments=8;
    var segLen=bw.length/segments;
    for(var si=0;si<segments;si++){
      var segX=sx+(si*segLen-bw.length/2);
      var segH=7+Math.sin((si/segments)*Math.PI)*7;
      var segW=segLen+1;
      var cr=F(100-si*5),cg=F(60-si*4),cb=F(45-si*3);
      ctx.fillStyle="rgb("+Math.max(cr,40)+","+Math.max(cg,25)+","+Math.max(cb,20)+")";
      ctx.beginPath();ctx.ellipse(F(segX),GROUND_Y,segW/2,segH,0,Math.PI,0);ctx.fill();
      ctx.globalAlpha=0.25;ctx.fillStyle="#aa8866";
      ctx.fillRect(F(segX-segW/4),GROUND_Y-segH,F(segW/2),1);ctx.globalAlpha=1;
    }
    var headX=sx-bw.length/2;
    ctx.fillStyle=C_BIGWORM;
    ctx.beginPath();ctx.arc(F(headX),GROUND_Y-6,6,0,6.29);ctx.fill();
    R(F(headX)-3,GROUND_Y-9,3,2,bw.telegraphing?"#ff2222":C_BIGWORM_EYE);
    // Mandibles
    R(F(headX)-6,GROUND_Y-4,3,2,C_BIGWORM_DARK);
    R(F(headX)+3,GROUND_Y-4,3,2,C_BIGWORM_DARK);
  }
}

function drawDaggers(){
  for(var i=0;i<daggers.length;i++){
    var dg=daggers[i],sx=wxf(dg.x),sy=dg.y;
    if(sx<-10||sx>W+10) continue;
    ctx.globalAlpha=0.3;ctx.fillStyle=C_DAGGER_GLOW;
    ctx.beginPath();ctx.arc(F(sx),F(sy),6,0,6.29);ctx.fill();
    ctx.globalAlpha=1;
    // Dagger shape
    R(sx-1,sy-5,2,8,C_DAGGER);
    R(sx-2,sy-3,4,2,"#cc8855");
    R(sx,sy-6,1,2,"#ddaa77");
  }
}

function drawSpiders(){
  for(var i=0;i<spiders.length;i++){
    var sp=spiders[i],sx=wxf(sp.x),sy=sp.y;
    if(sx<-20||sx>W+20) continue;
    // Body (on ceiling)
    R(sx-4,sy-3,8,6,C_SPIDER);
    R(sx-3,sy-2,6,4,C_SPIDER_DARK);
    // Eyes
    R(sx-2,sy,2,2,sp.telegraphing?"#ffff44":C_SPIDER_EYE);
    R(sx+1,sy,2,2,sp.telegraphing?"#ffff44":C_SPIDER_EYE);
    // Legs (4 on each side)
    var legWiggle=Math.sin(shimmerOffset*8)*1;
    R(sx-7,sy-1+legWiggle,3,1,C_SPIDER_DARK);
    R(sx-6,sy+1-legWiggle,2,1,C_SPIDER_DARK);
    R(sx+4,sy-1-legWiggle,3,1,C_SPIDER_DARK);
    R(sx+4,sy+1+legWiggle,2,1,C_SPIDER_DARK);
    // Thread to ceiling
    ctx.globalAlpha=0.3;
    R(sx,0,1,sy-3,"#888");
    ctx.globalAlpha=1;
  }
}

function drawGooDrops(){
  for(var i=0;i<gooDrops.length;i++){
    var goo=gooDrops[i],sx=wxf(goo.x),sy=goo.y;
    if(sx<-10||sx>W+10) continue;
    ctx.globalAlpha=0.3;ctx.fillStyle=C_GOO_GLOW;
    ctx.beginPath();ctx.arc(F(sx),F(sy),7,0,6.29);ctx.fill();
    ctx.globalAlpha=0.8;
    ctx.fillStyle=C_GOO;
    ctx.beginPath();ctx.arc(F(sx),F(sy),4,0,6.29);ctx.fill();
    ctx.fillStyle="#88ff99";
    ctx.beginPath();ctx.arc(F(sx),F(sy-1),2,0,6.29);ctx.fill();
    ctx.globalAlpha=1;
  }
}

function drawTorches(){
  for(var i=0;i<torches.length;i++){
    var t=torches[i],sx=wxf(t.x);
    if(sx<-30||sx>W+30) continue;
    t.flicker+=0.1;
    var flick=Math.sin(t.flicker*5)*0.15+0.85;
    // Torch holder
    R(sx-1,GROUND_Y-12,2,8,"#4a3020");
    R(sx-2,GROUND_Y-14,4,3,"#3a2515");
    // Fire glow
    ctx.globalAlpha=0.15*flick;ctx.fillStyle=C_TORCH_GLOW;
    ctx.beginPath();ctx.arc(F(sx),GROUND_Y-18,20,0,6.29);ctx.fill();
    ctx.globalAlpha=0.25*flick;
    ctx.beginPath();ctx.arc(F(sx),GROUND_Y-18,12,0,6.29);ctx.fill();
    ctx.globalAlpha=1;
    // Fire
    R(sx-2,GROUND_Y-20,4,6,C_TORCH);
    R(sx-1,GROUND_Y-22,2,3,"#ffaa22");
    R(sx,GROUND_Y-24+Math.sin(t.flicker*8),1,2,"#ffdd44");
  }
}

// === BOSS ARENA WALLS ===
function drawBossArenaWalls(){
  if(!boss.active||boss.defeated) return;
  // Draw rocky walls on left and right edges of arena
  var wallW=15;
  var wallH=60;
  var leftX=wxf(bossArenaLeft);
  var rightX=wxf(bossArenaRight);
  // Left wall
  ctx.fillStyle="#3a2a1a";
  ctx.fillRect(F(leftX-wallW),GROUND_Y-wallH,wallW,wallH);
  ctx.fillStyle="#4a3a2a";
  ctx.fillRect(F(leftX-wallW+2),GROUND_Y-wallH+5,wallW-4,wallH-5);
  ctx.fillStyle="#2a1a0a";
  ctx.fillRect(F(leftX-3),GROUND_Y-wallH,3,wallH);
  // Right wall
  ctx.fillStyle="#3a2a1a";
  ctx.fillRect(F(rightX),GROUND_Y-wallH,wallW,wallH);
  ctx.fillStyle="#4a3a2a";
  ctx.fillRect(F(rightX+2),GROUND_Y-wallH+5,wallW-4,wallH-5);
  ctx.fillStyle="#2a1a0a";
  ctx.fillRect(F(rightX),GROUND_Y-wallH,3,wallH);
  // Rock texture spots
  ctx.fillStyle="#5a4a3a";
  for(var i=0;i<5;i++){
    var ry=GROUND_Y-10-i*10;
    ctx.fillRect(F(leftX-wallW+4+i%3*3),ry,3,3);
    ctx.fillRect(F(rightX+4+(i+1)%3*3),ry,3,3);
  }
}

// === BOSS DRAWING ===
// Dune-style sandworm with gaping mouth and teeth
function drawBoss(){
  if(!boss.active) return;
  var sx=wxf(boss.x);
  var sy=boss.y;
  if(sx<-100||sx>W+100) return;

  // === BURROWING TELEGRAPH - Sand bulge/disturbance ===
  if(boss.state==="burrowing"){
    var rumbleIntensity=1-boss.timer/BOSS_BURROW_TIME;
    var bulgeSize=20+rumbleIntensity*25;
    var pulseOffset=Math.sin(gameTime*12)*3*rumbleIntensity;
    // Dark crack lines radiating from center
    ctx.strokeStyle="rgba(40,30,20,0.6)";
    ctx.lineWidth=2;
    for(var c=0;c<6;c++){
      var angle=c*Math.PI/3+gameTime*2;
      var len=8+rumbleIntensity*15;
      ctx.beginPath();
      ctx.moveTo(F(sx),GROUND_Y-2);
      ctx.lineTo(F(sx+Math.cos(angle)*len),GROUND_Y-2+Math.sin(angle)*len*0.4);
      ctx.stroke();
    }
    // Bulging mound of sand
    ctx.fillStyle="#7a6a5a";
    ctx.beginPath();
    ctx.ellipse(F(sx),GROUND_Y-3+pulseOffset,bulgeSize,8+rumbleIntensity*6,0,Math.PI,0);
    ctx.fill();
    // Highlight on mound
    ctx.fillStyle="rgba(170,150,130,0.5)";
    ctx.beginPath();
    ctx.ellipse(F(sx),GROUND_Y-6+pulseOffset,bulgeSize*0.7,4+rumbleIntensity*3,0,Math.PI,0);
    ctx.fill();
    // Warning indicator - pulsing glow
    ctx.globalAlpha=0.3+rumbleIntensity*0.4;
    ctx.fillStyle="#ff6644";
    ctx.beginPath();
    ctx.ellipse(F(sx),GROUND_Y-4,15+Math.sin(gameTime*10)*5,6,0,0,6.29);
    ctx.fill();
    ctx.globalAlpha=1;
    return; // Don't draw worm body yet
  }

  if(boss.state==="underground") return;

  var flashWhite=boss.flashTimer>0&&Math.sin(boss.flashTimer*40)>0;
  // Mouth ONLY vulnerable during spit attack (wide open)
  var isVulnerable=boss.state==="attacking"&&boss.currentAttack==="spit";
  // Visual mouth opening: slightly open normally, wide during telegraph/attack
  var mouthOpen=0.3;
  if(boss.telegraphing) mouthOpen=0.6;
  if(boss.state==="attacking"){
    if(boss.currentAttack==="spit") mouthOpen=1.2; // Wide open = vulnerable!
    else if(boss.currentAttack==="lunge") mouthOpen=0.8;
  }

  // Ground burst effect
  if(boss.state==="spawning"||boss.state==="submerging"){
    ctx.globalAlpha=0.5;
    for(var d=0;d<12;d++){
      var dx=sx+(Math.random()-0.5)*70;
      var ds=2+Math.random()*4;
      ctx.fillStyle=Math.random()<0.5?"#8a7a6a":"#6a5a4a";
      ctx.beginPath();ctx.arc(F(dx),GROUND_Y-Math.random()*15,ds,0,6.29);ctx.fill();
    }
    ctx.globalAlpha=1;
  }

  // Large shadow
  if(boss.state!=="spawning"||boss.timer<BOSS_EMERGE_TIME*0.5){
    ctx.globalAlpha=0.35;ctx.fillStyle="#000";
    ctx.beginPath();ctx.ellipse(F(sx),GROUND_Y+3,40,8,0,0,6.29);ctx.fill();
    ctx.globalAlpha=1;
  }

  var visibleHeight=GROUND_Y-sy;
  var bodyWidth=32; // Much wider body

  // Draw body segments from bottom to top
  var segCount=16;
  for(var i=segCount-1;i>=0;i--){
    var t=i/segCount;
    var segY=sy+t*visibleHeight;
    if(segY>GROUND_Y-3) continue;

    var wave=Math.sin(gameTime*2.5+i*0.4)*3*(1-t*0.5);
    var segX=sx+wave;
    var segW=bodyWidth*(0.7+t*0.3); // Narrower at top, wider at bottom
    var segH=visibleHeight/segCount+2;

    if(flashWhite){
      // Flash white when hurt
      ctx.fillStyle="#ffffff";
      ctx.beginPath();ctx.ellipse(F(segX),F(segY),segW/2,segH/2+1,0,0,6.29);ctx.fill();
    } else {
      // Base segment - pale grayish flesh tone
      var baseLight=180-t*40;
      ctx.fillStyle="rgb("+F(baseLight)+","+F(baseLight-15)+","+F(baseLight-25)+")";
      ctx.beginPath();ctx.ellipse(F(segX),F(segY),segW/2,segH/2+1,0,0,6.29);ctx.fill();

      // Deep ridge/groove between segments
      ctx.fillStyle="rgba(60,40,30,0.6)";
      ctx.beginPath();ctx.ellipse(F(segX),F(segY+segH/2-1),segW/2+1,2,0,0,6.29);ctx.fill();

      // Segment ridge highlight
      ctx.fillStyle="rgba(255,240,220,0.25)";
      ctx.beginPath();ctx.ellipse(F(segX),F(segY-segH/3),segW/2-2,2,0,Math.PI,0);ctx.fill();

      // Left side shadow (3D effect)
      ctx.fillStyle="rgba(80,50,40,0.35)";
      ctx.beginPath();
      ctx.ellipse(F(segX-segW/4),F(segY),segW/4,segH/2,0,Math.PI*0.5,Math.PI*1.5);ctx.fill();

      // Right side highlight
      ctx.fillStyle="rgba(255,245,235,0.2)";
      ctx.beginPath();
      ctx.ellipse(F(segX+segW/4),F(segY),segW/5,segH/2.5,0,Math.PI*1.5,Math.PI*0.5);ctx.fill();

      // Bumps/nodules on body
      if(i%3===0){
        var bumpY=segY;
        ctx.fillStyle="rgb("+F(baseLight+10)+","+F(baseLight-5)+","+F(baseLight-15)+")";
        ctx.beginPath();ctx.arc(F(segX-segW/3),F(bumpY),3,0,6.29);ctx.fill();
        ctx.beginPath();ctx.arc(F(segX+segW/3),F(bumpY),3,0,6.29);ctx.fill();
        // Bump highlights
        ctx.fillStyle="rgba(255,250,240,0.3)";
        ctx.beginPath();ctx.arc(F(segX-segW/3-1),F(bumpY-1),1,0,6.29);ctx.fill();
        ctx.beginPath();ctx.arc(F(segX+segW/3-1),F(bumpY-1),1,0,6.29);ctx.fill();
      }

      // Wrinkle lines
      if(i%2===0){
        ctx.strokeStyle="rgba(100,70,50,0.25)";ctx.lineWidth=1;
        ctx.beginPath();
        ctx.moveTo(F(segX-segW/3),F(segY-1));
        ctx.quadraticCurveTo(F(segX),F(segY+2),F(segX+segW/3),F(segY-1));
        ctx.stroke();
      }
    }
  }

  // Draw the massive head/mouth
  drawBossHead(sx,sy,flashWhite,mouthOpen,bodyWidth,isVulnerable);

  // Defeated explosion
  if(boss.defeated){
    var progress=1-boss.defeatTimer/BOSS_DEFEATED_TIME;
    ctx.globalAlpha=0.4*(1-progress);
    ctx.fillStyle="#ff6644";
    ctx.beginPath();ctx.arc(F(sx),F(sy-25),35+progress*50,0,6.29);ctx.fill();
    ctx.globalAlpha=1;
    if(Math.random()<0.4){
      spawnParticles(sx+cam.x+(Math.random()-0.5)*60,sy-30+(Math.random()-0.5)*40,
        Math.random()<0.3?"#ffffff":Math.random()<0.5?"#ff6644":"#ffaa44",4);
    }
  }
}

function drawBossHead(sx,headBaseY,flashWhite,mouthOpen,bodyWidth,isVulnerable){
  var headY=headBaseY-5;
  var mouthRadius=bodyWidth/2+4;
  var openAmount=mouthOpen*12; // How far mouth opens

  if(flashWhite){
    // Simple white flash
    ctx.fillStyle="#ffffff";
    ctx.beginPath();ctx.arc(F(sx),F(headY-10),mouthRadius+5,0,6.29);ctx.fill();
    return;
  }

  // Outer lip/rim of mouth - pale flesh
  ctx.fillStyle="#c8b8a8";
  ctx.beginPath();ctx.arc(F(sx),F(headY-openAmount/2),mouthRadius+6,0,6.29);ctx.fill();

  // Mouth rim shadow
  ctx.fillStyle="rgba(60,40,30,0.4)";
  ctx.beginPath();ctx.arc(F(sx),F(headY-openAmount/2+3),mouthRadius+4,0,Math.PI);ctx.fill();

  // Inner mouth cavity - dark red/pink OR glowing cyan when vulnerable
  var innerRadius=mouthRadius-2;
  if(isVulnerable){
    // Pulsing cyan/blue glow - SHOOT NOW!
    var pulse=0.6+Math.sin(gameTime*10)*0.4;
    ctx.globalAlpha=0.4*pulse;
    ctx.fillStyle="#00ffff";
    ctx.beginPath();ctx.arc(F(sx),F(headY-openAmount/2),innerRadius+8,0,6.29);ctx.fill();
    ctx.globalAlpha=1;
    // Cyan inner glow
    var vGrad=ctx.createRadialGradient(sx,headY-openAmount/2,0,sx,headY-openAmount/2,innerRadius+5);
    vGrad.addColorStop(0,"#44ffff");
    vGrad.addColorStop(0.3,"#22aaaa");
    vGrad.addColorStop(0.6,"#115555");
    vGrad.addColorStop(1,"#082828");
    ctx.fillStyle=vGrad;
  } else {
    var grad=ctx.createRadialGradient(sx,headY-openAmount/2,0,sx,headY-openAmount/2,innerRadius+10);
    grad.addColorStop(0,"#2a0808");
    grad.addColorStop(0.4,"#4a1515");
    grad.addColorStop(0.7,"#6a2a2a");
    grad.addColorStop(1,"#8a4a4a");
    ctx.fillStyle=grad;
  }
  ctx.beginPath();ctx.arc(F(sx),F(headY-openAmount/2),innerRadius+2,0,6.29);ctx.fill();

  // Throat depth - darker center
  ctx.fillStyle=isVulnerable?"#00aaaa":"#1a0505";
  ctx.beginPath();ctx.arc(F(sx),F(headY-openAmount/2+5),innerRadius/2,0,6.29);ctx.fill();

  // Fleshy ridges inside mouth
  ctx.strokeStyle=isVulnerable?"rgba(0,200,200,0.5)":"rgba(100,40,40,0.5)";ctx.lineWidth=1;
  for(var r=0;r<3;r++){
    var ridgeR=innerRadius-r*5-3;
    if(ridgeR>5){
      ctx.beginPath();ctx.arc(F(sx),F(headY-openAmount/2),ridgeR,0,6.29);ctx.stroke();
    }
  }

  // TEETH - multiple rows around the mouth opening
  var teethCount=16;
  var teethRows=3;
  for(var row=0;row<teethRows;row++){
    var toothRadius=innerRadius-row*4+2;
    var toothLen=6-row*1.5;
    var toothBase=3-row*0.5;

    for(var t=0;t<teethCount;t++){
      var angle=(t/teethCount)*Math.PI*2;
      var tx=sx+Math.cos(angle)*toothRadius;
      var ty=headY-openAmount/2+Math.sin(angle)*toothRadius;
      var tipX=sx+Math.cos(angle)*(toothRadius-toothLen);
      var tipY=headY-openAmount/2+Math.sin(angle)*(toothRadius-toothLen);

      // Tooth base
      ctx.fillStyle=row===0?"#e8e0d8":"#d8d0c8";
      ctx.beginPath();
      ctx.moveTo(F(tx-Math.sin(angle)*toothBase),F(ty+Math.cos(angle)*toothBase));
      ctx.lineTo(F(tipX),F(tipY));
      ctx.lineTo(F(tx+Math.sin(angle)*toothBase),F(ty-Math.cos(angle)*toothBase));
      ctx.fill();

      // Tooth highlight
      if(row===0){
        ctx.fillStyle="rgba(255,255,250,0.6)";
        ctx.beginPath();ctx.arc(F(tx),F(ty),1,0,6.29);ctx.fill();
      }
    }
  }

  // Gum tissue between teeth rows
  ctx.fillStyle="#8a5050";
  ctx.beginPath();ctx.arc(F(sx),F(headY-openAmount/2),innerRadius-2,0,6.29);ctx.stroke();

  // Outer mouth lip detail - fleshy folds
  for(var fold=0;fold<8;fold++){
    var foldAngle=(fold/8)*Math.PI*2+gameTime*0.1;
    var foldX=sx+Math.cos(foldAngle)*(mouthRadius+3);
    var foldY=headY-openAmount/2+Math.sin(foldAngle)*(mouthRadius+3);
    ctx.fillStyle="rgba(180,160,150,0.5)";
    ctx.beginPath();ctx.ellipse(F(foldX),F(foldY),4,2,foldAngle,0,6.29);ctx.fill();
  }

  // Lip rim highlight
  ctx.strokeStyle="rgba(255,245,235,0.4)";ctx.lineWidth=2;
  ctx.beginPath();ctx.arc(F(sx),F(headY-openAmount/2),mouthRadius+5,Math.PI*1.2,Math.PI*1.8);ctx.stroke();

  // Lip rim shadow
  ctx.strokeStyle="rgba(80,50,40,0.5)";ctx.lineWidth=2;
  ctx.beginPath();ctx.arc(F(sx),F(headY-openAmount/2),mouthRadius+5,Math.PI*0.2,Math.PI*0.8);ctx.stroke();

  // Slime/drool strands when mouth open
  if(mouthOpen>0.5){
    ctx.strokeStyle="rgba(150,180,150,0.4)";ctx.lineWidth=1;
    for(var s=0;s<3;s++){
      var slimeX=sx-10+s*10;
      ctx.beginPath();
      ctx.moveTo(F(slimeX),F(headY-openAmount/2-innerRadius+5));
      ctx.quadraticCurveTo(F(slimeX+Math.sin(gameTime*3+s)*3),F(headY-openAmount/2),
        F(slimeX+2),F(headY-openAmount/2+innerRadius-5));
      ctx.stroke();
    }
  }

  // Acid glow in mouth when spitting
  if(boss.currentAttack==="spit"&&boss.state==="attacking"){
    ctx.globalAlpha=0.5+Math.sin(gameTime*10)*0.2;
    var acidGrad=ctx.createRadialGradient(sx,headY-openAmount/2,0,sx,headY-openAmount/2,innerRadius);
    acidGrad.addColorStop(0,"#88ff88");
    acidGrad.addColorStop(0.5,"#44aa44");
    acidGrad.addColorStop(1,"rgba(0,0,0,0)");
    ctx.fillStyle=acidGrad;
    ctx.beginPath();ctx.arc(F(sx),F(headY-openAmount/2),innerRadius,0,6.29);ctx.fill();
    ctx.globalAlpha=1;
  }

  // Telegraph indicator (danger!)
  if(boss.telegraphing){
    ctx.globalAlpha=0.4+Math.sin(gameTime*15)*0.3;
    ctx.fillStyle="#ff2222";
    ctx.beginPath();ctx.arc(F(sx),F(headY-openAmount-mouthRadius-15),10,0,6.29);ctx.fill();
    ctx.globalAlpha=1;
    ctx.fillStyle="#ffffff";
    R(sx-2,headY-openAmount-mouthRadius-22,4,10,"#ffffff");
    R(sx-2,headY-openAmount-mouthRadius-9,4,4,"#ffffff");
  }
}

function drawBossProjectiles(){
  for(var i=0;i<bossProjectiles.length;i++){
    var p=bossProjectiles[i],sx=wxf(p.x),sy=p.y;
    if(sx<-20||sx>W+20) continue;
    // Glow
    ctx.globalAlpha=0.25;ctx.fillStyle=C_GOO_GLOW;
    ctx.beginPath();ctx.arc(F(sx),F(sy),8,0,6.29);ctx.fill();
    ctx.globalAlpha=1;
    // Acid glob
    ctx.fillStyle="#44cc44";
    ctx.beginPath();ctx.arc(F(sx),F(sy),4,0,6.29);ctx.fill();
    ctx.fillStyle="#66ff66";
    ctx.beginPath();ctx.arc(F(sx),F(sy-1),2,0,6.29);ctx.fill();
    // Highlight
    ctx.fillStyle="#aaffaa";
    ctx.beginPath();ctx.arc(F(sx-1),F(sy-2),1,0,6.29);ctx.fill();
  }
}

function drawPlayerLasers(){
  for(var i=0;i<playerLasers.length;i++){
    var laser=playerLasers[i];
    var sx=wxf(laser.x),sy=laser.y;
    if(sx<-20||sx>W+20) continue;
    // Glow trail
    ctx.globalAlpha=0.3;
    ctx.fillStyle="#44ffff";
    ctx.beginPath();
    ctx.ellipse(F(sx-laser.vx*0.02),F(sy),12,3,0,0,6.29);
    ctx.fill();
    ctx.globalAlpha=1;
    // Laser bolt core
    ctx.fillStyle="#88ffff";
    ctx.beginPath();
    ctx.ellipse(F(sx),F(sy),6,2,0,0,6.29);
    ctx.fill();
    // Bright center
    ctx.fillStyle="#ffffff";
    ctx.beginPath();
    ctx.ellipse(F(sx),F(sy),3,1,0,0,6.29);
    ctx.fill();
  }
}

function drawProjectiles(){
  for(var i=0;i<projectiles.length;i++){
    var p=projectiles[i],sx=wxf(p.x),sy=p.y;
    if(sx<-10||sx>W+10) continue;
    ctx.globalAlpha=0.2;ctx.fillStyle=C_PROJ_GLOW;
    ctx.beginPath();ctx.arc(F(sx),F(sy),5,0,6.29);ctx.fill();
    ctx.globalAlpha=1;ctx.fillStyle=C_PROJ;
    ctx.beginPath();ctx.arc(F(sx),F(sy),2,0,6.29);ctx.fill();
    ctx.fillStyle="#ff8888";
    ctx.beginPath();ctx.arc(F(sx),F(sy),1,0,6.29);ctx.fill();
  }
}

function drawHeartPickups(){
  for(var i=0;i<heartPickups.length;i++){
    var hp=heartPickups[i],sx=wxf(hp.x),sy=hp.y+Math.sin(hp.bob)*2;
    if(sx<-20||sx>W+20) continue;
    drawShadow(sx,GROUND_Y+1,5);
    ctx.globalAlpha=0.15+Math.sin(hp.bob*1.5)*0.05;ctx.fillStyle=C_HEART_PU_GLOW;
    ctx.beginPath();ctx.arc(F(sx),F(sy),8,0,6.29);ctx.fill();ctx.globalAlpha=1;
    R(sx-4,sy-4,3,3,C_HEART_PU);R(sx+1,sy-4,3,3,C_HEART_PU);
    R(sx-5,sy-3,10,4,C_HEART_PU);R(sx-4,sy+1,8,2,C_HEART_PU);
    R(sx-3,sy+3,6,1,C_HEART_PU);R(sx-2,sy+4,4,1,C_HEART_PU);R(sx-1,sy+5,2,1,C_HEART_PU);
    R(sx-3,sy-3,2,2,"#ff88aa");
    R(sx-1,sy-2,2,4,"#fff");R(sx-2,sy-1,4,2,"#fff");
  }
}

function drawPowerCells(){
  for(var i=0;i<powerCells.length;i++){
    var pw=powerCells[i],sx=wxf(pw.x),sy=pw.y+Math.sin(pw.bob)*2;
    if(sx<-20||sx>W+20) continue;
    drawShadow(sx,GROUND_Y+1,4);
    ctx.globalAlpha=0.15+Math.sin(pw.bob*2)*0.05;ctx.fillStyle=C_POWER_GLOW;
    ctx.beginPath();ctx.arc(F(sx),F(sy),7,0,6.29);ctx.fill();ctx.globalAlpha=1;
    R(sx-3,sy-6,6,12,C_POWER_MID);
    R(sx-2,sy-5,4,10,C_POWER);
    R(sx-1,sy-4,2,8,"#66ccff");
    R(sx-3,sy-7,6,2,"#6688aa");
    R(sx-3,sy+5,6,2,"#6688aa");
    R(sx,sy-2,1,4,"#aaeeff");
    R(sx-1,sy-8,2,1,"#8899aa");
    R(sx-1,sy+7,2,1,"#8899aa");
  }
}

function drawInvincPickups(){
  for(var i=0;i<invincPickups.length;i++){
    var inp=invincPickups[i],sx=wxf(inp.x),sy=inp.y+Math.sin(inp.bob)*3;
    if(sx<-20||sx>W+20) continue;
    drawShadow(sx,GROUND_Y+1,5);
    // Outer glow (centered on logo which extends right)
    var glowX=sx+4;
    ctx.globalAlpha=0.2+Math.sin(inp.bob*2)*0.1;ctx.fillStyle=C_INVINC_GLOW;
    ctx.beginPath();ctx.arc(F(glowX),F(sy),12,0,6.29);ctx.fill();
    ctx.globalAlpha=0.15;ctx.fillStyle="#ffffff";
    ctx.beginPath();ctx.arc(F(glowX),F(sy),10,0,6.29);ctx.fill();
    ctx.globalAlpha=1;
    // D logo from SVG - WIDE FLAT horizontal swoosh with 4-pointed star
    ctx.save();
    ctx.translate(F(sx),F(sy));
    // D swoosh - wide and flat (like a horizontal smile)
    ctx.fillStyle=C_INVINC;
    ctx.beginPath();
    // Outer edge - wide flat arc
    ctx.moveTo(-4,-4);     // top-left start (thin)
    ctx.quadraticCurveTo(4,-6,12,-2);  // sweep up-right
    ctx.quadraticCurveTo(14,0,12,2);   // right tip (thick)
    ctx.quadraticCurveTo(4,6,-4,4);    // sweep down-left
    // Inner edge - back to start
    ctx.quadraticCurveTo(2,3,8,1);     // inner bottom
    ctx.quadraticCurveTo(10,0,8,-1);   // inner right
    ctx.quadraticCurveTo(2,-3,-4,-4);  // inner top
    ctx.closePath();
    ctx.fill();
    // Highlight on right bulge
    ctx.fillStyle="#ffee88";
    ctx.beginPath();
    ctx.moveTo(10,-1);
    ctx.quadraticCurveTo(12,0,10,1);
    ctx.quadraticCurveTo(9,0,10,-1);
    ctx.fill();
    // 4-pointed star (inside the D opening)
    var stX=0;
    ctx.fillStyle=C_INVINC;
    ctx.beginPath();
    ctx.moveTo(stX-3,0);   // left point
    ctx.lineTo(stX,-3);    // top point
    ctx.lineTo(stX+2,0);   // right point
    ctx.lineTo(stX,3);     // bottom point
    ctx.closePath();
    ctx.fill();
    // Star highlight
    ctx.fillStyle="#ffee88";
    ctx.beginPath();
    ctx.arc(stX,0,1,0,6.29);
    ctx.fill();
    ctx.restore();
    // Sparkle
    var sparkle=Math.sin(inp.bob*3)>0.5;
    if(sparkle){
      ctx.globalAlpha=0.8;
      R(sx+10,sy,1,1,"#ffffff");
      R(sx+7,sy,2,2,"#ffffff");
      ctx.globalAlpha=1;
    }
  }
}

function drawSandworms(){
  for(var i=0;i<sandworms.length;i++){
    var wm=sandworms[i];
    var sx=wxf(wm.x);
    if(sx<-80||sx>W+80) continue;
    if(wm.state==="telegraph"){
      var intensity=1-(wm.timer/WORM_TELEGRAPH);
      ctx.globalAlpha=0.2+intensity*0.3;
      for(var li=0;li<5;li++){
        var lx=sx-12+li*6+(Math.random()-0.5)*3*intensity;
        var ly=GROUND_Y-1+(Math.random()-0.5)*2*intensity;
        R(lx,ly,2+Math.random()*2,1,level===1?"#a08060":"#605080");
      }
      ctx.globalAlpha=0.15+intensity*0.2;
      R(sx-8,GROUND_Y-1,16,1,level===1?"#8a7050":"#504070");
      R(sx-4+Math.sin(shimmerOffset*15)*2,GROUND_Y-2,8,1,level===1?"#9a8060":"#605080");
      ctx.globalAlpha=1;
    } else if(wm.state==="active"){
      var segments=6;
      var segLen=wm.length/segments;
      for(var si=0;si<segments;si++){
        var segX=sx+(si*segLen-wm.length/2);
        var segH=5+Math.sin((si/segments)*Math.PI)*5;
        var segW=segLen+1;
        var segY=GROUND_Y-segH;
        var cr,cg,cb;
        if(level===1){
          cr=F(120-si*5);cg=F(80-si*3);cb=F(90-si*4);
        } else {
          cr=F(90-si*4);cg=F(70-si*3);cb=F(110-si*5);
        }
        ctx.fillStyle="rgb("+Math.max(cr,50)+","+Math.max(cg,40)+","+Math.max(cb,60)+")";
        ctx.beginPath();ctx.ellipse(F(segX),GROUND_Y,segW/2,segH,0,Math.PI,0);ctx.fill();
        ctx.globalAlpha=0.2;ctx.fillStyle=level===1?"#aa8888":"#8888aa";
        ctx.fillRect(F(segX-segW/4),segY,F(segW/2),1);ctx.globalAlpha=1;
      }
      var headX=sx-wm.length/2;
      ctx.fillStyle=level===1?"#a06060":"#6060a0";
      ctx.beginPath();ctx.arc(F(headX),GROUND_Y-4,4,0,6.29);ctx.fill();
      R(F(headX)-2,GROUND_Y-6,2,1,"#ff6644");
      ctx.globalAlpha=0.15;ctx.fillStyle=level===1?"#c8a878":"#8878c8";
      ctx.beginPath();ctx.ellipse(F(headX-6),GROUND_Y-2,6,4,0,Math.PI,0);ctx.fill();
      ctx.globalAlpha=1;
    }
  }
}

function drawParticles(){
  for(var i=0;i<particles.length;i++){
    var p=particles[i];
    ctx.globalAlpha=Math.min(1,p.life*3);
    R(wxf(p.x),p.y,p.size,p.size,p.color);
  }
  ctx.globalAlpha=1;
}

function drawScorePopups(){
  ctx.font="bold 8px 'Press Start 2P',monospace";
  ctx.textAlign="center";
  for(var i=0;i<scorePopups.length;i++){
    var pop=scorePopups[i];
    var alpha=Math.min(1,pop.timer*2);
    ctx.globalAlpha=alpha;
    ctx.fillStyle="#000";
    ctx.fillText(pop.text,wxf(pop.x)+1,pop.y+1);
    ctx.fillStyle=pop.color;
    ctx.fillText(pop.text,wxf(pop.x),pop.y);
  }
  ctx.globalAlpha=1;
  ctx.textAlign="left";
}

function draw(){
  ctx.save();
  if(shakeTimer>0) ctx.translate(F((Math.random()-0.5)*4),F((Math.random()-0.5)*4));
  ctx.font="5px monospace";

  drawSky();drawClouds();drawMountains();drawNightDunes();drawCaveBackground();drawParallaxDunes();drawGround();drawTerrainDunes();drawGlowDomes();drawProps();
  drawPlatforms();drawHeartPickups();drawPowerCells();drawInvincPickups();
  drawSandworms();drawEnemies();drawFliers();drawDroids();
  drawProjectiles();drawDrops();drawLasers();
  drawBigworms();drawDaggers();drawSpiders();drawGooDrops();
  if(level===3) drawTorches();
  drawBossArenaWalls();drawBoss();drawBossProjectiles();drawPlayerLasers();
  drawRobot();drawParticles();drawScorePopups();
  drawCaveOverlay();

  // Stomp flash
  if(stompFlash>0){
    ctx.globalAlpha=stompFlash*1.5;
    ctx.fillStyle="#ffffff";
    ctx.fillRect(0,0,W,H);
    ctx.globalAlpha=1;
  }

  // Pit fall effect (Level 3 transition) - scrolling rocky shaft
  if(pitFallTimer>0){
    var fallProgress=1-pitFallTimer/LEVEL_3_TRANSITION_TIME;
    // Dark shaft background
    ctx.fillStyle="#0a0604";
    ctx.fillRect(0,0,W,H);
    // Scrolling rocky walls on left and right
    var scrollY=pitFallScroll;
    ctx.fillStyle="#1a1008";
    for(var wy=0;wy<H+40;wy+=20){
      var ypos=((wy+scrollY)%H)-20;
      // Left wall rocks
      var lw=15+Math.sin(wy*0.3)*8+Math.cos(wy*0.17)*5;
      ctx.beginPath();
      ctx.moveTo(0,ypos);
      ctx.lineTo(lw+Math.sin(wy*0.5)*4,ypos+5);
      ctx.lineTo(lw+2+Math.cos(wy*0.4)*3,ypos+10);
      ctx.lineTo(lw-2+Math.sin(wy*0.6)*5,ypos+15);
      ctx.lineTo(lw+Math.cos(wy*0.3)*4,ypos+20);
      ctx.lineTo(0,ypos+20);
      ctx.fill();
      // Right wall rocks
      var rw=15+Math.cos(wy*0.25)*8+Math.sin(wy*0.19)*5;
      ctx.beginPath();
      ctx.moveTo(W,ypos);
      ctx.lineTo(W-rw-Math.cos(wy*0.45)*4,ypos+5);
      ctx.lineTo(W-rw-2-Math.sin(wy*0.35)*3,ypos+10);
      ctx.lineTo(W-rw+2-Math.cos(wy*0.55)*5,ypos+15);
      ctx.lineTo(W-rw-Math.sin(wy*0.28)*4,ypos+20);
      ctx.lineTo(W,ypos+20);
      ctx.fill();
    }
    // Darker rock edges
    ctx.fillStyle="#0d0805";
    for(var wy=0;wy<H+40;wy+=20){
      var ypos=((wy+scrollY)%H)-20;
      var lw=12+Math.sin(wy*0.3)*6;
      R(0,ypos,lw,20,"#0d0805");
      var rw=12+Math.cos(wy*0.25)*6;
      R(W-rw,ypos,rw,20,"#0d0805");
    }
    // Falling rocks/debris particles
    ctx.fillStyle="#3a2a18";
    for(var ri=0;ri<15;ri++){
      var seed=ri*127+17;
      var rx=20+((seed*13)%((W-40)));
      var ry=((scrollY*1.5+seed*37)%(H+20))-10;
      var rs=2+((seed*7)%3);
      R(rx,ry,rs,rs,"#3a2a18");
    }
    // Cave floor appearing at the bottom near end of fall
    var groundY=H+20;
    if(fallProgress>0.7){
      var groundProgress=(fallProgress-0.7)/0.3;
      groundY=H-(groundProgress*50);
      // Draw cave floor
      R(0,groundY,W,60,"#2a1a10");
      R(0,groundY,W,4,"#3a2818");
      // Floor texture
      for(var fx=0;fx<W;fx+=12){
        var fh=2+((fx*37)%4);
        R(fx,groundY+4,8,fh,"#1a0c06");
      }
    }
    // Blue player droid falling - starts at top, lands on ground
    var bx=W/2;
    var by;
    var legKick,armWave;
    var landed=false;
    if(fallProgress<0.75){
      // Falling phase - robot at center with bobbing
      by=H*0.4+Math.sin(fallProgress*8)*8;
      legKick=Math.sin(fallProgress*14)*3;
      armWave=Math.sin(fallProgress*18)*3;
    } else {
      // Landing phase - robot moves down to ground
      var landProgress=(fallProgress-0.75)/0.25;
      var targetY=groundY-20;
      by=H*0.4+(targetY-H*0.4)*landProgress;
      // Reduce flailing as landing
      legKick=Math.sin(fallProgress*14)*3*(1-landProgress);
      armWave=Math.sin(fallProgress*18)*3*(1-landProgress);
      if(landProgress>0.9) landed=true;
    }
    // Shadow below robot (stronger when near ground)
    var shadowAlpha=fallProgress>0.7?0.3+((fallProgress-0.7)/0.3)*0.3:0.2;
    ctx.globalAlpha=shadowAlpha;ctx.fillStyle="#000";
    ctx.beginPath();ctx.ellipse(bx,landed?groundY:by+20,8,3,0,0,6.29);ctx.fill();
    ctx.globalAlpha=1;
    // Head
    R(bx-6,by-17,12,7,C_ROBOT_DARK);R(bx-5,by-16,10,5,C_ROBOT_BODY);
    R(bx-5,by-17,10,1,C_ROBOT_LIGHT);
    R(bx-7,by-15,2,4,"#555");R(bx+5,by-15,2,4,"#555");
    // Visor (facing right during fall)
    R(bx,by-15,5,3,C_VISOR_DIM);R(bx+1,by-14,4,2,C_VISOR);R(bx+2,by-14,2,1,C_VISOR_HI);
    ctx.globalAlpha=0.08;R(bx+1,by-16,6,5,C_VISOR);ctx.globalAlpha=1;
    // Body
    R(bx-5,by-10,10,7,C_ROBOT_DARK);R(bx-4,by-9,8,5,C_ROBOT_BODY);
    R(bx-3,by-8,6,3,C_ROBOT_LIGHT);
    R(bx-4,by-4,8,1,"#555");R(bx-2,by-4,1,1,"#ffcc44");
    // Shoulders
    R(bx-8,by-11,3,3,C_SHOULDER);R(bx+5,by-11,3,3,C_SHOULDER);
    // Arms (flailing, less when landing)
    R(bx-8,by-8+armWave,2,6,C_ROBOT_DARK);R(bx-8,by-8+armWave,2,2,C_ROBOT_BODY);
    R(bx+6,by-8-armWave,2,6,C_ROBOT_DARK);R(bx+6,by-8-armWave,2,2,C_ROBOT_BODY);
    // Legs (kicking, less when landing)
    R(bx-4,by-3+legKick,3,5,C_ROBOT_DARK);R(bx+1,by-3-legKick,3,5,C_ROBOT_DARK);
    R(bx-5,by+2+legKick,5,1,"#555");R(bx+1,by+2-legKick,5,1,"#555");
    // Antenna
    R(bx+2,by-18,1,2,C_ROBOT_LIGHT);R(bx+2,by-19,1,1,C_VISOR);
    // Landing dust effect
    if(landed){
      ctx.globalAlpha=0.4;ctx.fillStyle="#aa8866";
      for(var di=0;di<8;di++){
        var dx=bx-15+di*4+Math.sin(di*2)*3;
        var dy=groundY-2-Math.random()*4;
        R(dx,dy,3,2,"#aa8866");
      }
      ctx.globalAlpha=1;
    }
    // Vignette darkness at edges
    var grad=ctx.createRadialGradient(W/2,H/2,30,W/2,H/2,H*0.7);
    grad.addColorStop(0,"rgba(0,0,0,0)");
    grad.addColorStop(1,"rgba(0,0,0,0.6)");
    ctx.fillStyle=grad;
    ctx.fillRect(0,0,W,H);
  }

  // Level transition banner
  if(levelTransitionTimer>0){
    var bannerAlpha=Math.min(1,levelTransitionTimer*2);
    ctx.globalAlpha=bannerAlpha*0.7;
    ctx.fillStyle="#000";
    ctx.fillRect(0,H/2-20,W,40);
    ctx.globalAlpha=bannerAlpha;
    ctx.font="bold 12px monospace";
    ctx.textAlign="center";
    if(level===2){
      ctx.fillStyle="#cc88ff";
      ctx.fillText("LEVEL 2",W/2,H/2-4);
      ctx.fillStyle="#9966cc";
      ctx.font="8px monospace";
      ctx.fillText("NIGHT DESERT",W/2,H/2+10);
    } else if(level===3){
      ctx.fillStyle="#ff8844";
      ctx.fillText("LEVEL 3",W/2,H/2-4);
      ctx.fillStyle="#aa6633";
      ctx.font="8px monospace";
      ctx.fillText("SAND CAVE - ENDLESS",W/2,H/2+10);
    }
    ctx.textAlign="left";
    ctx.globalAlpha=1;
  }

  // FREQ MODE ACTIVATED message
  if(freqModeTimer>0){
    var msgAlpha=Math.min(1,freqModeTimer*2);
    ctx.globalAlpha=msgAlpha;
    ctx.font="bold 10px 'Press Start 2P',monospace";
    ctx.textAlign="center";
    ctx.fillStyle="#ffcc00";
    ctx.strokeStyle="#000";
    ctx.lineWidth=3;
    ctx.strokeText("FREQ MODE ACTIVATED",W/2,H/2+4);
    ctx.fillText("FREQ MODE ACTIVATED",W/2,H/2+4);
    ctx.textAlign="left";
    ctx.globalAlpha=1;
  }

  ctx.restore();
}

function resize(){
  var isLandscape=window.innerWidth>window.innerHeight;
  var scale;
  if(isMobile&&isLandscape){
    // Mobile landscape: fit height fully, allow width to extend
    scale=window.innerHeight/H;
  } else {
    scale=Math.min(window.innerWidth/W,window.innerHeight/H);
  }
  var sw=F(W*scale),sh=F(H*scale);
  canvas.style.width=sw+"px";canvas.style.height=sh+"px";
  wrap.style.width=sw+"px";wrap.style.height=sh+"px";
}
window.addEventListener("resize",resize);resize();

function loop(ts){
  requestAnimationFrame(loop);
  if(!lastTime) lastTime=ts;
  var dt=Math.min((ts-lastTime)/1000,0.05);
  lastTime=ts;
  try{
    // Failsafe: if playing and no lives, force game over
    if(state==="playing"&&player.lives<=0){gameOver();}
    update(dt);draw();
  }catch(e){
    console.error("Game error:",e);
    if(state==="playing"){gameOver();}
  }
}

initWorld();showScreen("title");requestAnimationFrame(loop);
})();
</script>
</body>
</html>
